async function carregaConfig(){return new Promise((e,a)=>{$.ajax({url:base_url+"json/config_js",type:"GET",async:!0,success:a=>{e(a)},error:e=>{a(e)}})})}function checkExpo(){$(".chkExpo").on("click",function(e){$(this).is(":checked")?cont_imp++:cont_imp--,cont_imp>0?$("#contImp").text(cont_imp):$("#contImp").text(""),chamados_expo.push($(this).attr("value"))})}function getCookie(e){let a=e+"=",t=decodeURIComponent(document.cookie),o=t.split(";");for(let e=0;e<o.length;e++){let t=o[e];for(;" "==t.charAt(0);)t=t.substring(1);if(0==t.indexOf(a))return t.substring(a.length,t.length)}return""}function painel(e){table_painel=$("#tblPainel").DataTable({autoWidth:!0,pageLength:25,stateSave:!0,lengthMenu:[[15,25,50,100,200],[15,25,50,100,200]],columnDefs:[{targets:1,render:function(e,a,t,o){var i;switch(e){case"1":i='<span style="font-size: 0.5px; color: white">1 - PRIOR</span> <span class="text-warning"><i class="fas fa-star"></i></span>';break;case"ABERTO":i='<span style="font-size: 0.5px; color: white">2 - ABERTO</span> <span class="text-warning"><i class="fas fa-circle"></i></span>';break;case"FECHADO":i='<span style="font-size: 0.5px; color: white">3 - FECHADO</span> <span class="text-success"><i class="fas fa-circle"></i></span>'}return i}},{targets:[1,7,9],className:"text-center"},{orderable:!1,targets:[7,10]},{render:$.fn.dataTable.render.moment("YYYY-MM-DD HH:mm:ss","DD/MM/YYYY"),targets:8},{visible:!1,targets:[9]}],language:{decimal:"",emptyTable:"Sem chamados :)",info:"Mostrando _START_ a _END_ de _TOTAL_ chamados",infoEmpty:"Mostrando 0 a 0 de 0 chamados",infoFiltered:"(filtrado de _MAX_ chamados)",infoPostFix:"",thousands:".",lengthMenu:"Mostrando _MENU_ chamados",loadingRecords:"Carregando...",processing:"Processando...",search:"Busca:",zeroRecords:"Sem resultados!",paginate:{first:"Primeiro",last:"Último",next:"Próximo",previous:"Anterior"}},ajax:base_url+"chamado/listar_chamados_painel/"+e,order:[[1,"asc"],[9,"desc"]],processing:!0,initComplete:checkExpo(),drawCallback:function(e){checkExpo();var a=this.api(),t=""===getCookie("fila_painel")?g_fila_painel:getCookie("fila_painel");$("label[data-fila] span").remove(),$("label[data-fila="+t+"]").append('<span class="badge badge-light">'+a.rows().count()+"</span>")}})}function mudaFila(e){document.cookie="fila_painel="+e,$("#tblPainel").DataTable().ajax.url(base_url+"chamado/listar_chamados_painel/"+e).load()}function resetPainelChamados(){$("#tblPainel").DataTable().state.clear(),$("#tblPainel").empty(),$("#tblPainel").DataTable().destroy(),document.location.reload(!0)}function painelEncerrados(){table_encerrados=$("#tblEncerrados").DataTable({pageLength:25,autoWidth:!0,language:{decimal:"",emptyTable:"Sem resultados.",info:"Mostrando _START_ a _END_ de _TOTAL_ chamados",infoEmpty:"Mostrando 0 a 0 de 0 chamados",infoFiltered:"(filtrado de _MAX_ chamados)",infoPostFix:"",thousands:".",lengthMenu:"Mostrando _MENU_ chamados",loadingRecords:"Carregando...",processing:"Processando...",search:"Busca:",zeroRecords:"Sem resultados!",paginate:{first:"Primeiro",last:"Último",next:"Próximo",previous:"Anterior"}},ajax:base_url+"chamado/listar_encerrados_painel/",order:[],processing:!0,columnDefs:[{render:$.fn.dataTable.render.moment("YYYY-MM-DD HH:mm:ss","DD/MM/YYYY - HH:mm:ss"),targets:[4,5]}]})}function triagem(){table_triagem=$("#tblTriagem").DataTable({autoWidth:!1,pageLength:50,columnDefs:[{width:"10%",targets:2,render:$.fn.dataTable.render.moment("YYYY-MM-DD HH:mm:ss","DD/MM/YYYY H:mm:ss")},{visible:!1,targets:0}],language:{decimal:"",emptyTable:"Sem chamados :)",info:"Mostrando _START_ a _END_ de _TOTAL_ chamados",infoEmpty:"Mostrando 0 a 0 de 0 chamados",infoFiltered:"(filtrado de _MAX_ chamados)",infoPostFix:"",thousands:".",lengthMenu:"Mostrando _MENU_ chamados",loadingRecords:"Carregando...",processing:"Processando...",search:"Busca:",zeroRecords:"Sem resultados!",paginate:{first:"Primeiro",last:"Último",next:"Próximo",previous:"Anterior"}},ajax:base_url+"triagem/listar_triagem/",order:[]})}async function buscaEquipamentos(e,a,t,o=!1,i=!1,r=!1){var n=[];$("#btnRegistrarInteracao").removeAttr("disabled"),await $.ajax({url:base_url+"json/equipamentos_pendentes",data:{id_chamado:e,espera:i},type:"POST",async:!0,dataType:"json",success:function(e){e.filas.forEach(function(o){$("select[name=id_fila]").append('<option value="'+o.id_fila+'" >'+o.nome_fila+"</option>"),1==t?$("option[value="+e.id_fila+"]").prop("selected","true"):$("#slctFila option[value="+a+"]").remove()}),null!=e.equipamentos&&e.equipamentos.forEach(function(e){n.push(e.num_equipamento_chamado)})}}),$("#divEquipamentos").empty(),n.length>0?(n.sort(),1==t?($("#divEquipamentos").prepend("<p>Marque os equipamentos que foram finalizados:</p>"),o||$("#divEquipamentos p").append(" <small><strong>(opcional)</strong></small>")):0==i?$("#divEquipamentos").prepend("<p>Marque os equipamentos que serão deixados em espera:</p>"):$("#divEquipamentos").prepend("<p>Marque os equipamentos que sairão da espera:</p>"),$("#divEquipamentos").append('<input id="chkTudo" type="checkbox" value="#" onclick="$(\'#divEquipamentos input:checkbox\').not(this).prop(\'checked\', this.checked)"><label class="mr-2" for="chkTudo">&nbsp;Todos</label>'),n.forEach(function(e){$("#divEquipamentos").append('<input class="chkPatri" type="checkbox" id="'+e+'" value="'+e+'"><label class="mr-2" for="'+e+'">&nbsp;'+e+"</label>")})):1==i&&($("#divEquipamentos").prepend("<p>Não existem equipamentos em espera!</p>"),r||$("#btnRegistrarInteracao").prop("disabled","true")),$("#divServicos").empty();var s=[];await $.ajax({url:base_url+"listar_servicos_chamado/"+g_id_chamado,type:"GET",async:!0,dataType:"json",success:function(e){s=e}});var d=0;null!=s&&s.length>0&&(s.forEach(function(e){"ABERTO"==e.status_servico&&d++}),d>0&&($("#divServicos").prepend("<p>Marque os serviços que foram finalizados:</p>"),$("#divServicos").append('<input id="chkTudoS" type="checkbox" value="#" onclick="$(\'#divServicos input:checkbox\').not(this).prop(\'checked\', this.checked)"><label class="mr-2" for="chkTudoS">&nbsp;Todos</label>')),s.forEach(function(e){d>0&&"ABERTO"==e.status_servico&&$("#divServicos").append('<input class="chkServ" type="checkbox" id="'+e.id_servico+'" value="'+e.nome_servico+'" id_servico="'+e.id+'"><label class="mr-2" for="'+e.id_servico+'">&nbsp; '+e.nome_servico+" ( "+e.quantidade+" "+e.unidade_medida+" ) </label>")}))}function verificaTipo(e,a){switch($("select[name=id_fila]").empty(),$("#slctTipo").val()){case"ATENDIMENTO":buscaEquipamentos(a,e,!0,!1,!1),$("#divEquipamentos").hide(),$("#divServicos").show(),$("#divFila").show(),$("#slctFila").attr("disabled",!0),$("#divMensagem").show(),listaModelosMensagems($("#slctTipo").val(),e);break;case"ALT_FILA":buscaEquipamentos(a,e,!1,!1,!1,!0),$("#divFila").show(),$("#divEquipamentos").hide(),$("#divServicos").hide(),$("#slctFila").attr("disabled",!1),$("#divMensagem").show(),listaModelosMensagems($("#slctTipo").val(),e);break;case"OBSERVACAO":$("#divEquipamentos").hide(),$("#divServicos").hide(),$("#divFila").hide(),$("#slctFila").attr("disabled",!0),$("#btnRegistrarInteracao").removeAttr("disabled"),$("#divMensagem").show(),listaModelosMensagems($("#slctTipo").val(),e);break;case"ESPERA":buscaEquipamentos(a,e,!1),$("#divEquipamentos").show(),$("#divServicos").hide(),$("#divFila").hide(),$("#slctFila").attr("disabled",!0),$("#divMensagem").show(),listaModelosMensagems($("#slctTipo").val(),e);break;case"REM_ESPERA":buscaEquipamentos(a,e,!1,!1,!0,!1),$("#divServicos").hide(),$("#divEquipamentos").show(),$("#divFila").hide(),$("#slctFila").attr("disabled",!0),$("#divMensagem").show(),listaModelosMensagems($("#slctTipo").val(),e)}(g_fila_chamado<5||g_fila_chamado>7)&&$("#slctTipo option[value='ATENDIMENTO']").remove()}function exibeModeloMensagem(){var e="<p>"+$("#slctModeloMensagem option:selected").text()+"</p>";$("textarea[name=txtInteracao]").summernote("code",e)}async function listaModelosMensagems(e,a){let t=await carregaModeloMensagem(e,a);$("#slctModeloMensagem").empty(),$("textarea[name=txtInteracao]").summernote("code",texto_interacao),null===t?($("#slctModeloMensagem").prop("disabled",!0),$("#slctModeloMensagem").append("<option disabled selected>Não possui nenhuma mensagem :(</option>")):($("#slctModeloMensagem").removeAttr("disabled"),$("#slctModeloMensagem").append("<option disabled selected>Selecione a mensagem</option>"),t.forEach(e=>{$("#slctModeloMensagem").append('<option value="MENSAGEM">'+e.mensagem_modelo_mensagem+"</option>")}))}async function carregaModeloMensagem(e,a){let t=null;return await $.ajax({url:base_url+`ModeloMensagem/listar_modelo_mensagem?tipo=${e}&id_fila=${a}`,type:"GET",success:function(e){t=e}}),t}async function carregaFilas(){var e=null;return await $.ajax({url:base_url+"fila/listar_filas",type:"GET",success:function(a){e=a}}),e}async function carregaSecretarias(){var e=null;return await $.ajax({url:base_url+"secretaria/listar_secretarias/",type:"GET",success:function(a){e=a}}),e}function criaFormRegistro(e,a){var t='<div class="row"><div class="col"><label for="tipo">Tipo</label><select class="form-control" name="tipo" id="slctTipo" onchange="verificaTipo('+a+","+e+')"></select></div></div><div class="row" id="divFila"><div class="col"><label for="id_fila">Fila</label><select class="form-control" name="id_fila" id="slctFila"></select></div></div><div class="row" id="divMensagem"><div class="col"><label for="id_mensagem">Mensagem</label><select class="form-control" name="id_mensagem" id="slctModeloMensagem" onchange="exibeModeloMensagem()"></select></div></div><div class="row mt-3"><div class="col"><div id="divEquipamentos"></div></div></div><div class="row mb-3"><div class="col"><div id="divServicos"></div></div></div><div class="row mb-3"><div class="col"><textarea name="txtInteracao"></textarea></div></div><input type="hidden" name="id_chamado" value="'+e+'"/><input type="hidden" name="id_fila_ant" value="'+a+'"/>';return t}async function carregaHistorico(e){var a=null;return await $.ajax({url:base_url+"chamado/historico/"+e,type:"GET",success:function(e){a=e}}),a}async function carregaChamado(e,a){async function t(){let e="";await $.ajax({url:base_url+"listar_servicos/"+g_fila_chamado,type:"GET",success:function(a){null!==a&&(e=a)},error:function(){console.error("houve um erro")}}),o=e}$("#tblEquipamentosChamado").jsGrid({height:"auto",width:"100%",inserting:!1,editing:!1,autoload:!0,sorting:!0,invalidMessage:"Dados inválidos inseridos!",loadMessage:"Aguarde...",deleteConfirm:"Tem certeza?",noDataContent:"Vazio",onInit:function(e){tblEquipsChamado=e.grid},onItemUpdating:function(e){item_antigo=null,item_antigo=e.previousItem},rowClick:function(){},fields:[{name:"num_equipamento",title:"Núm. de identificação",type:"text",readOnly:!0,validate:["required",{validator:"pattern",param:/^[a-zA-Z0-9]+$/,message:"Atenção!\nCaracteres permitidos:\nA-Z, a-z e 0-9"}]},{name:"descricao_equipamento",type:"text",readOnly:!0,title:"Descrição",validate:["required",{validator:"pattern",param:/^[a-zA-Z0-9\s]+$/,message:"Atenção!\nCaracteres permitidos:\nA-Z, a-z e 0-1"}]},{name:"tag_equipamento",type:"text",align:"center",readOnly:!0,inserting:!1,editing:!1,title:"Lacre"},{name:"status_equipamento_chamado",title:"Status",width:50,align:"center"},{title:"",width:110,align:"center",readOnly:!0,editing:!1,inserting:!1,itemTemplate:function(e,a){return botoes_chamado_equipamento=`<button type="button" class="btn btn-primary btn-sm mr-2" id="bnt-ficha-${a.num_equipamento}" title="Imprimir ficha do equipamento ${a.num_equipamento}" disabled><i class="fas fa-print"></i></button>`,botoes_chamado_equipamento+=`<a class="btn btn-primary btn-sm" href="${base_url}equipamento/${a.num_equipamento}" target="_BLANK" role="button" title="Ver informações do equipamento ${a.num_equipamento}"><i class="fas fa-search"></i></a>`,botoes_chamado_equipamento},editTemplate:function(e){return botoes_chamado_equipamento}},{type:"control",editButton:!1,deleteButton:!1}],rowClass:function(e){return"ABERTO"==e.status_equipamento_chamado||"REPARO"==e.status_equipamento_chamado||"GARANTIA"==e.status_equipamento_chamado?"bg-warning":""},controller:{loadData:function(){return $.ajax({url:base_url+"listar_equips_chamado/"+g_id_chamado,dataType:"json",method:"get"})},updateItem:async function(a){var t=$.Deferred(),o=null,i=a.num_equipamento.replace(/\s+/g,"");if(console.error(i),o=await verificaStatusEquip(i),null!==o)return"ABERTO"!==o.status_equipamento_chamado&&"ENTREGA"!==o.status_equipamento_chamado&&"ESPERA"!==o.status_equipamento_chamado&&"INSERVIVEL"!==o.status_equipamento_chamado&&"REMESSA"!==o.status_equipamento_chamado&&"GARANTIA"!==o.status_equipamento_chamado&&"REPARO"!==o.status_equipamento_chamado||parseInt(o.id_chamado)===g_id_chamado?$.ajax({url:base_url+"edit_equip_chamado",dataType:"json",method:"post",data:{item:a,g_id_chamado:g_id_chamado,item_antigo:item_antigo},success:async function(){var a=await carregaHistorico(e);$("#historico").html(a),carregaChamado(e)}}):(alert("O item "+i+" já está em atendimento ou foi classificado como inservível!\nChamado: "+o.id_chamado+"\n"+o.ticket_chamado),t.reject(),t.promise())},insertItem:async function(a){var t=$.Deferred(),o=null,i=a.num_equipamento.replace(/\s+/g,"");if(o=await verificaStatusEquip(i),null===o)return $.ajax({url:base_url+"add_equip_chamado",dataType:"json",method:"post",data:{item:a,g_id_chamado:g_id_chamado},success:async function(){var a=await carregaHistorico(e);$("#historico").html(a),carregaChamado(e)}});{let r=Swal.mixin({icon:"error",title:'Falha ao inserir equipamento ao chamado<hr style="margin-bottom: -5px;">',footer:`${o.ticket_chamado}<br>Chamado: <a href="${base_url}chamado/${o.id_chamado}" target="_BLANK">${o.id_chamado}</a>`,toast:!0,position:"top-end",showConfirmButton:!1,timer:3e3,timerProgressBar:!0,didOpen:e=>{e.onmouseenter=Swal.stopTimer,e.onmouseleave=Swal.resumeTimer}});switch(o.status_equipamento_chamado){case"ABERTO":r.fire({text:`O equipamento ${i} já está em atendimento!`}),t.reject();break;case"ESPERA":r.fire({text:`O equipamento ${i}  está em espera!`}),t.reject();break;case"FALHA":r.fire({text:`O equipamento  ${i} está em estado de falha!`}),t.reject();break;case"INSERVIVEL":r.fire({text:`O equipamento ${i} está inservivel!`}),t.reject();break;case"REPARO":r.fire({text:`O equipamento ${i} está em reparo!`}),t.reject();break;case"ENTREGA":r.fire({text:`O equipamento ${i} está para entrega!`}),t.reject();break;case"REMESSA":r.fire({text:`O equipamento ${i} está em remessa!`}),t.reject();break;default:$.ajax({url:base_url+"add_equip_chamado",dataType:"json",method:"post",data:{item:a,g_id_chamado:g_id_chamado},success:async function(){var a=await carregaHistorico(e);$("#historico").html(a),carregaChamado(e)}})}}return t.promise()},deleteItem:async function(a){var t=$.Deferred(),o=null,i=a.num_equipamento.replace(/\s+/g,"");return o=await verificaStatusEquip(i),"ABERTO"===o.status_equipamento_chamado?$.ajax({url:base_url+"del_equip_chamado",dataType:"json",method:"post",data:{item:a,g_id_chamado:g_id_chamado},success:async function(){var a=await carregaHistorico(e);$("#historico").html(a),carregaChamado(e)}}):(alert("Operação não permitida!\nO item "+i+" já foi alterado neste chamado!"),t.reject(),t.promise())}}});var o=null;await t();var i=[];$("#tblServicosInfraChamado").jsGrid({height:"auto",width:"100%",inserting:!1,editing:!1,autoload:!0,sorting:!0,invalidMessage:"Dados inválidos inseridos!",loadMessage:"Aguarde...",deleteConfirm:"Tem certeza?",noDataContent:"Vazio",onInit:function(e){tblServicosInfraChamado=e.grid},onItemUpdating:function(e){item_antigo=null,item_antigo=e.previousItem,e.item.quantidade<1&&(alert("O campo quantidade deve ser preenchido com um valor acima de zero!"),e.cancel=!0)},onItemInserting:function(e){e.item.quantidade<1&&(alert("O campo quantidade deve ser preenchido com um valor acima de zero!"),e.cancel=!0)},fields:[{name:"id_servico",title:"Nome do Serviço",type:"select",align:"center",autosearch:!0,items:o,valueField:"id_servico",textField:"nome_servico",selectedIndex:-1,valueType:"number",readOnly:!1,editing:!1},{name:"quantidade",title:"Quantidade",width:20,type:"text",insertTemplate:function(){let e=this.__proto__.insertTemplate.call(this);return e.val(0),e},validate:["required",{validator:"pattern",param:/^[0-9]+$/,message:"Atenção!\nEste campo aceita apenas números."}],align:"center",readOnly:!1},{name:"unidade_medida",title:"Unidade de medida",width:20,align:"center",readOnly:!0},{name:"status_servico",title:"Status",width:50,align:"center",readOnly:!0},{type:"control",editButton:!1,deleteButton:!1}],rowClass:function(e){return i.push(e),"ABERTO"==e.status_servico?"bg-warning":""},controller:{loadData:function(){return $.ajax({url:base_url+"listar_servicos_chamado/"+g_id_chamado,dataType:"json",method:"post"})},insertItem:function(a){let t=$.Deferred(),r=null;for(a.status_servico="ABERTO",a.id_servico=a.id_servico.toString(),c=0;c<o.length;c++)a.id_servico==o[c].id_servico&&(a.nome_servico=o[c].nome_servico);for(c=0;c<i.length;c++)i[c].id_servico==a.id_servico&&"ABERTO"==i[c].status_servico&&(r=i[c].nome_servico);if(null!=r)return alert("O serviço "+r+" já foi adicionado e está como o status ABERTO."),t.reject(),t.promise();$.ajax({url:base_url+"listar_servicos_chamado/"+g_id_chamado,dataType:"json",method:"post",data:{item:a},success:function(){carregaChamado(e)},error:function(){alert("Erro ao adicionar o serviço")}})},deleteItem:function(a){let t=$.Deferred();if("FECHADO"==a.status_servico)return alert("Este serviço está fechado e não pode ser excluido."),t.reject(),t.promise();$.ajax({url:base_url+"excluir_servico/"+g_id_chamado,dataType:"json",method:"post",data:{item:a,g_id_chamado:g_id_chamado},success:function(){carregaChamado(e)},error:function(){alert("Erro ao excluir o serviço")}})},updateItem:function(a){let t=a.quantidade;if(t>0)return $.ajax({url:base_url+"atualizar_servicos_chamado/"+g_id_chamado,dataType:"json",method:"post",data:{item:a},success:function(){carregaChamado(e)},error:function(){alert("Erro ao excluir o serviço")}})}}}),document.title="Chamado #"+e+" - SIGAT",p_id_responsavel=null,$("#spnStatusChamado").fadeIn();var r=await carregaHistorico(e);$("#historico").html(r),$("#botoesAtendimento").html(""),$("#botoesAtendimentoReparo").html(""),$("#btnBloquearChamado").removeAttr("disabled"),$("#modalReparo").find("modal-footer").hide(),botoes="",$("#botoesChamado hr").hide();var n=[],s=[];let d=null;await $.ajax({url:base_url+"json/chamado",dataType:"json",async:!0,data:{id_chamado:e},error:function(e,a,t){console.error(a)},success:function(a){g_fila_chamado=parseInt(a.id_fila),$("input[name=fila]").val(a.nome_fila_chamado),$("input[name=resumo]").val(a.resumo_chamado),$("input[name=complemento]").val(a.complemento_chamado),$("input[name=data_chamado]").val(a.data_chamado),$("input[name=status]").val(a.status_chamado),$("input[name=nome_solicitante]").val(a.nome_solicitante_chamado),$("input[name=celular]").val(a.celular_chamado),$("input[name=telefone]").val(a.telefone_chamado),$("input[name=nome_local]").val(a.nome_local),$("input[name=id_fila_ant]").val(a.id_fila);var t=null;t=a.telefone_chamado.length>4?"0"+a.telefone_chamado:a.telefone_chamado,$("#sipLink").attr("href","sip:"+t),$("#btnVerEndereco").attr("data-chamado",e),null==a.id_responsavel?$("select[name=id_responsavel]").empty():(p_id_responsavel=a.id_responsavel,$("select[name=id_responsavel]").html('<option value="'+a.id_responsavel+'">'+a.nome_responsavel+"</option>")),fila_atual=a.id_fila,entrega=a.entrega_chamado,status_chamado=a.status_chamado;for(var o=0;o<a.status_equipamentos.length;++o)n.push(a.status_equipamentos[o].status_equipamento_chamado);for(o=0;o<a.status_equipamentos.length;o++)"REMESSA"==a.status_equipamentos[o].status_equipamento_chamado&&(d=!0);for(o=0;o<a.status_servicos.length;++o)s.push(a.status_servicos[o].status_servico_chamado);a.id_responsavel==g_id_usuario&&(tblEquipsChamado.option("editing",!0),tblEquipsChamado.option("inserting",!0),5!=g_fila_chamado&&6!=g_fila_chamado&&7!=g_fila_chamado||(tblServicosInfraChamado.option("inserting",!0),tblServicosInfraChamado.option("editing",!0),tblServicosInfraChamado.fieldOption(4,"deleteButton",!0),tblServicosInfraChamado.fieldOption(4,"editButton",!0)),tblEquipsChamado.fieldOption(5,"editButton",!0),tblEquipsChamado.fieldOption(5,"deleteButton",!0),tblEquipsChamado.fieldOption(1,"readOnly",!1),tblEquipsChamado.fieldOption(0,"readOnly",!1),tblEquipsChamado.fieldOption(0,"editing",!1),tblEquipsChamado.fieldOption(0,"inserting",!0),3==a.id_fila&&tblEquipsChamado.fieldOption(2,"editing",!0),g_auto_usuario>3&&(tblEquipsChamado.fieldOption(1,"readOnly",!1),tblEquipsChamado.fieldOption(4,"deleteButton",!0))),"ABERTO"!=a.status_chamado?($("#btnModalEmail").hide(),$("#btnEditarChamado").hide(),$("#btnDesbloquearChamado").hide(),$("#botoesChamado hr").hide(),tblEquipsChamado.option("editing",!1),tblEquipsChamado.option("inserting",!1),tblEquipsChamado.fieldOption(4,"editButton",!1),tblEquipsChamado.fieldOption(4,"deleteButton",!1),tblEquipsChamado.fieldOption(0,"readOnly",!0),tblEquipsChamado.fieldOption(1,"readOnly",!0),tblEquipsChamado.fieldOption(2,"editing",!1)):((g_auto_usuario>=3&&null!=a.id_responsavel||a.id_responsavel==g_id_usuario)&&($("#btnModalEmail").show(),$("#btnDesbloquearChamado").show(),$("#btnEditarChamado").show(),$("#botoesChamado hr").show()),null==a.id_responsavel&&g_auto_usuario>=3&&($("#btnModalEmail").hide(),$("#btnEditarChamado").show(),$("#btnDesbloquearChamado").hide(),$("#botoesChamado hr").show()),null==a.id_responsavel&&g_auto_usuario<=2&&($("#btnBloquearChamado").show(),$("#btnEditarChamado").hide(),$("#btnDesbloquearChamado").hide(),$("#botoesChamado hr").show(),$("#btnModalEmail").hide()),null==a.id_responsavel&&g_auto_usuario>=3&&($("#btnBloquearChamado").show(),$("#btnEditarChamado").show(),$("#btnDesbloquearChamado").hide(),$("#botoesChamado hr").show(),$("#btnModalEmail").show()),null!=a.id_responsavel&&g_auto_usuario>=3&&($("#btnBloquearChamado").hide(),$("#btnEditarChamado").show(),$("#btnDesbloquearChamado").show(),$("#botoesChamado hr").show(),$("#btnModalEmail").show()),g_id_usuario==a.id_responsavel&&g_auto_usuario<=2&&($("#btnBloquearChamado").hide(),$("#btnEditarChamado").show()))}});var l=null;await $.ajax({method:"POST",url:base_url+"reparo/listar_reparos",data:{id_chamado:g_id_chamado}}).done(e=>{l=e}),l.length>0&&($("#tblReparosChamado tbody").html(""),l.forEach(e=>{var a=null==e.data_fim_reparo?"":e.data_fim_reparo,t=null;switch(e.status_reparo){case"ABERTO":t="table-warning";break;case"FINALIZADO":t="table-success";break;case"CANCELADO":case"CANCELAMENTO":t="table-secondary";break;case"GARANTIA":t="table-primary";break;case"ESPERA":t="table-danger"}if("FINALIZADO"==e.status_reparo)for(c=0;c<e.servicos.length;c++)1==e.servicos[c].realizado_reparo_servico&&1==e.servicos[c].subquery&&(e.status_reparo+="<br/> <small>"+e.servicos[c].nome_servico+"</small>");$("#tblReparosChamado tbody").append(`<tr class=${t}>\n                    <td>${e.num_equipamento_reparo}</td>\n                    <td>${"GARANTIA"==e.status_reparo||"ESPERA"==e.status_reparo?"-":e.nome_bancada}</td>\n                    <td>${e.status_reparo}</td>\n                    <td>${e.data_inicio_reparo}</td>\n                    <td>${a}</td>\n                    <td>\n                        <button type="button" class="btn btn-primary btn-modal-reparo" \n                            data-toggle="modal" data-reparo="${e.id_reparo}" \n                            data-target="#modalReparo">\n                            <i class="fas fa-search"></i>\n                        </button>\n                    </td>\n                </tr>`)})),g_auto_usuario>=3&&1==g_auto_usuario_enc&&"FECHADO"==status_chamado&&(botoes='<button id="btnEncerrarChamado" onclick="encerrarChamado()" class="btn btn-success"><i class="far fa-check-circle"></i> Encerrar chamado</button>'),g_auto_usuario>=3&&1==g_auto_usuario_enc&&"ENCERRADO"==status_chamado&&(botoes='<button id="btnReabrirChamado" class="btn btn-primary" onclick="reabrirChamado()"><i class="fas fa-lock-open"></i> Reabrir chamado</button>');for(var c=0;c<n.length;++c)if(p_id_responsavel==g_id_usuario&&("ABERTO"==n[c]||"ESPERA"==n[c]||"FALHA"==n[c]||"ENTREGA"==n[c]||"REPARO"==n[c]||"GARANTIA"==n[c])){botoes='<button type="button" id="btnModalRegistro" class="btn btn-primary" data-toggle="modal" data-target="#modalRegistro" data-chamado="'+g_id_chamado+'"><i class="fas fa-asterisk"></i> Nova Ação</button> ';break}for(c=0;c<s.length;++c)if(p_id_responsavel==g_id_usuario&&("ABERTO"==s[c]||"ESPERA"==s[c]||"FALHA"==s[c]||"ENTREGA"==s[c]||"REPARO"==s[c]||"GARANTIA"==n[c])){botoes='<button type="button" id="btnModalRegistro" class="btn btn-primary" data-toggle="modal" data-target="#modalRegistro" data-chamado="'+g_id_chamado+'"><i class="fas fa-asterisk"></i> Nova Ação</button> ';break}var m=0;for(c=0;c<n.length;++c)"ABERTO"!=n[c]&&"ESPERA"!=n[c]&&"FALHA"!=n[c]&&"ENTREGA"!=n[c]&&"REPARO"!=n[c]&&"GARANTIA"!=n[c]||m++;for(c=0;c<s.length;++c)"ABERTO"!=s[c]&&"ESPERA"!=s[c]&&"FALHA"!=s[c]&&"ENTREGA"!=s[c]&&"REPARO"!=s[c]&&"GARANTIA"!=n[c]||m++;p_id_responsavel==g_id_usuario&&0==m&&"ABERTO"==status_chamado&&(botoes='<button type="button" id="btnFechamentoManual" class="btn btn-primary" onclick="finalizaManual('+e+')"><i class="fas fa-pen-alt"></i> Fechamento manual</button> '),1==entrega&&p_id_responsavel==g_id_usuario&&"ABERTO"==status_chamado&&(botoes+='<button type="button" id="btnModalRegistroEntrega" class="btn btn-success" data-toggle="modal" data-chamado="'+e+'" data-target="#modalRegistroEntrega"><i class="fas fa-file-signature"></i> Registrar Entrega</button> <a href="'+base_url+"chamado/gerar_termo/"+e+'" id="baixarTermoEntrega" role="button" class="btn btn-info"><i class="fas fa-file-download"></i> Termo de Entrega</a> <a href="'+base_url+"chamado/gerar_termo_resp/"+ +e+'" id="baixarTermoResp" role="button" class="btn btn-info"><i class="fas fa-file-download"></i> Termo de Responsabilidade</a>');var u=null;3!=fila_atual&&p_id_responsavel!=g_id_usuario||"ABERTO"!=status_chamado||(u='<button type="button" id="btnModalIniciarReparo" class="btn btn-primary" data-toggle="modal" data-chamado="'+e+'" data-target="#modalIniciarReparo"><i class="fas fa-wrench"></i> Iniciar reparo</button>'),$("#botoesAtendimento").html(botoes),$("#botoesAtendimentoReparo").html(u),$("#spnStatusChamado").fadeOut()}function removerEmail(e,a){Object.values(remetentes).forEach(e=>{const t=e.indexOf(a);-1!==t&&e.splice(t,1)}),$(`#${e}`).remove()}async function ping(e){let a='\n        <div class="d-flex justify-content-center">\n            <div class="spinner-border text-secondary spinner-border-sm" role="status">\n                <span class="sr-only">Carregando...</span>\n            </div>\n        </div>';$(`#bnt-ping-${e}`).prop("disabled","true"),$(`#icon-ping-${e}`).html(a),$.ajax({url:base_url+`Ping/exec_ping?patrimonio=${e}`,type:"GET"}).then(a=>{let t=a.status;!0===t?($(`#icon-ping-${e}`).html(""),$(`#icon-ping-${e}`).html('<i class="fa fa-check" style="color: #11ff00;"></i>')):($(`#icon-ping-${e}`).html(""),$(`#icon-ping-${e}`).html('<i class="fa fa-times" style="color: #ff0000;"></i>')),$(`#bnt-ping-${e}`).removeAttr("disabled","true")}).catch(a=>{alert(a),$(`#icon-ping-${e}`).html('<i class="fa fa-exclamation-triangle" style="color: #ff0000;"></i>')})}function reverterRemessa(e,a,t){$.ajax({url:base_url+"inservivel/reverter_remessa/",type:"POST",async:!0,dataType:"json",data:{equip:e,remessa:a,reparo:t,chamado:g_id_chamado},success:function(e){Swal.fire({title:"Reverter Remessa",text:e.mensagem,icon:e.status}),$("#modalReparo").modal("hide"),carregaChamado(g_id_chamado)},error:function(e){Swal.fire({title:"Reverter Remessa",text:"Erro desfazer a remessa.",icon:"error"})}})}function cancelarEntrega(e,a){$.ajax({url:base_url+"reparo/cancelar_entrega/",type:"POST",async:!0,dataType:"json",data:{equip:e,id_reparo:a,id_chamado:g_id_chamado},success:function(e){Swal.fire({title:"Cancelar Entrega",text:e.mensagem,icon:e.status}),$("#modalReparo").modal("hide"),carregaChamado(g_id_chamado)},error:function(e){Swal.fire({title:"Cancelar Entrega",text:"Erro desfazer a remessa.",icon:"error"})}})}function finalizaManual(e){$.ajax({url:base_url+"chamado/finalizar_manual_chamado",type:"POST",data:{id_chamado:e},beforeSend:function(){$("#btnFechamentoManual").prop("disabled","true")},success:function(){atualizaInteracoes(e),carregaChamado(e)}})}function removeInteracao(e,a){$("#botoesAtendimento").html(""),$.ajax({url:base_url+"interacao/remover_interacao",type:"POST",data:{id_interacao:e,id_chamado:g_id_chamado,id_usuario:g_id_usuario,auto_usuario:g_auto_usuario},beforeSend:function(){$("#btnDesfazer").prop("disabled","true")},success:function(){atualizaInteracoes(a),carregaChamado(a),tblEquipsChamado.loadData()},error:function(){$("#btnDesfazer").removeAttr("disabled"),atualizaInteracoes(a),carregaChamado(a),tblEquipsChamado.loadData(),alert("Operação não permitida!")}})}function atualizaInteracoes(e){$.post(base_url+"json/interacoes",{id:e}).done(function(e){$("#interacoes").html(e)})}function verificaEntrega(){1==$("input[name=confirmaEntrega]:checked").val()?($("#btnRegistrarEntrega").attr("class","btn btn-success"),$("#divEntrega").show(),$("#divFalhaEntrega").hide(),$("#divErroEntrega").hide(),$("#btnRegistrarEntrega").show(),$("#btnRegistrarEntrega span").html(" Registrar Entrega")):($("#divEntrega").hide(),$("#divFalhaEntrega").show(),$("#divErroEntrega").show(),$("#btnRegistrarEntrega").show(),$("#txtFalhaEntrega").summernote({toolbar:[["style",["bold","italic","underline","clear"]],["fontsize",["fontsize"]],["color",["color"]],["para",["ul","ol","paragraph"]],["insert",["link","picture","video"]]],height:150,lang:"pt-BR",dialogsInBody:!0,disableDragAndDrop:!0}),1==$("#slcErroEntrega").val()?($("#btnRegistrarEntrega span").html(" Registrar Falha de Entrega"),$("#btnRegistrarEntrega").attr("class","btn btn-danger")):($("#btnRegistrarEntrega span").html(" Registrar Tentativa de Entrega"),$("#btnRegistrarEntrega").attr("class","btn btn-success"),$("#txtFalhaEntrega").hide()))}function encerrarChamado(){var e=$("#btnEncerrarChamado");g_auto_usuario>=3&&confirm("Deseja realmente encerrar?")&&$.ajax({type:"post",url:base_url+"chamado/encerrar_chamado",data:{id_chamado:g_id_chamado,id_usuario:g_id_usuario},beforeSend:function(){e.prop("disabled","true")},success:function(){atualizaInteracoes(g_id_chamado),carregaChamado(g_id_chamado,!0)},error:function(){e.removeAttr("disabled"),alert("Operação não permitida!")}})}function reabrirChamado(){var e=$("#btnReabrirChamado");g_auto_usuario>=3&&$.ajax({type:"post",url:base_url+"chamado/reabrir_chamado",data:{id_chamado:g_id_chamado,id_usuario:g_id_usuario},beforeSend:function(){e.prop("disabled","true")},success:function(){atualizaInteracoes(g_id_chamado),carregaChamado(g_id_chamado,!0)},error:function(){e.removeAttr("disabled"),alert("Operação não permitida!")}})}function registrarPermissoes(e,a){$.ajax({url:base_url+"usuario/ativar_permissoes",type:"POST",async:!0,data:{id_usuario:a,permissao:e},success:function(a){alert("Permissão de "+e+" alterada")},error:function(e){alert("Erro ao atualizar a permissão do usuário.")}})}async function carregarTodosServicos(){var e=$.Deferred();const a=await $.ajax({url:base_url+"servico/listar_servicos_triagem/",dataType:"json"}).done(function(a){e.resolve(a)});return a}async function carregarBancadas(e=1){let a=[];return await $.ajax({url:base_url+"bancada/lista_bancadas/",type:"POST",async:!0,dataType:"json",data:{status:e},success:function(e){a=e}}),a}async function carregaTriagem(e){document.title="Triagem #"+e+" - SIGAT";var a=[];await $.ajax({url:base_url+"triagem/carregar_anexos_ticket",dataType:"json",async:!0,data:{id_ticket:e},success:function(e){$("#linhaInfoTriagem").show(),
e.length>0&&e.forEach(function(e){a.push({id_arquivo:e.id,nome_arquivo:e.filename})})}}),await $.ajax({url:base_url+"servico/listar_servicos_triagem/1",dataType:"json",async:!0,type:"POST",data:{filas:id_fila_sigat},success:function(e){servicos=e}}),$("#tblServicos").jsGrid({width:"100%",autoload:!1,editing:!0,inserting:!0,noDataContent:"Lista vazia.",confirmDeleting:!1,deleteConfirm:"Tem certeza?",sorting:!0,fields:[{name:"id_servico",title:"Nome do serviço",type:"select",items:servicos,valueField:"id_servico",textField:"nome_servico",visible:!0},{type:"control",deleteButton:!0,editButton:!0,insertButton:!0}],onItemInserting:function(e){var a=e.item.id_servico,t=servicos.find(e=>e.id_servico==a);e.item.grupo_servico=t.grupo_servico,e.item.quantidade=1},onItemInserted:function(e){let a=e.grid.data[e.grid.data.length-1];for(i=0;i<e.grid.data.length-1;i++)e.grid.data[i].id_servico==a.id_servico&&(alert("Este serviço já foi cadastrado"),e.grid.data.pop())},onItemUpdating:function(e){var a=e.item.id_servico,t=servicos.find(e=>e.id_servico==a);e.previousItem.grupo_servico=t.grupo_servico}}),verificaAutoEquip(),$("#tblAnexos").jsGrid("option","data",a)}function uniq_fast(e){for(var a={},t=[],o=e.length,i=0,r=0;r<o;r++){var n=e[r];1!==a[n]&&(a[n]=1,t[i++]=n)}return t}async function verificaStatusEquip(e,a=!1){return out=null,await $.ajax({method:"post",url:base_url+"json/status_equipamento",data:{e_status:e,isArray:a}}).done(function(e){out=e}),out}async function verificaDescEquip(e){return out=null,await $.ajax({method:"post",url:base_url+"json/desc_equipamento/"+e}).done(function(e){""!==e&&(out=e)}),out}async function verificaAutoEquip(){var e=[],a=[],t=[];$("#btnValidaEquip").prop("disabled","true"),$("#pbEquips").css("width","0%");var o=$("#accordionArticles .card .card-body").html();if($("#accordionArticles .card .card-body").each(function(e){o+=$(this).html()}),e=o.match(patrimonio_regex),null!==e){if(e.length>0){for(e=uniq_fast(e),percentage=100/e.length,total_percentage=0,i=0;i<e.length;i++){var r=await verificaStatusEquip(e[i]);null!==r&&("ABERTO"!==r.status_equipamento_chamado&&"ENTREGA"!==r.status_equipamento_chamado&&"ESPERA"!==r.status_equipamento_chamado&&"REPARO"!==r.status_equipamento_chamado&&"REMESSA"!==r.status_equipamento_chamado&&"GARANTIA"!==r.status_equipamento_chamado&&"INSERVIVEL"!==r.status_equipamento_chamado||t.push({"Número":e[i],Status:r.status_equipamento_chamado,ID:r.id_chamado,Ticket:r.ticket_chamado}));var n=await verificaDescEquip(e[i]);a.push({"Número":e[i],"Descrição":n.descricao}),total_percentage+=percentage,$("#pbEquips").css("width",total_percentage+"%")}$("#tblEquips").jsGrid("option","data",a),g_equips=a,$("#btnValidaEquip").removeAttr("disabled"),$("#btnLoteEquip").removeAttr("disabled")}}else $("#btnValidaEquip").removeAttr("disabled"),$("#btnLoteEquip").removeAttr("disabled")}function editarTelefone(e){$("button").attr("disabled","disabled");let a=$("#tel"+e).html(),t=$("#set"+e).html(),o='<button onclick="inserirTelefone('+e+')" type="button" class="btn btn-success mr-2 mb-2"><i class="fas fa-save"></i> Salvar</button>',i='<button id="btnCancelarTel" type="button" class="btn btn-danger mb-2"><i class="fas fa-window-close"></i> Cancelar</button>',r='<button id="btnEditarTel" type="button" class="btn btn-info mr-2 mb-2" onclick="editarTelefone('+e+')"><i class="fas fa-edit"></i> Editar</button>',n='<button type="button" onclick="excluirTelefone('+e+')" class="btn btn-danger mr-2 mb-2"><i class="fas fa-trash"></i> Excluir</button>';$("#tel"+e).html(""),$("#tel"+e).append(`<input onkeyup="handlePhone(event)" class="form-control" name="telefone" id="telEd${e}" type="text" value="${a}" maxlength="15"></input>`),$("#set"+e).html(""),$("#set"+e).append(`<input name="setor" type="text" id="setEd${e}" class="form-control" value="${t}" maxlength="100"></input>`),$("#edit"+e).html(""),$("#edit"+e).append(o),$("#edit"+e).append(i),$("#btnCancelarTel").on("click",function(){$("#tel"+e).html(a),$("#set"+e).html(t),$("#edit"+e).html(""),$("#edit"+e).append(r),$("#edit"+e).append(n),$("button").removeAttr("disabled")})}function excluirTelefone(e){let a="Deseja realmente excluir este telefone?",t=$("#IdLocal").val(),o="excluir",i="z";1==confirm(a)&&$.ajax({url:base_url+"local/"+t,type:"POST",async:!0,data:{telefone:i,acao:o,id:e},success:function(e){location.replace(base_url+"/local/"+t+"?tel=true")},error:function(e){alert("Erro ao inserir ou editar um telefone. ")}})}function inserirTelefone(e=0){$("spam").remove(),$("br").remove();let a='<spam class="text-danger">Este campo é obrigatório</spam><br/>',t='<spam class="text-danger">Este campo deve ter no mínimo 4 caracteres</spam><br/>',o=$("#IdLocal").val(),i="",r="",n="";0==e?(i=$("#telAdd").val(),r=$("#setAdd").val(),n="inserir"):(i=$("#telEd"+e).val(),r=$("#setEd"+e).val(),n="editar");let s=!1;""!=i&&""!=r&&r.length>=4&&i.length>=4?s=!0:(s=!1,""==i&&($("#campoTelAdd").append(a),$("#tel"+e).append(a)),""==r&&($("#campoSetAdd").append(a),$("#set"+e).append(a)),r.length<4&&($("#campoSetAdd").append(t),$("#set"+e).append(t)),i.length<4&&($("#campoTelAdd").append(t),$("#tel"+e).append(t))),1==s&&$.ajax({url:base_url+"local/"+o,type:"POST",async:!0,data:{telefone:i,setor:r,acao:n,id:e},success:function(e){location.replace(base_url+"/local/"+o+"?tel=true")},error:function(e){alert("Erro ao inserir ou editar um telefone. ")}})}async function carregaReparo(e){var a=null;return await $.ajax({url:base_url+"reparo/buscar_reparo",method:"POST",data:{id_reparo:e}}).done(e=>{a=e}),a}async function carregaServicos(e,a){let t=[];return await $.ajax({url:base_url+"reparo/buscar_servicos",method:"POST",data:{id_reparo:e,id_fila:a}}).done(e=>{t=e}),t}async function carregaReparoServicos(e){var a=null;return await $.ajax({url:base_url+"reparo/buscar_reparo_servico",method:"POST",data:{id_reparo:e}}).done(e=>{a=e}),a}function desfazerReparoServico(e,a,t,o){Swal.fire({title:"Tem certeza?",text:"Você não poderá reverter isso!",icon:"warning",showCancelButton:!0,confirmButtonColor:"#3085d6",cancelButtonColor:"#d33",confirmButtonText:"Sim, desfaça o serviço!",cancelButtonText:"Cancelar"}).then(i=>{i.isConfirmed&&o==p_id_reparo&&$.ajax({url:base_url+"reparo/desfazer_reparo_servico",type:"POST",data:{id_reparo:o,id_reparo_servico:e},beforeSend:()=>{$(`input[value="${e}"]`).prop("disabled",!0)}}).done(o=>{Swal.fire({toast:!0,position:"top-end",showConfirmButton:!1,timer:3e3,timerProgressBar:!0,icon:"success",title:o.mensagem,didOpen:e=>{e.onmouseenter=Swal.stopTimer,e.onmouseleave=Swal.resumeTimer}}),$(`#check-servico-${e}`).html(`\n                    <div id="check-servico-${e}">\n                        <input class="form-check-input check-servico" id="checkbox-servico-${e}" type="checkbox" value="${e}" onclick="realizaServico(${e}, '${a}', ${t})">\n                        <label for="check-servico-${e}" class="form-check-label">\n                            ${a}\n                            <span class="badge badge-danger" onclick="cancelaServico(${e}, '${a}', ${t})"><i class="fas fa-times"></i></span>\n                        </label>\n                    </div>\n                `)}).fail(a=>{$(`input[value="${e}"]`).prop("checked",!0),Swal.fire({toast:!0,position:"top-end",showConfirmButton:!1,timer:5e3,timerProgressBar:!0,icon:"error",text:`${a.responseJSON.mensagem}`,didOpen:e=>{e.onmouseenter=Swal.stopTimer,e.onmouseleave=Swal.resumeTimer}}),$(`input[value="${e}"]`).removeAttr("disabled")})})}async function realizaServico(e,a,t){if(!confirm(`Tem certeza que o serviço ${a} foi realizado?`))return $(`#checkbox-servico-${e}`).prop("checked",!1),!1;config.then(async a=>{const o=a;if(t===o.id_servico.lacre){const a=prompt("Digite o lacre do equipamento:");if(!/^[a-zA-Z0-9]+$/.test(a)||null===a)return null!==a?(alert("Dados inválidos inseridos!\nAtenção!\nCaracteres permitidos:\nA-Z, a-z, 0-9"),$(`#checkbox-servico-${e}`).prop("checked",!1),!1):($(`#checkbox-servico-${e}`).prop("checked",!1),!1);{let t=await carregaReparo(p_id_reparo);t=t.reparo.num_equipamento_reparo,$.ajax({url:base_url+"equipamento/controller/registra_lacre",type:"POST",dataType:"json",data:{id_reparo_servico:e,num_equipamento:t,tag_equipamento:a}})}}else t===o.id_servico.CMOS.id_servico&&$(document).ready(function(){$("#modalVerificarBateria").modal({backdrop:"static",keyboard:!1,show:!0}),$("#modalVerificarBateria").find("#btnRegistrarVoltagem").off("click").on("click",function(){$("#btnRegistrarVoltagem").prop("disabled",!0);var a=null,t="";const i=2.7;let r=$("#input-voltagem").val();r<i?($("#is-notebook-allinone").is(":checked")?(a=o.id_servico.CMOS.troca_notebook.id_servico,t=o.id_servico.CMOS.troca_notebook.nome_servico):(a=o.id_servico.CMOS.troca_desktop.id_servico,t=o.id_servico.CMOS.troca_desktop.nome_servico),$.ajax({url:base_url+"reparo/adicionar_reparo_chamado",type:"POST",data:{id_chamado:g_id_chamado,id_reparo:p_id_reparo,id_servico:a},beforeSend:()=>{$("#conteudo-reparo-servico").find(".form-check").append(`\n                                        <div id="check-servico-${e}">\n                                            <input class="form-check-input check-servico" id="checkbox-servico-${e}" type="checkbox" value="${e}">\n                                            <label for="check-servico-${e}" class="form-check-label">\n                                                ${t}\n                                            </label>\n                                        </div>\n                                    `),$("#btn-add-servico").prop("disabled",!0)}}).done(e=>{Swal.fire({toast:!0,position:"top-end",showConfirmButton:!1,timer:5e3,timerProgressBar:!0,icon:"warning",text:`Bateria ruim, adicionado servico ${t} ao reparo`,didOpen:e=>{e.onmouseenter=Swal.stopTimer,e.onmouseleave=Swal.resumeTimer}}),$("#input-voltagem").val("")}).fail(()=>(Swal.fire({toast:!0,position:"top-end",showConfirmButton:!1,timer:5e3,timerProgressBar:!0,icon:"error",text:`Falha ao adicionar servico ${t} ao reparo, tente realizar novamente ou adicione-o manualmente`,didOpen:e=>{e.onmouseenter=Swal.stopTimer,e.onmouseleave=Swal.resumeTimer}}),!1)),$("#modalVerificarBateria").modal("hide"),$("#btn-add-servico").prop("disabled",!1),$("#btnRegistrarVoltagem").prop("disabled",!1)):($("#modalVerificarBateria").modal("hide"),$("#btn-add-servico").prop("disabled",!1),$("#btnRegistrarVoltagem").prop("disabled",!1),Swal.fire({toast:!0,position:"top-end",showConfirmButton:!1,timer:5e3,timerProgressBar:!0,icon:"success",text:"Bateria está ok, não é necessário a troca",didOpen:e=>{e.onmouseenter=Swal.stopTimer,e.onmouseleave=Swal.resumeTimer}}))})})}),$.ajax({url:base_url+"reparo/realizar_servico",type:"POST",data:{id_reparo_servico:e}}).done(o=>{if(null===o)return Swal.fire({title:"Ocorreu um erro!",text:"Erro ao criar o reparo!",icon:"error"}),!1;$(`#check-servico-${e}`).html(`\n                    <div id="check-servico-${e}">\n                        <input class="form-check-input check-servico" type="checkbox" value="${e}" onclick="desfazerReparoServico(${e}, '${a}', ${t},${p_id_reparo});" checked>\n                        <label class="form-check-label">\n                            ${a}\n                        </label>\n                    </div>\n                `)})}async function cancelaServico(e,a,t){$.ajax({url:base_url+"reparo/cancelar_servico",type:"POST",data:{id_reparo_servico:e}}).done(o=>{if(null===o)return Swal.fire({title:"Ocorreu um erro!",text:"Erro ao cancelar serviço",icon:"error"}),!1;0==$("#slctListaServicoEquip").val()&&($("#slctListaServicoEquip").removeAttr("disabled"),$("#btn-add-servico").removeAttr("disabled"),$("#slctListaServicoEquip").empty()),$("#slctListaServicoEquip").append(`<option value="${t}">${a}</option>`),$(`#check-servico-${e}`).remove()})}const patrimonio_regex=/\b[1-9]{1}[0-9]{5}\b/g;var fila_atual=null,chamados_expo=[],cont_imp=0;const config=Promise.resolve(carregaConfig()).then(e=>e);(function(e){"use strict";"function"==typeof define&&define.amd?define(["jquery"],function(a){return e(a,window,document)}):"object"==typeof exports?module.exports=function(a,t){return a||(a=window),t||(t="undefined"!=typeof window?require("jquery"):require("jquery")(a)),e(t,a,a.document)}:e(jQuery,window,document)})(function(e,a,t){e.fn.dataTable.render.moment=function(e,t,o){return 1===arguments.length?(o="en",t=e,e="YYYY-MM-DD"):2===arguments.length&&(o="en"),function(i,r,n){if(!i)return"sort"===r||"type"===r?0:i;var s=a.moment(i,e,o,!0);return s.format("sort"===r||"type"===r?"x":t)}}}),window.addEventListener("load",function(){$("#btnFilas").children("label").each(function(){if($(this).attr("data-fila")==getCookie("fila_painel"))return $(this).addClass("active"),!1;$(this).attr("data-fila")==g_fila_painel&&$(this).addClass("active")})});var fila_painel=""!=getCookie("fila_painel")?getCookie("fila_painel"):g_fila_painel;$(function(){painel(fila_painel),triagem(),painelEncerrados();const e=window.location.search,a=new URLSearchParams(e),t=a.get("v");"triagem"==t&&$("#triagem-tab").tab("show"),"encerrados"==t&&$("#encerrados-tab").tab("show"),$("#tblEventos thead tr").clone(!0).appendTo("#tblEventos thead"),$("#tblEventos thead tr:eq(1) th").each(function(e){var a=$(this).text();$(this).html('<input type="text" placeholder="Procurar '+a+'" />'),$("input",this).on("keyup change",function(){$("#tblEventos").DataTable().column(e).search()!==this.value&&$("#tblEventos").DataTable().column(e).search(this.value).draw()})})});var table_painel=null;$("#tblPainel").on("mousedown","tbody tr td",function(e){if(e.preventDefault(),7==$(this)[0].cellIndex)return!1;var a=table_painel.row($(this)).data(),t=base_url+"chamado/"+a[0];1===e.button?window.open(t):2===e.button?e.preventDefault():document.location.href=t}),$("#btnImprimirChamado").on("click",function(e){e.preventDefault();var a=window.open(base_url+"chamado/imprimir_chamados?chamados="+$(this).attr("data-chamado"));a.print()}),$("#btnImprimirRelatorioChamado").on("click",function(e){e.preventDefault();var a=window.open(base_url+"chamado/imprimir_relatorio_chamado?chamados="+$(this).attr("data-chamado"));a.print()}),$("#btnImprimir").on("click",function(e){if(e.preventDefault(),0==cont_imp)return alert("Sem chamados selecionados!"),!1;var a=window.open(base_url+"chamado/imprimir_chamados?chamados="+chamados_expo);$("#contImp").text(""),chamados_expo=[],cont_imp=0,$("#tblPainel").DataTable().ajax.reload(null,!1),a.print()});var table_encerrados=null;$("#tblEncerrados").on("click","tbody tr",function(){var e=table_encerrados.row($(this)).data();window.open(base_url+"chamado/"+e[0])}),table_triagem=null,$("#tblTriagem").on("click","tbody td",function(){var e=table_triagem.row($(this)).data();document.location.href=base_url+"triagem/"+e[0]});var txt_interacao=null,texto_interacao="";let xhr;$("#modalRegistro").on("show.bs.modal",function(e){$(this).on("mouseup keyup",()=>{texto_interacao=$("textarea[name=txtInteracao]").summernote("code")});var a=$(e.relatedTarget),t=a.data("chamado"),o=$(this);o.find(".modal-body #conteudo_form").empty(),o.find(".modal-body #conteudo_form").prepend(criaFormRegistro(t,fila_atual))}),$("#modalRegistro").on("shown.bs.modal",function(e){$("#btnRegistrarInteracao").removeAttr("disabled"),$("textarea[name=txtInteracao]").summernote({toolbar:[["style",["bold","italic","underline","clear"]],["font",["strikethrough","superscript","subscript"]],["fontsize",["fontsize"]],["color",["color"]],["para",["ul","ol","paragraph"]],["height",["height"]],["insert",["link","picture"]]],height:150,lang:"pt-BR",dialogsInBody:!0,disableDragAndDrop:!1}),$("textarea[name=txtInteracao]").summernote("code",texto_interacao),$("#slctTipo").append('<option value="ATENDIMENTO" selected>Atendimento</option><option value="OBSERVACAO">Observação</option><option value="ALT_FILA">Alteração de fila</option>'),$("#slctTipo").append('<option value="ESPERA">Deixar em espera</option>'),$("#slctTipo").append('<option value="REM_ESPERA">Remover da espera</option>'),verificaTipo(fila_atual,g_id_chamado)}),$("#modalRegistro").on("hide.bs.modal",function(e){$("div[role=alert]").remove()}),$("#modalRegistroEntrega").on("hide.bs.modal",function(e){$(this).find("#btnRegistrarEntrega").hide()}),$("#modalRegistroEntrega").on("show.bs.modal",function(e){var a=$(e.relatedTarget),t=a.data("chamado");$(this).find(".modal-body form #conteudo_form_entrega").html('<label>A entrega foi realizada? </label><br><div class="custom-control custom-radio custom-control-inline"><input onchange="verificaEntrega()" type="radio" value="1" id="rdSim" name="confirmaEntrega" class="custom-control-input"><label class="custom-control-label" for="rdSim">Sim</label></div><div class="custom-control custom-radio custom-control-inline"><input onchange="verificaEntrega()" type="radio" value="0" id="rdNao" name="confirmaEntrega" class="custom-control-input"><label class="custom-control-label" for="rdNao">Não</label></div><div id="divErroEntrega" style="display: none"><div class="form-group"><label for="txtFalhaEntrega"><b>Selecione o motivo:</b></label><select class="form-control" id="slcErroEntrega" onchange="verificaEntrega()"><option value="1">Verificado defeito na instalação</option><option value="2">Responsável no local ausente</option></select></div></div><div id="divFalhaEntrega" style="display: none"><div class="form-group"><label for="txtFalhaEntrega"><b>Detalhes:</b></label><textarea class="form-control" id="txtFalhaEntrega" rows="3"></textarea></div></div><div id="divEntrega" style="display: none"><div class="form-group"><label for="termo"><strong>Termo de entrega assinado</strong></label><input type="file" class="form-control-file" name="termo_entrega" accept=".pdf"></div><div class="form-group"><label for="termo"><strong>Termo de responsabilidade assinado <small>(se houver)</small></strong></label><input type="file" class="form-control-file" name="termo_responsabilidade" accept=".pdf"></div><div class="form-group"><label for="nome_recebedor"><strong>Nome do recebedor</strong></label><input type="text" class="form-control" name="nome_recebedor"></div></div><input type="hidden" name="id_chamado" value="'+t+'" />')}),$("input[name=nome_solicitante]").autoComplete({source:function(e,a){try{xhr.abort()}catch(e){}xhr=$.getJSON(base_url+"json/solicitantes",{q:e},function(e){a(e)})},minChars:2,autoFocus:!0}),$("input[name=nome_local]").autoComplete({source:function(e,a){try{xhr.abort()}catch(e){}xhr=$.getJSON(base_url+"json/locais",{q:e},function(e){a(e)})},minChars:2});var tblEquipsChamado=null,tblServicosChamado=null;$("#tblAnexosChamado").jsGrid({width:"100%",autoload:!0,editing:!1,inserting:!1,noDataContent:"Sem anexos.",deleteConfirm:"Tem certeza?",fields:[{name:"id_anexo_otrs",title:"ID",type:"text",visible:!1},{name:"nome_arquivo_otrs",title:"Nome do arquivo",type:"text"}],controller:{loadData:function(){return $.ajax({url:base_url+"json/anexos_chamado",dataType:"json",method:"post",data:{id_chamado:g_id_chamado}})}},rowClick:function(e){window.open(base_url+"anexo_otrs/"+e.item.id_anexo_otrs)}});var item_antigo=null,entrega=null,botoes="",p_id_responsavel=null,status_chamado=null,botoes_chamado_equipamento=null,remetentes=null;$("#modalEmail").off("show.bs.modal").on("show.bs.modal",async e=>{const a=Swal.mixin({toast:!0,position:"top-end",showConfirmButton:!1,timer:6e3,timerProgressBar:!0,didOpen:e=>{e.onmouseenter=Swal.stopTimer,e.onmouseleave=Swal.resumeTimer}});$.ajax({url:base_url+`chamado/email_solicitante/${g_id_ticket_chamado}`,type:"GET",dataType:"json",success:e=>{remetentes=e,$("#remetente").html(""),remetentes.address.forEach(e=>{$("#remetente").append(`\n                    <span class="badge badge-info mt-1">Para:</span> ${e}<br>\n                `)}),remetentes.cc.forEach(e=>{$("#remetente").append(`\n                    <span class="badge badge-info mt-1">CC:</span> ${e}<br>\n                `)}),remetentes.cco.forEach(e=>{$("#remetente").append(`\n                    <span class="badge badge-info mt-1">CCo:</span> ${e}<br>\n                `)}),$(".copia").off("blur").on("blur",()=>{let e=[$("#copia"),$("#copiaOculta")];e.forEach(e=>{e.removeClass("is-invalid")}),e.forEach(e=>{$(`${e[0].id}`).removeClass("is-invalid")}),e.forEach(e=>{let t=e.val();t.includes("@")||""==t||$.ajax({url:`${base_url}chamado/busca_email/${t}`,type:"GET",dataType:"json",xhrFields:{withCredentials:!1},success:(t,o,i)=>{if(204==i.status)return void a.fire({icon:"warning",title:"Usuário não encontrado. Por favor, insira um nome de usuário válido ou um endereço de e-mail ."});if(Object.values(remetentes).some(e=>e.includes(t.email)))return e.addClass("is-invalid"),void a.fire({icon:"error",title:"O email deste usuario já esta como destinatario ou em copia"});e.val("");let r=t.email.replace(/[@.]/g,"-");"copiaOculta"==e[0].id?($("#remetente").append(`\n                                        <div id="${r}">\n                                            <span class="badge badge-info mt-1">CCo:</span> ${t.nome}  &lt;${t.email}&gt; <span class="badge badge-danger" id="remover-email" onclick="removerEmail('${r}', '${t.email}')"><i class="fas fa-times"></i></span><br>\n                                        </div>\n                                    `),remetentes.cco.push(t.email)):($("#remetente").append(`\n                                        <div id="${r}">\n                                            <span class="badge badge-info mt-1">CC:</span> ${t.nome}  &lt;${t.email}&gt; <span class="badge badge-danger" id="remover-email" onclick="removerEmail('${r}', '${t.email}')"><i class="fas fa-times"></i></span><br>\n                                        </div>\n                                    `),remetentes.cc.push(t.email))},error:e=>{a.fire({icon:"warning",title:"Erro ao consultar usuário no Active Directory!"})}})})})},error:e=>{a.fire({icon:"warning",title:"Erro ao consultar os remetentes!"})}})});const regex_email=/^[^\s@]+@[^\s@]+\.[^\s@]+$/;$("#copiasEmail").on("submit",async e=>{e.preventDefault();const a=Swal.mixin({toast:!0,position:"top-end",showConfirmButton:!1,timer:6e3,timerProgressBar:!0,didOpen:e=>{e.onmouseenter=Swal.stopTimer,e.onmouseleave=Swal.resumeTimer}});let t=[$("#copia"),$("#copiaOculta")];t.forEach(e=>{e.removeClass("is-invalid");let t=e.val(),o=t.replace(/[@.]/g,"-");if(""!=t.trim()){if(!regex_email.test(t.trim()))return e.addClass("is-invalid"),void a.fire({icon:"error",title:"Digite um email válido!"});if(Object.values(remetentes).some(e=>e.includes(t)))return e.addClass("is-invalid"),void a.fire({icon:"error",title:"O email deste usuario já esta como destinatario ou em copia"});"copiaOculta"==e[0].id?($("#remetente").append(`\n                <div id="${o}">\n                    <span class="badge badge-info mt-1">CCo:</span> ${t} <span class="badge badge-danger" id="remover-email" onclick="removerEmail('${o}', '${t}')"><i class="fas fa-times"></i></span><br>\n                </div>\n            `),remetentes.cco.push(t)):($("#remetente").append(`\n                <div id="${o}">\n                    <span class="badge badge-info mt-1">CC:</span> ${t} <span class="badge badge-danger" id="remover-email" onclick="removerEmail('${o}', '${t}')"><i class="fas fa-times"></i></span><br>\n                </div>\n            `),remetentes.cc.push(t)),e.val("")}})}),$("#btnPingEquipamento").on("click",function(){let e='<span class=" ml-1 spinner-border text-light spinner-border-sm"           role="status">\n                <span class="sr-only">Carregando...</span>\n            </span>',a='<i class="far fa-check-circle"></i>',t='<i class="fas fa-exclamation-triangle"></i>',o=$("#patrimonio").val();$(this).prop("disabled","true"),$(this).append(e),$.ajax({url:base_url+"Ping/exec_ping",type:"GET",data:`patrimonio=${o}`,dataType:"json",success:e=>{$(this).html(""),$(this).removeAttr("disabled"),!0===e.status?($(this).html("Resposta OK! "),$(this).append(a)):($(this).removeClass("btn-success"),$(this).addClass("btn-danger"),$(this).html("Sem resposta! "),$(this).append(t))},error:e=>{alert("Erro ao processar Ping!")}})}),$("#comunicacao-tab").on("click",function(){g_id_usuario==p_id_responsavel&&$.ajax({url:base_url+"chamado/zerar_nao_lidos/"+g_id_chamado,type:"GET",async:!0,dataType:"json"})}),$("#frmInteracao").on("submit",function(e){e.preventDefault();var a=base_url+"chamado/registrar_interacao",t=$("textarea[name=txtInteracao]").summernote("code"),o=$("input[name=id_chamado]").val(),i=$("input[name=id_fila_ant]").val(),r=$("select[name=tipo]").val(),n=$("select[name=id_fila]").val(),s=[],d=[],l=[];return $("input[class=chkPatri]").each(function(){$(this).is(":checked")&&s.push($(this).attr("id"))}),$("input[class=chkServ]").each(function(){$(this).is(":checked")&&(d.push($(this).attr("id")),l.push($(this).attr("id_servico")))}),$.ajax({url:a,type:"POST",data:{txtInteracao:t,id_chamado:o,tipo:r,id_fila:n,id_fila_ant:i,equipamentos_atendidos:s,servicos_atendidos:d,id_servicos_atendidos:l,id_usuario:g_id_usuario},beforeSend:function(){return 0==s.length&&3==i&&"INSERVIVEL"==r||0==s.length&&("REM_ESPERA"==r||"ESPERA"==r)?($("#modalRegistro .modal-body").prepend('<div class="alert alert-warning fade show" role="alert">Selecione os equipamentos!<button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button></div>'),!1):$("textarea[name=txtInteracao]").summernote("isEmpty")?($("#modalRegistro .modal-body").prepend('<div class="alert alert-warning fade show" role="alert">O texto não pode ficar em branco!<button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button></div>'),!1):void $("#btnRegistrarInteracao").prop("disabled","true")},success:function(e){$("#btnRegistrarInteracao").removeAttr("disabled"),atualizaInteracoes(o),$("textarea[name=txtInteracao]").summernote("reset"),$("#modalRegistro").modal("hide"),carregaChamado(o),tblEquipsChamado.loadData(),s=[,]},error:function(e,a,t){alert(e+t),$("#btnRegistrarInteracao").removeAttr("disabled")}}),!1}),$("#frmRegistroEntrega").on("submit",function(e){e.preventDefault();var a=new FormData($(this)[0]),t=$("input[name=confirmaEntrega]:checked").val(),o=$("#slcErroEntrega").val(),i=$("input[name=id_chamado]").val();a.append("opcao_entrega",t),a.append("id_chamado",i),a.append("erro_entrega",o),$("#rdNao").is(":checked")&&a.append("txtFalhaEntrega",$("#txtFalhaEntrega").summernote("code")),""!==$('input[name="termo_responsabilidade"]').val()?a.append("termo_resp",1):a.append("termo_resp",0),$.ajax({url:base_url+"interacao/registrar_entrega",type:"POST",data:a,processData:!1,contentType:!1,beforeSend:function(){if(1==t){if(""==$("input[name=termo]").val())return $("#divEntrega").prepend('<div class="alert alert-warning fade show" role="alert">Está faltando o termo!<button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button></div>'),$("input[name=termo]").focus(),!1;if(""==$("input[name=nome_recebedor]").val())return $("#divEntrega").prepend('<div class="alert alert-warning fade show" role="alert">Informe o nome do recebedor!<button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button></div>'),$("input[name=nome_recebedor]").focus(),!1}else if($("#txtFalhaEntrega").summernote("isEmpty"))return $("#divFalhaEntrega").prepend('<div class="alert alert-warning fade show" role="alert">Descreva os detalhes.<button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button></div>'),!1;$("#btnRegistrarEntrega").prop("disabled","true")},success:function(e){""===e?(atualizaInteracoes(i),$("#modalRegistroEntrega").modal("hide"),carregaChamado(i),$("#btnRegistrarEntrega").removeAttr("disabled")):($("#divEntrega").prepend('<div class="alert alert-warning fade show" role="alert"><button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>'+e+"</div>"),$("#btnRegistrarEntrega").removeAttr("disabled"))},error:function(e){alert(e),$("#btnRegistrarEntrega").removeAttr("disabled")}})});var bloqueado=!1;$("#btnBloquearChamado").on("click",function(e){e.preventDefault(),$.ajax({type:"POST",url:base_url+"json/atualiza_responsavel",data:{id_chamado:g_id_chamado,id_usuario:g_id_usuario,auto_usuario:g_auto_usuario,tipo:"b"},beforeSend:function(){$("#btnBloquearChamado").prop("disabled","true")},success:function(e){""===e?($("#btnDesbloquearChamado").removeAttr("disabled"),carregaChamado(g_id_chamado,!0)):(alert(e),carregaChamado(g_id_chamado,!0))}})}),$("#btnDesbloquearChamado").on("click",function(e){e.preventDefault(),$.ajax({type:"POST",url:base_url+"json/atualiza_responsavel",data:{id_chamado:g_id_chamado,id_usuario:g_id_usuario,tipo:"d",auto_usuario:g_auto_usuario},beforeSend:function(){$("#btnDesbloquearChamado").prop("disabled","true")},success:function(){$("#btnBloquearChamado").removeAttr("disabled"),carregaChamado(g_id_chamado,!0)},error:function(){$("#btnDesbloquearChamado").removeAttr("disabled"),alert("Operação não permitida!"),carregaChamado(g_id_chamado,!0)}})}),$("#btnEditarChamado").on("click",function(e){e.preventDefault(),$("#btnBloquearChamado").hide(),$("#btnDesbloquearChamado").hide(),$("#btnEditarChamado").hide(),$.ajax({url:base_url+"json/chamado",dataType:"json",data:{id_chamado:g_id_chamado},success:function(e){g_auto_usuario>=3&&($("#frmEditarChamado select[name=id_responsavel]").removeAttr("disabled"),$("#frmEditarChamado select[name=id_responsavel]").html(""),$.ajax({url:base_url+"json/usuarios",dataType:"json",type:"post",success:function(e){$("#frmEditarChamado select[name=id_responsavel]").append("<option></option>"),e.forEach(function(e){$("#frmEditarChamado select[name=id_responsavel]").append('<option value="'+e.id_usuario+'">'+e.nome_usuario+"</option>")})}})),e.id_responsavel==g_id_usuario||g_auto_usuario>=3?($("#frmEditarChamado input[name=nome_solicitante]").removeAttr("disabled"),$("#frmEditarChamado input[name=telefone]").removeAttr("disabled"),$("#frmEditarChamado input[name=celular]").removeAttr("disabled"),$("#frmEditarChamado input[name=nome_local]").removeAttr("disabled"),$("#frmEditarChamado button[type=submit]").removeAttr("hidden"),$("#frmEditarChamado button[type=submit]").removeAttr("disabled"),$("#frmEditarChamado #btnCancelarEdicao").removeAttr("hidden"),$("#btnDesbloquearChamado").removeAttr("disabled")):(alert("Chamado bloqueado!"),$("#btnEditarChamado").show())}})}),$("#btnCancelarEdicao").on("click",function(e){carregaChamado(g_id_chamado,!0),e.preventDefault(),$("#frmEditarChamado input[name=nome_solicitante]").prop("disabled","true"),$("#frmEditarChamado input[name=telefone]").prop("disabled","true"),$("#frmEditarChamado input[name=celular]").prop("disabled","true"),$("#frmEditarChamado input[name=nome_local]").prop("disabled","true"),$("#frmEditarChamado button[type=submit]").prop("hidden","true"),$("#frmEditarChamado select[name=id_responsavel]").attr("disabled","true"),$("#frmEditarChamado #btnEditarChamado").show(),$(this).prop("hidden","true")}),$("#frmEditarChamado").on("submit",function(e){e.preventDefault()}).validate({rules:{nome_solicitante:"required",nome_local:"required",telefone:{required:!0,digits:!0,minlength:3},celular:{required:!1,digits:!0,minlength:9}},messages:{nome_solicitante:"Campo obrigatório!",nome_local:"Campo obrigatório!",telefone:{required:"Campo obrigatório!",digits:"Somente dígitos (0-9)!",minlength:"Mínimo 3 dígitos!"},celular:{required:"Campo obrigatório!",digits:"Somente dígitos (0-9)!",minlength:"Mínimo 9 dígitos!"}},submitHandler:function(e){var a=base_url+"chamado/alterar_chamado",t=new FormData(e);$.ajax({url:a,type:"POST",data:t,contentType:!1,cache:!1,processData:!1,beforeSend:function(){var e=!1
;if($("#frmEditarChamado input[type=submit]").prop("disabled","true"),$.ajax({url:base_url+"json/chamado",dataType:"json",data:{id_chamado:g_id_chamado},success:function(a){(a.status_chamado="FECHADO")&&(e=!0)}}),e)return alert("Operação não permitida: chamado fechado!"),!1},success:function(e){carregaChamado(g_id_chamado,!0),atualizaInteracoes(g_id_chamado),$("#frmEditarChamado #alerta").prepend(e),setTimeout(function(){$("#msg_sucesso").alert("close")},2500),$("#frmEditarChamado input[name=nome_solicitante]").prop("disabled","true"),$("#frmEditarChamado select[name=id_responsavel]").prop("disabled","true"),$("#frmEditarChamado input[name=telefone]").prop("disabled","true"),$("#frmEditarChamado input[name=celular]").prop("disabled","true"),$("#frmEditarChamado input[name=nome_local]").prop("disabled","true"),$("#frmEditarChamado button[type=submit]").prop("hidden","true"),$("#frmEditarChamado #btnEditarChamado").show(),$("#frmEditarChamado #btnCancelarEdicao").prop("hidden","true")},error:function(e,a,t){alert(t)}})}});const autorizacoes=[{Name:"Operação",Id:"2"},{Name:"Supervisão",Id:"3"},{Name:"Master",Id:"4"}],estados=[{Name:"ATIVO",Id:"ATIVO"},{Name:"INATIVO",Id:"INATIVO"}];$("#usuarios-grid").jsGrid({width:"100%",height:"auto",autoload:!0,inserting:!0,editing:!0,sorting:!0,paging:!0,filtering:!0,loadMessage:"Carregando...",noDataContent:"(vazio)",insertRowLocation:"top",onItemInserted:function(e){alert(`${e.item.nome_usuario} cadastrado.`),e.grid.sort(6,"desc")},rowClick:function(e){let a=e.item.id_usuario;window.location.href=`${base_url}usuario/${a}`},controller:{loadData:async function(e){var a=$.Deferred();const t=await $.ajax({url:base_url+"usuario/listar_usuarios",dataType:"json"}).done(function(e){a.resolve(e)});return $.grep(t,function(a){return!(e.nome_usuario&&!(a.nome_usuario.toUpperCase().indexOf(e.nome_usuario.toUpperCase())>-1)||e.login_usuario&&!(a.login_usuario.indexOf(e.login_usuario)>-1)||"TODOS"!==e.autorizacao_usuario&&a.autorizacao_usuario!==e.autorizacao_usuario||void 0!==e.status_usuario&&a.status_usuario!==e.status_usuario)})},updateItem:function(e){return $.ajax({type:"POST",url:base_url+"usuario/atualizar_usuario",data:e,dataType:"json"})},insertItem:function(e){return $.ajax({type:"POST",url:base_url+"usuario/inserir_usuario",data:e,dataType:"json"})}},fields:[{name:"nome_usuario",type:"text",validate:"required",title:"Nome completo"},{name:"login_usuario",type:"text",validate:"required",title:"Login de rede"},{name:"autorizacao_usuario",type:"select",items:autorizacoes,textField:"Name",valueField:"Id",title:"Autorização",filterTemplate:function(){var e=jsGrid.fields.select.prototype.filterTemplate.call(this);return e.prepend($("<option>").prop("value","TODOS").prop("selected","true").text("Todas")),e}},{name:"triagem_usuario",type:"checkbox",title:"Triagem",filtering:!1},{name:"encerramento_usuario",type:"checkbox",title:"Encerramento de chamados",filtering:!1},{name:"status_usuario",type:"checkbox",title:"Ativo?",insertTemplate:function(){return $("<input>").attr("type","checkbox").prop("checked",!0).prop("disabled",!0)},insertValue:function(){return!0}},{name:"alteracao_usuario",type:"text",readOnly:!0,title:"Última alteração",filtering:!1,inserting:!1,updating:!1},{name:"data_usuario",type:"text",readOnly:!0,title:"Data de cadastro",filtering:!1,inserting:!1,updating:!1},{name:"id_usuario",type:"text",readOnly:!0,title:"Id_usuario",visible:!1,filtering:!1},{type:"control",deleteButton:!1}]}),$("#CheckTriagem").on("click",function(){p_id_usuario=$(this).attr("id_usuario"),permissao="triagem",registrarPermissoes(permissao,p_id_usuario)}),$("#CheckEncerramento").on("click",function(){p_id_usuario=$(this).attr("id_usuario"),permissao="encerramento",registrarPermissoes(permissao,p_id_usuario)}),$("#CheckInserviveis").on("click",function(){p_id_usuario=$(this).attr("id_usuario"),permissao="inserviveis",registrarPermissoes(permissao,p_id_usuario)}),$("#pills-modelos-mensagens-tab").is(":visible")&&Promise.resolve(carregaFilas()).then(e=>{let a=[{Name:"Atendimento",Id:"ATENDIMENTO"},{Name:"Observação",Id:"OBSERVACAO"},{Name:"Inservível",Id:"INSERVIVEL"},{Name:"Alteração de fila",Id:"ALT_FILA"},{Name:"Remover da espera",Id:"REM_ESPERA"},{Name:"Deixar em espera",Id:"ESPERA"}];$("#modelos-mensagens-grid").jsGrid({width:"100%",height:"auto",autoload:!0,inserting:!0,editing:!0,sorting:!0,paging:!0,filtering:!0,loadMessage:"Carregando...",noDataContent:"(vazio)",onItemInserted:function(e){alert("Modelo cadastrado."),e.grid.sort(5,"desc")},controller:{loadData:async function(e){var a=$.Deferred();const t=await $.ajax({url:base_url+"ModeloMensagem/listar_modelo_mensagem/",dataType:"json"}).done(function(e){a.resolve(e)});return $.grep(t,function(a){return!("TODOS"!==e.fila_modelo_mensagem&&a.fila_modelo_mensagem!=e.fila_modelo_mensagem||"TODOS"!==e.tipo_modelo_mensagem&&a.tipo_modelo_mensagem!==e.tipo_modelo_mensagem||e.mensagem_modelo_mensagem&&!(a.mensagem_modelo_mensagem.indexOf(e.mensagem_modelo_mensagem)>-1)||void 0!==e.status_modelo_mensagem&&a.status_modelo_mensagem!==e.status_modelo_mensagem)})},updateItem:function(e){return $.ajax({type:"POST",url:base_url+"modeloMensagem/atualizar_modelo_mensagem",data:e,dataType:"json"})},insertItem:function(e){return $.ajax({type:"POST",url:base_url+"modeloMensagem/inserir_modelo_mensagem",data:e,dataType:"json"})}},fields:[{name:"mensagem_modelo_mensagem",type:"text",validate:"required",title:"Texto"},{name:"fila_modelo_mensagem",type:"select",items:e,textField:"nome_fila",valueField:"id_fila",title:"Fila",filterTemplate:function(){var e=jsGrid.fields.select.prototype.filterTemplate.call(this);return e.prepend($("<option>").prop("value","TODOS").prop("selected","true").text("Todas")),e}},{name:"tipo_modelo_mensagem",type:"select",items:a,textField:"Name",valueField:"Id",title:"Tipo",filterTemplate:function(){var e=jsGrid.fields.select.prototype.filterTemplate.call(this);return e.prepend($("<option>").prop("value","TODOS").prop("selected","true").text("Todos")),e}},{name:"status_modelo_mensagem",type:"checkbox",title:"Ativo?",insertTemplate:function(){return $("<input>").attr("type","checkbox").prop("checked",!0).prop("disabled",!0)},insertValue:function(){return"true"}},{name:"data_modelo_mensagem",type:"text",readOnly:!0,title:"Data de criação",filtering:!1,inserting:!1},{name:"alterado_modelo_mensagem",type:"text",readOnly:!0,title:"Última alteração",filtering:!1,inserting:!1},{type:"control",deleteButton:!1}]})});const secretarias=Promise.resolve(carregaSecretarias());secretarias.then(e=>{const a=[{NAME:"INTERNA",ID:"INTERNA"},{NAME:"CENTRO",ID:"CENTRO"},{NAME:"NORTE",ID:"NORTE"},{NAME:"SUL",ID:"SUL"},{NAME:"OESTE",ID:"OESTE"},{NAME:"LESTE",ID:"LESTE"}];$("#locais-grid").jsGrid({width:"100%",height:"auto",autoload:!0,inserting:!0,editing:!0,sorting:!0,paging:!0,filtering:!0,loadMessage:"Carregando...",noDataContent:"(vazio)",onItemInserted:function(e){alert(`${e.item.nome_local} cadastrado.`),e.grid.sort(5,"desc")},controller:{loadData:async function(e){var a=$.Deferred();const t=await $.ajax({url:base_url+"local/listar_locais/",dataType:"json"}).done(function(e){a.resolve(e)});return $.grep(t,function(a){return!(e.nome_local&&!(a.nome_local.toUpperCase().indexOf(e.nome_local.toUpperCase())>-1)||e.endereco_local&&!(a.endereco_local.indexOf(e.endereco_local)>-1)||"TODOS"!==e.secretaria_local&&a.secretaria_local!==e.secretaria_local||void 0!==e.status_local&&a.status_local!==e.status_local||"TODOS"!==e.regiao_local&&a.regiao_local!==e.regiao_local)})},updateItem:function(e){return $.ajax({type:"POST",url:base_url+"local/atualizar_local",data:e,dataType:"json"})},insertItem:function(e){return $.ajax({type:"POST",url:base_url+"local/inserir_local",data:e,dataType:"json"})}},rowClick:function(e){let a=e.item.id_local;window.location.href=`${base_url}local/${a}`},onItemInserting:function(e){for(i=0;i<e.grid.data.length;i++)e.item.nome_local==e.grid.data[i].nome_local&&(e.cancel=!0,alert("O local "+e.item.nome_local+" já existe"))},onItemUpdating:function(e){for(i=0;i<e.grid.data.length;i++)e.item.nome_local==e.grid.data[i].nome_local&&e.item.id_local!=e.grid.data[i].id_local&&(e.cancel=!0,alert("O local "+e.item.nome_local+" já existe"))},fields:[{name:"nome_local",type:"text",validate:[{validator:"pattern",message:"Atenção!\nDigite um nome para o local.",param:"[a-zA-Z0-9]+.+"}],title:"Nome"},{name:"endereco_local",type:"text",validate:[{validator:"pattern",message:"Atenção!\nDigite um endereço.",param:"[a-zA-Z0-9]+.+"}],title:"Endereço"},{name:"secretaria_local",type:"select",items:e,textField:"sigla_secretaria",valueField:"id_secretaria",title:"Secretaria",filterTemplate:function(){var e=jsGrid.fields.select.prototype.filterTemplate.call(this);return e.prepend($("<option>").prop("value","TODOS").prop("selected","true").text("Todas")),e}},{name:"regiao_local",type:"select",items:a,textField:"NAME",valueField:"ID",title:"Região",filterTemplate:function(){var e=jsGrid.fields.select.prototype.filterTemplate.call(this);return e.prepend($("<option>").prop("value","TODOS").prop("selected","true").text("Todas")),e}},{name:"status_local",type:"checkbox",title:"Ativo?",insertTemplate:function(){return $("<input>").attr("type","checkbox").prop("checked",!0).prop("disabled",!0)},insertValue:function(){return"true"}},{name:"infovia",type:"checkbox",title:"Infovia",insertTemplate:function(){return $("<input>").attr("type","checkbox").prop("checked",!0).prop("disabled",!0)},insertValue:function(){return"true"}},{name:"alteracao_local",type:"text",readOnly:!0,title:"Última alteração",filtering:!1,inserting:!1},{type:"control",deleteButton:!1}]})}).catch(e=>{console.error(e)}),$("#secretarias-grid").jsGrid({width:"100%",height:"auto",autoload:!0,inserting:!0,editing:!0,sorting:!0,paging:!0,filtering:!0,loadMessage:"Carregando...",noDataContent:"(vazio)",onItemInserted:function(e){alert(`${e.item.nome_secretaria} cadastrada.`),e.grid.sort(3,"desc")},controller:{loadData:async function(e){const a=await Promise.resolve(secretarias);return $.grep(a,function(a){return(!e.nome_secretaria||a.nome_secretaria.toUpperCase().indexOf(e.nome_secretaria.toUpperCase())>-1)&&(!e.sigla_secretaria||a.sigla_secretaria.indexOf(e.sigla_secretaria)>-1)&&(void 0===e.status_secretaria||a.status_secretaria===e.status_secretaria)})},updateItem:function(e){return $.ajax({type:"POST",url:base_url+"secretaria/atualizar_secretaria",data:e,dataType:"json"})},insertItem:function(e){return $.ajax({type:"POST",url:base_url+"secretaria/inserir_secretaria",data:e,dataType:"json"})}},fields:[{name:"nome_secretaria",type:"text",validate:[{validator:"pattern",message:"Atenção!\nDigite um nome para a secretaria.",param:"[a-zA-Z0-9]+.+"}],title:"Nome"},{name:"sigla_secretaria",type:"text",validate:[{validator:"pattern",message:"Atenção!\nDigite uma sigla para a secretaria.",param:"[a-zA-Z0-9]+.+"}],title:"Sigla"},{name:"status_secretaria",type:"checkbox",title:"Ativa?",insertTemplate:function(){return $("<input>").attr("type","checkbox").prop("checked",!0).prop("disabled",!0)},insertValue:function(){return"true"}},{name:"ultima_alteracao",type:"text",readOnly:!0,title:"Última alteração",filtering:!1,inserting:!1},{type:"control",deleteButton:!1}]}),Promise.resolve(carregaFilas()).then(e=>{$("#servicos-grid").jsGrid({width:"100%",height:"auto",autoload:!0,inserting:!0,editing:!0,sorting:!0,paging:!0,invalidMessage:"Erro!",filtering:!0,loadMessage:"Carregando...",noDataContent:"(vazio)",onItemInserting:function(e){for(i=0;i<e.grid.data.length;i++)e.item.nome_servico.toUpperCase()==e.grid.data[i].nome_servico&&(e.cancel=!0,alert("O servico "+e.item.nome_servico.toUpperCase()+" já existe"))},onItemInserted:function(e){alert(`Serviço ${e.item.nome_servico} cadastrado.`),e.grid.sort(6,"DESC")},onItemUpdating:function(e){for(i=0;i<e.grid.data.length;i++)e.item.nome_servico.toUpperCase()==e.grid.data[i].nome_servico&&e.item.id_servico!=e.grid.data[i].id_servico&&(e.cancel=!0,alert("O servico "+e.item.nome_servico.toUpperCase()+" já existe"))},controller:{loadData:async function(e){var a=$.Deferred();const t=await $.ajax({url:base_url+"servico/listar_servicos_triagem/",dataType:"json"}).done(function(e){a.resolve(e)});return $.grep(t,function(a){return!(e.nome_servico&&!(a.nome_servico.toUpperCase().indexOf(e.nome_servico.toUpperCase())>-1)||0!==e.id_fila_servico&&a.id_fila_servico!=e.id_fila_servico||void 0!==e.status_servico&&a.status_servico!==e.status_servico)})},updateItem:function(e){return $.ajax({type:"POST",url:base_url+"servico/atualizar_servico",dataType:"json",data:e})},insertItem:function(e){return $.ajax({type:"POST",url:base_url+"servico/inserir_servico",data:e,dataType:"json"})}},fields:[{name:"nome_servico",type:"text",validate:[{validator:"pattern",message:"Atenção!\nDigite um nome para o serviço.",param:"[a-zA-Z0-9]+.+"}],title:"Serviço"},{name:"id_fila_servico",title:"Fila",type:"select",align:"center",autosearch:!0,items:e,valueField:"id_fila",textField:"nome_fila",selectedIndex:-1,valueType:"number",readOnly:!1,filterTemplate:function(){var e=jsGrid.fields.select.prototype.filterTemplate.call(this);return e.prepend($("<option>").prop("value",0).prop("selected","true").text("Todas")),e}},{name:"unidade_medida",type:"text",validate:["required",{validator:"maxLength",param:3,message:"Atenção!\nEste campo deve ser preenchido e conter no máximo 3 caracteres."}],title:"Unidade de medida",filtering:!1,insertTemplate:function(){var e=jsGrid.fields.text.prototype.insertTemplate.call(this);return e.attr("type","text").val("UN"),e}},{name:"pontuacao_servico",type:"text",validate:["required",{validator:"pattern",param:/^[12345]+$/,message:"Atenção!\nEste campo aceita um dígito de 1 a 5."}],title:"Complexidade (1 a 5)",filtering:!1},{name:"valor_servico",type:"text",validate:["required",{validator:"pattern",param:/^\d+(\.\d{1,2})?$/,message:'Atenção!\nNão utilize a virgula "," Utilize apanes o ponto "."\nExemplo: 99.99'}],title:"Valor unitário (R$)",filtering:!1},{name:"status_servico",type:"checkbox",title:"Ativo?",insertTemplate:function(){return $("<input>").attr("type","checkbox").prop("checked",!0).prop("disabled",!0)},insertValue:function(){return"true"}},{name:"data_ultima_alteracao",type:"text",readOnly:!0,title:"Última alteração",filtering:!1,inserting:!1},{type:"control",deleteButton:!1}]})}),$("#bancadas-grid").jsGrid({width:"100%",height:"auto",autoload:!0,inserting:!0,editing:!0,sorting:!0,paging:!0,invalidMessage:"Erro!",filtering:!1,loadMessage:"Carregando...",noDataContent:"(vazio)",onItemInserting:function(e){let a=e.grid.data.length;e.item.nome_bancada="#"+(a+1)},onItemEditing:function(e){e.grid.fields[1].editing=!0,1==e.item.ocupado_bancada&&(e.grid.fields[1].editing=!1)},onItemInserted:function(e){alert(`Bancada ${e.item.nome_bancada} cadastrada.`)},controller:{loadData:function(){return carregarBancadas()},updateItem:function(e){if(0==e.ocupado_bancada)return $.ajax({type:"POST",url:base_url+"bancada/atualizar_bancada",dataType:"json",data:e})},insertItem:function(e){return $.ajax({type:"POST",url:base_url+"bancada/inserir_bancada",data:e,dataType:"json"})}},fields:[{name:"nome_bancada",type:"text",insertTemplate:function(){let e=this.__proto__.insertTemplate.call(this);return e.val("#"),e.prop("disabled",!0),e},title:"Identificação",editing:!1},{name:"status_bancada",type:"checkbox",title:"Ativa?",insertTemplate:function(){return $("<input>").attr("type","checkbox").prop("checked",!0).prop("disabled",!0)},insertValue:function(){return"true"}},{name:"ocupado_bancada",type:"checkbox",title:"Ocupada?",editing:!1,insertTemplate:function(){return $("<input>").attr("type","checkbox").prop("checked",!0).prop("disabled",!0)},insertValue:function(){return"true"}},{type:"control",deleteButton:!1}]}),$("#tblEventos").DataTable({autoWidth:!0,columnDefs:[{width:"10%",targets:3,render:$.fn.dataTable.render.moment("YYYY-MM-DD HH:mm:ss","DD/MM/YYYY H:mm:ss")},{width:"10%",targets:0},{width:"40%",targets:2}],orderCellsTop:!1,fixedHeader:!0,language:{decimal:"",emptyTable:"(vazio)",info:"Mostrando _START_ a _END_ de _TOTAL_ eventos",infoEmpty:"Mostrando 0 a 0 de 0 eventos",infoFiltered:"(filtrado de _MAX_ eventos)",infoPostFix:"",thousands:".",lengthMenu:"Mostrando _MENU_ eventos",loadingRecords:"Carregando...",processing:"Processando...",search:"Busca:",zeroRecords:"Sem resultados!",paginate:{first:"Primeiro",last:"Último",next:"Próximo",previous:"Anterior"}},ajax:base_url+"admin/listar_eventos/",order:[[0,"desc"]]}),setInterval(function(){$("#tblEventos").DataTable().ajax.reload(null,!1)},3e4),UTF8={encode:function(e){for(var a,t=-1,o=(e=e.split("")).length,i=String.fromCharCode;++t<o;e[t]=(a=e[t].charCodeAt(0))>=127?i(192|a>>>6)+i(128|63&a):e[t]);return e.join("")},decode:function(e){for(var a,t,o=-1,i=(e=e.split("")).length,r=String.fromCharCode,n="charCodeAt";++o<i;128&(a=e[o][n](0))&&(e[o]=192==(252&a)&&128==(192&(t=e[o+1][n](0)))?r(((3&a)<<6)+(63&t)):r(128),e[++o]=""));return e.join("")}},$("#tblAnexos").jsGrid({width:"100%",autoload:!1,editing:!1,inserting:!1,noDataContent:"Sem anexos.",deleteConfirm:"Tem certeza?",fields:[{name:"id_arquivo",title:"ID",type:"text",visible:!1},{name:"nome_arquivo",title:"Nome do arquivo",type:"text"},{type:"control",deleteButton:!0,editButton:!1}],rowClick:function(e){window.open(base_url+"anexo_otrs/"+e.item.id_arquivo,"_blank ")}});var agrupamento=!1,diffDesc=null;$("#slctEquipe").on("change",function(){$(this).val();$("#linhaInfra").toggle(),$("#linhaSuporte").toggle()});var servicos=[],servico_atualizado=[],g_equips=[];$("#tblEquips").jsGrid({width:"100%",autoload:!1,editing:!0,inserting:!0,confirmDeleting:!1,noDataContent:"Sem equipamentos.",fields:[{name:"Número",type:"text",width:50,validate:"required"},{name:"Descrição",type:"text",width:50,validate:"required"},{type:"control",deleteButton:!0}]});var ocorrencias=[],confirmado=!1;$("#btnValidaEquip").on("click",async function(){confirmado=!!agrupamento,$(this).prop("disabled","true"),$("#pbEquips").css("width","0%");var e=$("#tblEquips").jsGrid("option","data");g_equips=[];var a=[];if(ocorrencias=[],percentage=100/e.length,total_percentage=0,e.length>0){for(i=0;i<e.length;i++){if(""==e[i].Número&&""==e[i].Descrição)a.push("Existem itens vazios na lista!\n");else{if(""==e[i].Número)a.push("O item "+e[i].Descrição+" está sem número!\n");else{var t=await verificaStatusEquip(e[i].Número,!0);if(null!==t)for(j=0;j<t.length;j++)"ABERTO"!==t[j].status_equipamento_chamado&&"ENTREGA"!==t[j].status_equipamento_chamado&&"ESPERA"!==t[j].status_equipamento_chamado&&"INSERVIVEL"!==t[j].status_equipamento_chamado&&"REPARO"!==t[j].status_equipamento_chamado&&"GARANTIA"!==t[j].status_equipamento_chamado&&"REMESSA"!==t[j].status_equipamento_chamado||ocorrencias.push({"Número":e[i].Número,Status:t[j].status_equipamento_chamado,ID:t[j].id_chamado,Ticket:t[j].ticket_chamado})}var o=await verificaDescEquip(e[i].Número);null!==o.descricao&&(e[i].Descrição=o.descricao),null===e[i].Descrição&&a.push("O item "+e[i].Número+" está sem descrição!\n")}total_percentage+=percentage,$("#pbEquips").css("width",total_percentage+"%")}0==a.length?($("#tblEquips").jsGrid("option","data",e),ocorrencias.length>0?($("#modalOcorrencias").modal("show"),$(this).removeAttr("disabled")):(confirmado=!0,g_equips=e,$(this).html('<i class="fa fa-check"></i> Confirmado!'),$("#tblEquips").jsGrid("fieldOption",2,"visible",!1),$("#tblEquips").jsGrid("option","editing",!1),$("#tblEquips").jsGrid("option","inserting",!1),$(this).prop("disabled","true"),$("#btnAlteraEquip").removeAttr("disabled"),$("#btnLoteEquip").prop("disabled","true"))):(alert(a),$(this).removeAttr("disabled"))}else 0==agrupamento?(alert("A lista está vazia!"),$(this).removeAttr("disabled")):($(this).html('<i class="fa fa-check"></i> Confirmado!'),$("#btnAlteraEquip").removeAttr("disabled"),$("#btnLoteEquip").prop("disabled","true"))}),$("#modalOcorrencias").on("hidden.bs.modal",function(e){$("#tblOcorrencias").jsGrid("option","data",[])}),$("#modalOcorrencias").on("shown.bs.modal",function(e){$("#tblOcorrencias").jsGrid({width:"100%",autoload:!1,editing:!1,inserting:!1,data:ocorrencias,fields:[{name:"Número",type:"text",width:50,validate:"required"},{name:"Status",type:"text",width:20,validate:"required"},{name:"ID",type:"text",width:30,validate:"required"},{name:"Ticket",type:"text",width:50,validate:"required"}],rowClick:function(e){window.open(base_url+"chamado/"+e.item.ID,"_blank ")}})}),$("#btnAlteraEquip").on("click",function(){confirmado=!1,g_equips=[],$("#btnValidaEquip").html('<i class="fa fa-check"></i> Confirmar!'),$("#tblEquips").jsGrid("fieldOption",2,"visible",!0),$("#tblEquips").jsGrid("option","editing",!0),$(this).prop("disabled","true"),$("#btnValidaEquip").removeAttr("disabled"),$("#btnLoteEquip").removeAttr("disabled")}),$("#btnLoteEquip").on("click",function(){confirmado=!1,$("#modalLote").modal("show")}),$("#radLoteFaixa").on("click",function(){$("#divListaLote").hide(),$("#divFaixaLote").show()}),$("#radLoteLista").on("click",function(){$("#divFaixaLote").hide(),$("#divListaLote").show()}),$("#btnInsereLote").on("click",async function(){if($("#radLoteFaixa").is(":checked")){var e=Number($("#txtInicioFaixaLote").val()),a=Number($("#txtFimFaixaLote").val());if(a-e<1||isNaN(a-e))alert("Faixa inválida");else{$(this).prop("disabled","true"),percentage=100/(a-e),total_percentage=0;for(var t=$("#tblEquips").jsGrid("option","data"),o=[],i=e;i<=a;){var r=null,n=await verificaDescEquip(i);null!==n.descricao&&(r=n.descricao),o.push({"Número":i,"Descrição":r}),i++,total_percentage+=percentage,$("#pbLote").css("width",total_percentage+"%")}novo_grid=t.concat(o),$("#tblEquips").jsGrid("option","data",novo_grid),$("#modalLote").removeClass("fade").modal("hide"),$("#modalLote").modal("dispose"),$(this).removeAttr("disabled")}}if($("#radLoteLista").is(":checked")){t=$("#tblEquips").jsGrid("option","data");if(""==$("#txtListaLote").val())return;$(this).prop("disabled","true");var s=$("#txtListaLote").val().split("\n");percentage=100/s.length,total_percentage=0;var d=[];for(i=0;i<s.length;i++){r=null,n=await verificaDescEquip(s[i]);null!==n.descricao&&(r=n.descricao),d.push({"Número":s[i],"Descrição":r}),total_percentage+=percentage,$("#pbLote").css("width",total_percentage+"%")}novo_grid=t.concat(d),$("#tblEquips").jsGrid("option","data",novo_grid),$("#modalLote").removeClass("fade").modal("hide"),$("#modalLote").modal("dispose"),$(this).removeAttr("disabled")}}),$("#modalLote").on("hidden.bs.modal",function(){$("#txtInicioFaixaLote").val(null),$("#txtFimFaixaLote").val(null),$("#btnInsereLote").removeAttr("disabled"),$("#pbLote").css("width","0%")}),$("#frmDevolveChamado").on("submit",function(e){e.preventDefault();var a=$(this).find("#txtDescDevo").val();""!==a&&confirm("Deseja realmente devolver esse ticket? Isso não poderá ser desfeito!")&&$.ajax({url:base_url+"chamado/devolver_chamado",async:!0,method:"post",data:{id_ticket:g_id_ticket,desc_devo:a},beforeSend:function(){$(this).find("submit").prop("disabled","true")},success:function(e){document.location.href=base_url+"painel?v=triagem"}})}),$('input[name="telefone"]').on("keyup keyup keypress blur change",function(){var e=$(this).val();$(this).val(e.replace(/[\.-\s]/g,""))}),$('input[name="celular"]').on("keyup keyup keypress blur change",function(){var e=$(this).val();$(this).val(e.replace(/[\.-\s]/g,""))}),$('input[name="resumo_solicitacao"]').on("keyup keyup keypress blur change",function(){var e=$(this).val();$(this).val(e.replace(/[\"\']/g,""))}),$("#tblEquips input").on("keyup keyup keypress blur change",function(){var e=$(this).val();$(this).val(e.replace(/\s/g,""))}),$("#frmImportarChamado").on("submit",function(e){e.preventDefault()}).validate(1==agrupamento?{ignore:"*"}:{rules:{nome_solicitante:"required",nome_local:"required",telefone:{required:!0,digits:!0,minlength:3},id_fila:{required:!0},celular:{required:{depends:function(){return"TELEFONIA"===nome_fila_sigat}},digits:!0,minlength:9},resumo_solicitacao:{required:!0}},messages:{nome_solicitante:"Campo obrigatório!",nome_local:"Campo obrigatório!",telefone:{required:"Campo obrigatório!",digits:"Somente dígitos (0-9)!",minlength:"Mínimo 3 dígitos!"},resumo_solicitacao:{required:"Campo obrigatório!"},celular:{required:"Campo obrigatório para serviços de Telefonia!",digits:"Somente dígitos (0-9)!",minlength:"Mínimo 9 dígitos!"}},submitHandler:async function(e){var a=base_url+"chamado/importar_chamado",t=new FormData(e);t.append("id_fila",id_fila_sigat),1==id_fila_sigat?t.append("listaEquipamentos",JSON.stringify(g_equips)):t.append("listaServicos",JSON.stringify($("#tblServicos").jsGrid("option","data"))),t.append("num_ticket",g_num_ticket),t.append("g_anexos",JSON.stringify($("#tblAnexos").jsGrid("option","data"))),t.append("id_ticket",g_id_ticket);let o=!1;return await $.ajax({url:base_url+"triagem/consultar_chamado_aberto",type:"GET",data:`id_ticket_chamado=${g_id_ticket}`,datatype:"json",success:e=>{null!=e&&(alert(`O chamado ${e[0].id_chamado} já está aberto`),o=!0)},error:e=>{console.error(e)}}),1==o?(window.location.href=base_url+"painel#triagem",!0):($.ajax({url:a,type:"POST",data:t,contentType:!1,cache:!1,processData:!1,beforeSend:function(){var e=$("#tblServicos").jsGrid("option","data");if(0==confirmado&&e.length<1)return alert("Verifique a lista de equipamentos ou adicione um dos serviços!"),targetOffset=$("#tblServicos").offset().top,$("html, body").animate({scrollTop:targetOffset-100},200),!1;$("#btnImportarChamado").prop("disabled","true")},success:function(e){confirmado=!1,0==e.includes("Local")?($("#divTriagem").html(""),$("#msg div[id=alerta]").remove(),$("#msg").html(e)):($("input[name=nome_local").focus(),$("#listaLocais").popover({content:"Local inválido!",trigger:"focus"}),$("#listaLocais").popover("toggle"),confirmado=!0,$("#btnImportarChamado").removeAttr("disabled")),$("#btnImportarChamado").removeAttr("disabled"),e=null},error:function(e,a,t){$("#msg").prepend('<div id="alerta" class="alert alert-danger alert-dismissible">'),$("#alerta").append('<a href="#" class="close" data-dismiss="alert" aria-label="close">&times;</a>'+t),targetOffset=$("#msg").offset().top,$("html, body").animate({scrollTop:targetOffset-100},200),$("#btnImportarChamado").removeAttr("disabled")}}),!1)}});var result_br=[];$("#frmBuscaRapida button").on("click",async function(e){e.preventDefault();var a=$("#txtBuscaRapida").val();a.length>=3&&(await $.ajax({url:base_url+"busca",type:"GET",data:{t:a},success:function(e){result_br=e},error:function(e,a,t){alert(t)}}),$("#modalBuscaRapida").modal("show"))}),$("#modalBuscaRapida").on("show.bs.modal",function(){$(this).find(".modal-body").html(result_br),$(this).find(".modal-title").html('<i class="fas fa-search"></i> Buscando por <em>'+$("#txtBuscaRapida").val()+"</em>")}),$("#modalBuscaRapida").on("shown.bs.modal",function(){$("#tblChamadosBr tbody tr").on("click",function(){window.open(base_url+"chamado/"+$(this).find("td").first().text())}),$("#tblTriagemBr tbody tr").on("click",function(){window.open(base_url+"triagem/"+$(this).find("td").first().text())}),$("#tblEquipsBr tbody tr ").on("click",function(){window.open(base_url+"equipamento/"+$(this).find("td").first().text())}),$("#tblChamadosEquipBr tbody tr ").on("click",function(){window.open(base_url+"chamado/"+$(this).find("td").first().text())})}),$("#frmBuscaRapida").on("submit",function(e){e.preventDefault()}),$("#chkPrioridade").on("click",async function(){p_id_chamado=$(this).attr("id_chamado"),await $.ajax({url:base_url+"chamado/priorizar_chamado",type:"POST",async:!0,data:{id_chamado:p_id_chamado},success:function(e){$("#headerChamado #estrela_prioridade").toggle()},error:function(e){alert(e)}})}),$("#modalEmail").on("shown.bs.modal",function(){$("#titleEmail").val(`Re: [Chamado: #${g_id_chamado}]`),$("textarea[name=txtEmail]").summernote({toolbar:[["style",["bold","italic","underline","clear"]],["font",["strikethrough","superscript","subscript"]],["fontsize",["fontsize"]],["color",["color"]],["para",["ul","ol","paragraph"]],["height",["height"]],["insert",["link","picture"]]],height:300,lang:"pt-BR",dialogsInBody:!0,disableDragAndDrop:!1})}),$("#frmEmail").on("submit",function(e){e.preventDefault();let a=$("textarea[name=txtEmail]").summernote("code"),t='<span class=" ml-1 spinner-border text-light spinner-border-sm" role="status">\n            <span class="sr-only">Carregando...</span>\n        </span>';$("#modalEmail").append(t);let o=new FormData($(this)[0]);if(o.append("conteudo",a),o.append("id_ticket_chamado",g_id_ticket_chamado),o.append("id_chamado",g_id_chamado),remetentes.cc.forEach((e,a)=>{o.append(`remetentes[cc][${a}]`,e)}),remetentes.cco.forEach((e,a)=>{o.append(`remetentes[cco][${a}]`,e)}),""!==$('input[id="fileAnexosEmail"]').val()?o.append("anexos",1):o.append("anexos",0),-1!==a.toLowerCase().indexOf("anexo")&&""===$('input[id="fileAnexosEmail"]').val()){let e=confirm("Você pode ter esquecido de anexar um arquivo.\nDeseja enviar este email mesmo assim?");if(!e)return!1}return $("textarea[name=txtEmail]").summernote("isEmpty")?($("#modalEmail .modal-body").prepend('<div class="alert alert-warning fade show" role="alert">O texto não pode ficar em branco!<button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button></div>'),!1):$.ajax({url:base_url+"interacao/enviar_email",dataType:"json",contentType:!1,processData:!1,method:"post",data:o,beforeSend:()=>{},success:()=>{$("textarea[name=txtEmail]").summernote("reset"),$("#fileAnexosEmail").val(""),alert("Email enviado com sucesso"),$("#modalEmail").modal("hide"),window.location.reload(!1)},complete:()=>{$("#btnEnviarEmail").removeAttr("disabled")},error:(e,a,t)=>{$("#modalEmail .modal-body").prepend('<div class="alert alert-danger fade show" role="alert">Erro ao enviar e-mail!<br>'+e.responseJSON.message+'<button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button></div>'),alert("Erro ao enviar email!"),$("#btnEnviarEmail").removeAttr("disabled")}})}),$("#chkLocal").on("click",async function(){p_id_local=$(this).attr("id_local"),await $.ajax({url:base_url+"local/ativar_local",type:"POST",async:!0,data:{id_local:p_id_local},success:function(e){0==document.getElementById("chkLocal").checked?alert("Local desativado: Este local não será mais listado."):alert("Local Ativado")},error:function(e){alert("Erro ao atualizar status do local")}})}),$("#btnSalvarLocal").hide(),$("#btnEditarLocal").on("click",function(){let e=[];e.push($("#nome_local").val(),$("#secretaria_local").val(),$("#endereco_local").val(),$("#regiao_local").val()),$("#btnSalvarLocal").show(),$("#btnCancelarEdicaoLocal").removeAttr("hidden"),$("input").removeAttr("disabled"),$("select").removeAttr("disabled"),$("#btnCancelarEdicaoLocal").on("click",function(){$("#nome_local").val(e[0]),$("#secretaria_local").val(e[1]),$("#endereco_local").val(e[2]),$("#regiao_local").val(e[3]),$("#btnSalvarLocal").hide(),$("#frmEditarLocal input").prop("disabled",!0),$("#frmEditarLocal select").prop("disabled",!0),$("#btnCancelarEdicaoLocal").prop("hidden",!0)})}),$("#addTelLocal").on("click",function(){$("button").attr("disabled","disabled");let e='<tr id="addLinha"> <td id="campoTelAdd"><input id="telAdd" name="telefone" class="form-control" onkeyup="handlePhone(event)" type="text" value="" maxlength="15"></input></td> <td id="campoSetAdd"><input class="form-control" id="setAdd" name="setor" maxlength="100" type="text" value=""></input></td><td id="edit"><button onclick="inserirTelefone()" type="button" class="btn btn-success mr-2"><i class="fas fa-save"></i> Salvar</button><button id="btnCancelarAdd" type="button" class="btn btn-danger"><i class="fas fa-window-close"></i> Cancelar</button></td></tr>';$("#tabela_telefones tbody").append(e),$("#addTelLocal").hide(),
$("#btnCancelarAdd").on("click",function(){$("#addLinha").remove(),$("#addTelLocal").show(),$("button").removeAttr("disabled")})});const handlePhone=e=>{let a=e.target;a.value=phoneMask(a.value)},phoneMask=e=>e?(e=e.replace(/\D/g,""),e.length>9&&(e=e.replace(/(\d{2})(\d)/,"($1) $2")),e=e.replace(/(\d)(\d{4})$/,"$1-$2"),e):"";$("#modalIniciarReparo").on("show.bs.modal",async function(e){var a=$(this),t=$(e.relatedTarget),o=t.data("chamado"),i=null,r=null;return $(this).find("#alerta-reparo").remove(),await $.ajax({method:"POST",url:base_url+"json/equipamentos_pendentes",data:{id_chamado:o,espera:!1}}).done(e=>{i=e}),await $.ajax({method:"POST",url:base_url+"bancada/lista_bancadas",data:{status:0}}).done(e=>{r=e}),0==r.length?($("#btnIniciarReparo").prop("disabled","true"),$("#listaBancadas").prop("disabled","true"),$("#listaEquipReparo").prop("disabled","true"),$("#modalIniciarReparo").find(".modal-body").prepend('<div id="alerta-reparo" class="alert alert-warning" role="alert">\n                Não existem bancadas disponíveis!\n              </div>'),!1):0==i.equipamentos.length?($("#btnIniciarReparo").prop("disabled","true"),$("#listaBancadas").prop("disabled","true"),$("#listaEquipReparo").prop("disabled","true"),$("#modalIniciarReparo").find(".modal-body").prepend('<div id="alerta-reparo" class="alert alert-warning" role="alert">\n                Não existem equipamentos disponíveis!\n              </div>'),!1):(i.equipamentos.forEach(e=>{a.find(".modal-body #listaEquipReparo").append(`<option value="${e.num_equipamento_chamado}">\n        ${e.num_equipamento_chamado}\n        </option>`)}),void(3==g_fila_chamado?r.forEach(e=>{1==e.status_bancada&&a.find(".modal-body #listaBancadas").append(`<option value="${e.id_bancada}">\n                ${e.nome_bancada}\n                </option>`)}):r.forEach(e=>{"0"==e.nome_bancada&&(a.find(".modal-body #listaBancadas").append(`<option value="${e.id_bancada}" selected>\n                ${e.nome_bancada}\n                </option>`),a.find(".modal-body #listaBancadas").prop("disabled",!0))})))}),$("#modalIniciarReparo").on("hide.bs.modal",function(e){$(this).find(".modal-body #listaBancadas").html(""),$(this).find(".modal-body #listaBancadas").removeAttr("disabled"),$(this).find(".modal-body #listaEquipReparo").html(""),$(this).find(".modal-body #listaEquipReparo").removeAttr("disabled"),$("#btnIniciarReparo").removeAttr("disabled")});var p_id_reparo=null;$("#slctListaModeloLaudo").on("change",function(e){$("#txtLaudoInservivelEquip").val($(this).val())}),$("#modalLaudoInservivelEquip").on("show.bs.modal",async function(e){$(this).find(".modal-footer #btnInservivelEquip").attr("data-equip",num_equip_reparo_atual),$(this).find(".modal-footer #btnInservivelEquip").attr("data-reparo",p_id_reparo),$(this).find(" .modal-title").html(`<i class="fas fa-ban"></i> ${num_equip_reparo_atual} - Classificar como inservível`);const a=await carregaModeloMensagem("INSERVIVEL",3);a.forEach(e=>{let a=e.mensagem_modelo_mensagem.slice(0,50)+"...";$(this).find(".modal-body #slctListaModeloLaudo").append(`<option\n            value="${e.mensagem_modelo_mensagem}"\n            >${a}</option>`)})}),$("#modalLaudoInservivelEquip").on("hide.bs.modal",function(e){$(this).find(".modal-body #slctListaModeloLaudo").html('<option\n    value="">Escolha...</option>')}),$("#btnInservivelEquip").on("click",async function(e){if(e.preventDefault(),$("#txtLaudoInservivelEquip").val().length<143)return alert("Laudo técnico muito curto!"),!1;const a=$(this);await $.ajax({method:"POST",url:base_url+"/interacao/registrar_interacao_reparo",data:{id_usuario:g_id_usuario,id_chamado:g_id_chamado,tipo:"INSERVIVEL_REPARO",id_reparo:$(this).attr("data-reparo"),num_equipamento:$(this).attr("data-equip"),txtInteracaoReparo:$("#txtLaudoInservivelEquip").val()},beforeSend:function(){a.prop("disabled","true"),a.html('<span class="spinner-border spinner-border-sm"></span> Enviando...'),$("#txtLaudoInservivelEquip").prop("disabled","true"),$("#slctListaModeloLaudo").prop("disabled","true"),$("#modalReparo").modal("hide"),$(".btn-modal-reparo").prop("disabled",!0)}}).done(e=>{0==e.error&&(Swal.fire({icon:"success",title:"Sucesso!",text:`Equipamento ${$(this).attr("data-equip")} enviado para remessa de inservíveis!`}),$("#modalLaudoInservivelEquip").modal("hide"),$("#modalReparo").modal("hide"))}),carregaChamado(g_id_chamado)}),$("#modalLaudoInservivelEquip").on("hidden.bs.modal",function(){$("#btnInservivelEquip").html('<i class="far fa-arrow-alt-circle-right"></i> Enviar</button>'),$("#txtLaudoInservivelEquip").removeAttr("disabled"),$("#slctListaModeloLaudo").removeAttr("disabled"),$("#btnInservivelEquip").removeAttr("disabled"),$("#btnEncerrarReparo").removeAttr("disabled"),$("#btnGarantiaReparo").removeAttr("disabled")});var num_equip_reparo_atual=null;$("#modalReparo").on("show.bs.modal",async function(e){$("#btnGarantiaReparo").hide(),$("#btnLaudoInservivelEquip").hide(),$("#btnEncerrarReparo").hide(),$("#btnEsperaReparo").hide(),$(".btnEsperaReparo").hide(),$("#btnJustificativaCancelamento").hide(),$("#btnLaudoGarantiaEquip").hide(),$("#btnRmEsperaReparo").hide(),$("#collapseEspera").collapse("hide"),$(this).find(".modal-footer #btnJustificativaCancelamento").prop("disabled","true"),$(this).find(".modal-footer #btnLaudoInservivelEquip").prop("disabled","true");const a=$(e.relatedTarget);p_id_reparo=a.data("reparo");const t=$(this);$(this).find(".modal-body").html(""),res=await carregaReparo(p_id_reparo),res.reparo.servicos=await carregaReparoServicos(p_id_reparo),num_equip_reparo_atual=res.reparo.num_equipamento_reparo,t.find(".modal-title").html(`<i class="fas fa-wrench"></i>\n        ${res.reparo.num_equipamento_reparo} -\n        ${res.desc_equip}\n        <small>(Reparo #${p_id_reparo})</small>`),p_id_responsavel==g_id_usuario||3===g_fila_chamado?$(this).find(".modal-footer").show():$(this).find(".modal-footer").hide(),"ABERTO"==res.reparo.status_reparo?($(this).find(".modal-footer #btnGarantiaReparo").removeAttr("disabled"),$(this).find(".modal-footer #btnEsperaReparo").removeAttr("disabled"),$(this).find(".modal-footer #btnJustificativaCancelamento").removeAttr("disabled"),$(this).find(".modal-footer #btnLaudoInservivelEquip").removeAttr("disabled"),$(this).find(".modal-footer #btnEncerrarReparo").removeAttr("disabled"),$(this).find(".modal-footer #btnLaudoInservivelEquip").attr("data-equip",res.reparo.num_equipamento_reparo),$(this).find(".modal-footer #btnLaudoInservivelEquip").attr("data-reparo",p_id_reparo),3==g_fila_chamado&&($("#btnGarantiaReparo").show(),$("#btnGarantiaReparo").show(),$("#btnGarantiaReparo").show(),$("#btnLaudoInservivelEquip").show(),$("#btnEsperaReparo").show(),$(".btnEsperaReparo").show()),$("#btnEncerrarReparo").show(),$("#btnJustificativaCancelamento").show(),$(this).find(".modal-body").html(`\n            <h5>Lista de serviços</h5>\n            <div id="conteudo-reparo-servico">\n                <div class="form-check">\n\n                </div>\n            </div>\n            ${p_id_responsavel==g_id_usuario||3===g_fila_chamado?'\n                <div class="input-group mt-3" id="divSlctListaServicoEquip">\n                    <select class="custom-select" id="slctListaServicoEquip">\n                        \n                    </select>\n                    <div class="input-group-append">\n                        <button class="btn btn-primary btn-sm" id="btn-add-servico" type="button">\n                            <i class="fas fa-plus"></i> Adicionar\n                        </button>\n                    </div>\n                </div>':""}\n        `),res.servicos=await carregaServicos(p_id_reparo,g_fila_chamado),res.reparo.servicos.forEach(e=>{1==e.realizado_reparo_servico?$("#conteudo-reparo-servico").find(".form-check").append(`\n                    <div id="check-servico-${e.id_reparo_servico}">\n                        <input class="form-check-input check-servico" onclick="desfazerReparoServico(${e.id_reparo_servico}, '${e.nome_servico}', ${e.id_servico}, ${p_id_reparo});" type="checkbox" value="${e.id_reparo_servico}" checked>\n                        <label class="form-check-label">\n                            ${e.nome_servico}\n                        </label>\n                    </div>\n                `):($("#conteudo-reparo-servico").find(".form-check").append(`\n                    <div id="check-servico-${e.id_reparo_servico}">\n                        <input class="form-check-input check-servico" id="checkbox-servico-${e.id_reparo_servico}" type="checkbox" value="${e.id_reparo_servico}">\n                        <label for="check-servico-${e.id_reparo_servico}" class="form-check-label">\n                            ${e.nome_servico}\n                        </label>\n                    </div>\n                `),$(`#checkbox-servico-${e.id_reparo_servico}`).attr("onclick",`realizaServico(${e.id_reparo_servico}, '${e.nome_servico}', ${e.id_servico})`),p_id_responsavel==g_id_usuario||3===g_fila_chamado?$(`#check-servico-${e.id_reparo_servico} > label`).append(`\n                            <span class="badge badge-danger" onclick="cancelaServico(${e.id_reparo_servico}, '${e.nome_servico}', ${e.id_servico})"><i class="fas fa-times"></i></span>\n                        `):p_id_responsavel!=g_id_usuario&&$(`#checkbox-servico-${e.id_reparo_servico}`).prop("disabled",!0))}),0===res.servicos.length?($("#slctListaServicoEquip").append('<option value="0">Não existe nenhum serviço para realizar, caso deseje adicionar consulte o administrador!</option>'),$("#slctListaServicoEquip").prop("disabled",!0),$("#btn-add-servico").prop("disabled",!0)):res.servicos.forEach(e=>{$("#slctListaServicoEquip").append(`<option value="${e.id_servico}">${e.nome_servico}</option>`)}),$("#btn-add-servico").on("click",e=>{let a={id_reparo_servico:0,id_servico:$("#slctListaServicoEquip").val(),nome:$("#slctListaServicoEquip option:selected").text()};$.ajax({url:base_url+"reparo/adicionar_reparo_chamado",type:"POST",data:{id_chamado:g_id_chamado,id_reparo:p_id_reparo,id_servico:a.id_servico},beforeSend:()=>{$("#btn-add-servico").prop("disabled",!0)}}).done(e=>{if(a.id_reparo_servico=e.id_reparo_servico,null===e)return Swal.fire({toast:!0,position:"top-end",showConfirmButton:!1,timer:3e3,timerProgressBar:!0,icon:"success",title:"Erro ao adicionar serviço!",didOpen:e=>{e.onmouseenter=Swal.stopTimer,e.onmouseleave=Swal.resumeTimer}}),!1;$("#btn-add-servico").removeAttr("disabled"),$("#conteudo-reparo-servico").find(".form-check").append(`\n                        <div id="check-servico-${a.id_reparo_servico}">\n                            <input class="form-check-input check-servico" id="checkbox-servico-${a.id_reparo_servico}" type="checkbox" value="${a.id_reparo_servico}" onclick="realizaServico(${a.id_reparo_servico}, '${a.nome}', ${a.id_servico})">\n                            <label for="check-servico-${a.id_reparo_servico}" class="form-check-label">\n                                ${a.nome}\n                                <span class="badge badge-danger" onclick="cancelaServico(${a.id_reparo_servico}, '${a.nome}', ${a.id_servico})"><i class="fas fa-times"></i></span>\n                            </label>\n                        </div>\n                    `),$(`#slctListaServicoEquip option[value='${a.id_servico}']`).remove(),0==$("#slctListaServicoEquip option").length&&($("#slctListaServicoEquip").append('<option value="0">Não existe nenhum serviço para realizar, caso deseje adicionar consulte o administrador!</option>'),$("#slctListaServicoEquip").prop("disabled",!0),$("#btn-add-servico").prop("disabled",!0))})})):"FINALIZADO"==res.reparo.status_reparo?($.ajax({url:base_url+"reparo/buscar_garantia",type:"POST",data:{id_reparo:p_id_reparo}}).done(e=>{$("#btn-laudo-garantia").remove(),null!==e&&($(this).find(".modal-body").append(`\n                    <a class="btn btn-primary" id="btn-laudo-garantia" href="${base_url}termos/${e.nome_laudo_garantia}" target="_BLANK" role="button">Laudo técnico da garantia</a>\n                `),!0)}),$.ajax({url:base_url+"reparo/buscar_equipamento_reparo",type:"POST",data:{id_reparo:p_id_reparo}}).done(e=>{"REMESSA"===e.status_equipamento_chamado||"INSERVIVEL"===e.status_equipamento_chamado?($(this).find(".modal-body").append(`\n                    <p>Este equipamento foi classificado como ${e.status_equipamento_chamado} e foi incluído na remessa \n                    <a href="${base_url}inservivel/${e.id_remessa}">#${e.id_remessa}</a></p>\n                    <a href="${base_url}inservivel/gerartermo/${e.num_equipamento_reparo}" role="button" class="btn btn-primary" target="_blank">\n                    <i class="fas fa-file-download"></i> Laudo técnico\n                    </a>\n                `),g_auto_usuario>3&&"ENCERRADO"!=status_chamado&&null!=res.reparo.id_remessa&&$(this).find(".modal-body").append(`<button class="btn btn-secondary" onclick="reverterRemessa('${e.num_equipamento_reparo}',${e.id_remessa}, ${p_id_reparo})"><i class="fas fa-redo"></i> Reverter Remessa</button>`)):"ENTREGA"===e.status_equipamento_chamado&&"ENCERRADO"!=status_chamado&&$(this).find(".modal-body").append(`<button class="btn btn-warning" onclick="cancelarEntrega('${e.num_equipamento_reparo}', ${res.reparo.id_reparo})"><i class="fas fa-redo"></i> Cancelar ENTREGA</button>`)}),$(this).find(".modal-body").html("<p>O reparo foi finalizado.</p>")):"GARANTIA"==res.reparo.status_reparo?($("#btnLaudoGarantiaEquip").show(),$("#btnJustificativaCancelamento").show(),$("#btnJustificativaCancelamento").removeAttr("disabled"),$("#btnLaudoGarantiaEquip").removeAttr("disabled"),$(this).find(".modal-body").html(`<p>O reparo foi para garantia pelo(s) seguinte(s) motivo(s):</p>\n            <p>${res.reparo.justificativa_reparo}</p>\n            `),$.ajax({url:base_url+"reparo/buscar_garantia",type:"POST",data:{id_reparo:p_id_reparo}}).done(e=>{$("#btn-laudo-garantia").remove(),null!==e&&($(this).find(".modal-body").append(`\n                    <p>Ticket da garantia: <strong>${e.ticket_garantia}</strong></p>\n                `),!0)}),$("#modalLaudoGarantiaEquip").find("#frmLaudoGarantiaEquip").off("submit").on("submit",function(e){e.preventDefault();let a=new FormData($(this)[0]);a.append("id_reparo",p_id_reparo),$.ajax({url:base_url+"reparo/registrar_laudo",dataType:"json",contentType:!1,processData:!1,method:"post",data:a,beforeSend:()=>{$("#fileLaudo").val(""),$("#btnGarantiaEquip").prop("disabled",!0)}}).done(e=>{Swal.fire({toast:!0,position:"top-end",showConfirmButton:!1,timer:3e3,timerProgressBar:!0,icon:"success",title:e.mensagem,didOpen:e=>{e.onmouseenter=Swal.stopTimer,e.onmouseleave=Swal.resumeTimer}}),$("#btnGarantiaEquip").removeAttr("disabled"),$("#modalLaudoGarantiaEquip").modal("hide"),$("#modalReparo").modal("hide"),carregaChamado(g_id_chamado)}).fail(e=>{Swal.fire({toast:!0,position:"top-end",showConfirmButton:!1,timer:3e3,timerProgressBar:!0,icon:"error",title:e.responseJSON.mensagem,didOpen:e=>{e.onmouseenter=Swal.stopTimer,e.onmouseleave=Swal.resumeTimer}}),$("#btnGarantiaEquip").removeAttr("disabled")})})):"ESPERA"==res.reparo.status_reparo?($(this).find(".modal-body").html(`<p>O reparo foi para garantia pelo(s) seguinte(s) motivo(s):</p>\n            <p>${res.reparo.justificativa_reparo}</p>\n            `),$("#btnRmEsperaReparo").show(),$("#btnRmEsperaReparo").removeAttr("disabled"),$(this).find("#btnRmEsperaReparo").off("click").on("click",async()=>{let e=await carregarBancadas(!1);Swal.fire({title:"Selecione a bancada",html:'\n                    <select id="slc-bancadas" class="form-control"> </select>\n                    ',showCancelButton:!0,confirmButtonText:"Enviar",cancelButtonText:"Cancelar",reverseButtons:!0,focusConfirm:!1,preConfirm:()=>$("#slc-bancadas").val()}).then(e=>{if(e.isConfirmed){let a=e.value;$.ajax({url:base_url+"reparo/remover_espera_reparo",type:"POST",data:{id_reparo:p_id_reparo,id_bancada:a,id_chamado:g_id_chamado,num_equip:num_equip_reparo_atual}}).done(e=>{carregaChamado(g_id_chamado),Swal.fire("Removido da espera",e.mensagem,"success"),$("#modalReparo").modal("hide")}).fail(e=>{Swal.fire("Erro","Falha ao enviar remover da espera!","error")})}}),e.forEach(e=>{1==e.status_bancada&&$("#slc-bancadas").append(`<option value="${e.id_bancada}">${e.nome_bancada}</option>`)})})):$(this).find(".modal-body").html(`<p>O reparo foi cancelado pelo(s) seguinte(s) motivo(s):</p>\n            <p>${res.reparo.justificativa_reparo}</p>\n            `),$.ajax({url:base_url+"reparo/lista_historico",type:"POST",data:{id_reparo:p_id_reparo}}).done(e=>{if(null===e)return $("#modalIniciarReparo").find(".modal-body").prepend('<div id="alerta-reparo" class="alert alert-danger" role="alert">\n                    Erro ao criar o reparo!\n              </div>'),!1;{$("#conteudo-historico-modal").empty();let a=e.reparo[0];$("#conteudo-historico-modal").prepend(`\n                <p class="border rounded p-2 my-3">\n                    <span class="badge badge-info">${a.data_inicio_reparo}</span> <strong>${a.nome_abertura_usuario}</strong> <b>iniciou</b> o reparo <b>#${a.id_reparo}</b>.\n                </p>\n            `),e.servicos.forEach(e=>{3==e.subquery?$("#conteudo-historico-modal").prepend(`\n                        <p class="border rounded p-2 my-3">\n                            <span class="badge badge-info">${e.data_reparo_servico}</span> <strong>${e.nome_abertura_usuario}</strong> ${e.nome_servico.toUpperCase()}</b>.\n                        </p>\n                    `):1==e.realizado_reparo_servico&&1==e.subquery?$("#conteudo-historico-modal").prepend(`\n                        <p class="border rounded p-2 my-3">\n                            <span class="badge badge-info">${e.data_encerramento_reparo_servico}</span> <strong>${e.nome_fechamento_usuario}</strong> <strong class="text-success">finalizou</strong> o serviço <b>${e.nome_servico}</b>.\n                        </p>\n                    `):0==e.status_reparo_servico&&1==e.subquery?$("#conteudo-historico-modal").prepend(`\n                        <p class="border rounded p-2 my-3">\n                            <span class="badge badge-info">${e.data_encerramento_reparo_servico}</span> <strong>${e.nome_fechamento_usuario}</strong> <strong class="text-danger">removeu</strong> o serviço <b>${e.nome_servico}</b>.\n                        </p>\n                    `):$("#conteudo-historico-modal").prepend(`\n                        <p class="border rounded p-2 my-3">\n                            <span class="badge badge-info">${e.data_reparo_servico}</span> <strong>${e.nome_abertura_usuario}</strong> <strong class="text-primary">adicionou</strong> o serviço <b>${e.nome_servico}</b>.\n                        </p>\n                    `)}),"CANCELADO"==a.status_reparo?$("#conteudo-historico-modal").prepend(`\n                    <p class="border rounded p-2 my-3">\n                        <span class="badge badge-info">${a.data_fim_reparo}</span> <strong>${a.nome_encerramento_usuario}</strong> <strong class="text-danger">cancelou</strong> o reparo <b>#${a.id_reparo}</b> - <b>${a.num_equipamento_reparo}</b>\n                    </p>\n                `):null!==a.data_fim_reparo&&$("#conteudo-historico-modal").prepend(`\n                    <p class="border rounded p-2 my-3">\n                        <span class="badge badge-info">${a.data_fim_reparo}</span> <strong>${a.nome_encerramento_usuario}</strong> <strong>encerrou</strong> o reparo <b>#${a.id_reparo}</b>.\n                    </p>\n                `)}})}),$("#btnEsperaReparo").on("click",async e=>{Swal.fire({title:"Tem certeza?",text:"Você não poderá reverter isso!",icon:"warning",showCancelButton:!0,confirmButtonColor:"#3085d6",cancelButtonColor:"#d33",confirmButtonText:"Sim, Coloque em espera!",cancelButtonText:"Cancelar"}).then(e=>{let a=$("#justificativaEspera").val();const t=/^[A-Za-záàâãéèêíïóôõöúçñÁÀÂÃÉÈÍÏÓÔÕÖÚÇÑ 0-9]+$/;if(e.isConfirmed){if(!t.test(a))return $("#justificativaEspera").addClass("is-invalid");$.ajax({url:base_url+"reparo/espera_reparo",type:"POST",data:{id_chamado:g_id_chamado,id_reparo:p_id_reparo,justificativa_reparo:a},beforeSend:()=>{$("#justificativaEspera").removeClass("is-invalid"),$("#btn-add-servico").prop("disabled",!0),$("#btnJustificativaCancelamento").prop("disabled",!0),$("#btnEsperaReparo").prop("disabled",!0),$("#btnEncerrarReparo").prop("disabled",!0),$("#btnLaudoInservivelEquip").prop("disabled",!0),$("#btnGarantiaReparo").prop("disabled",!0),$("#btnLaudoGarantiaEquip").prop("disabled",!0)}}).done(e=>{$("#justificativaEspera").val(""),Swal.fire({title:"Espera!",text:e.mensagem,icon:"success"}),carregaChamado(g_id_chamado),$("#modalReparo").modal("hide")}).fail(()=>{Swal.fire({toast:!0,position:"top-end",showConfirmButton:!1,timer:5e3,timerProgressBar:!0,icon:"error",text:"Falha ao colocar reparo em espera",didOpen:e=>{e.onmouseenter=Swal.stopTimer,e.onmouseleave=Swal.resumeTimer}})}),$("#btn-add-servico").prop("disabled",!1),$("#btnJustificativaCancelamento").prop("disabled",!1),$("#btnEsperaReparo").prop("disabled",!1),$("#btnEncerrarReparo").prop("disabled",!1),$("#btnLaudoInservivelEquip").prop("disabled",!1),$("#btnGarantiaReparo").prop("disabled",!1),$("#btnLaudoGarantiaEquip").prop("disabled",!1)}})}),$("#btnEncerrarReparo").on("click",function(){return $("#conteudo-reparo-servico").find(".check-servico").is(":not(:checked)")?($("#modalReparo").find(".modal-body").prepend('<div id="alerta-reparo" class="alert alert-danger" role="alert">\n                Existem serviços pendentes que impedem o encerramento do reparo!\n            </div>'),!1):0===$("#conteudo-reparo-servico").find(".check-servico").length?($("#modalReparo").find(".modal-body").prepend('<div id="alerta-reparo" class="alert alert-danger" role="alert">\n                Realize pelo menos um serviço para encerrar ou cancele o reparo!\n            </div>'),!1):($.ajax({url:base_url+"reparo/finaliza_reparo",type:"POST",data:{id_chamado:g_id_chamado,id_reparo:p_id_reparo}}).done(e=>{if(null===e)return $("#modalReparo").find(".modal-body").prepend('<div id="alerta-reparo" class="alert alert-danger" role="alert">\n                    Erro ao criar o reparo!\n                </div>'),!1;Swal.fire({toast:!0,position:"top-end",showConfirmButton:!1,timer:3e3,timerProgressBar:!0,icon:"success",title:e.mensagem,didOpen:e=>{e.onmouseenter=Swal.stopTimer,e.onmouseleave=Swal.resumeTimer}}),$("#modalReparo").modal("hide"),carregaChamado(g_id_chamado)}),void carregaChamado(g_id_chamado))}),$("#btnGarantiaEquip").on("click",()=>{let e=$("#txtTicketGarantia").val(),a=$("#txtJustificativaGarantia").val();e&&a&&$.ajax({url:base_url+"reparo/acionar_garantia",type:"POST",dataType:"json",data:{id_reparo:p_id_reparo,ticket_garantia:e,justificativa_reparo:a},beforeSend:()=>{$("#txtTicketGarantia").val(""),$("#txtJustificativaGarantia").val(""),$("#btnGarantiaEquip").prop("disabled",!0)}}).done(e=>{Swal.fire({toast:!0,position:"top-end",showConfirmButton:!1,timer:3e3,timerProgressBar:!0,icon:"success",title:e.mensagem,didOpen:e=>{e.onmouseenter=Swal.stopTimer,e.onmouseleave=Swal.resumeTimer}}),$("#btnGarantiaEquip").removeAttr("disabled"),$("#modalGarantiaReparo").modal("hide"),$("#modalReparo").modal("hide"),carregaChamado(g_id_chamado)})}),$("#frmIniciarReparo").on("submit",e=>{e.preventDefault();const a=$("#listaEquipReparo").val(),t=$("#listaBancadas").val();let o=$("#listaBancadas :selected").html();const i=o.trim();$.ajax({url:base_url+"reparo/criar_reparo",type:"POST",data:{id_chamado:g_id_chamado,id_bancada:t,num_equipamento:a,nome_bancada:i},beforeSend:function(){$("#btnIniciarReparo").prop("disabled","true"),$("#listaBancadas").prop("disabled","true"),$("#listaEquipReparo").prop("disabled","true")}}).done(e=>{if(null===e)return $("#modalIniciarReparo").find(".modal-body").prepend('<div id="alerta-reparo" class="alert alert-danger" role="alert">\n                Erro ao criar o reparo!\n              </div>'),!1;$("#modalIniciarReparo").find(".modal-body").prepend(`<div id="alerta-reparo" class="alert alert-success" role="alert">\n                    ${e.mensagem}\n                </div>`),carregaChamado(g_id_chamado)})}),$("#btnCancelarReparo").on("click",async e=>{e.preventDefault();const a=$(this),t=$("#txtJustificativaCancelamento").val();if(t.length<5)return Swal.fire({toast:!0,position:"top-end",showConfirmButton:!1,timer:3e3,timerProgressBar:!0,icon:"error",text:"Texto muito curto!",didOpen:e=>{e.onmouseenter=Swal.stopTimer,e.onmouseleave=Swal.resumeTimer}}),!1;var o=null;res=await carregaReparo(p_id_reparo),"ABERTO"==res.reparo.status_reparo&&(res.reparo.status_reparo="REPARO"),await $.ajax({method:"POST",url:base_url+"reparo/cancelar_reparo",data:{id_reparo:p_id_reparo,texto_justificativa:t,tipo_servico:res.reparo.status_reparo},beforeSend:()=>{a.prop("disabled","true")}}).done(e=>{o=e,Swal.fire({toast:!0,position:"top-end",showConfirmButton:!1,timer:3e3,timerProgressBar:!0,icon:"success",title:"Reparo cancelado com sucesso!",didOpen:e=>{e.onmouseenter=Swal.stopTimer,e.onmouseleave=Swal.resumeTimer}}),a.removeAttr("disabled")}),1==o&&($("#modalJustificativaCancelamento").modal("hide"),$("#modalReparo").modal("hide"),$("#txtJustificativaCancelamento").val("")),carregaChamado(g_id_chamado)}),$("#painel-inservivel").jsGrid({width:"100%",height:"auto",autoload:!0,inserting:!1,editing:!1,sorting:!0,paging:!1,filtering:!0,loadMessage:"Carregando...",noDataContent:"(vazio)",controller:{loadData:function(e){let a=$("#painel-inservivel").data("JSGrid").data;return e.numero_equipamento||e.descricao_equipamento||e.nome_local||e.texto_interacao||e.id_chamado?$.grep(a,function(a){return(!e.numero_equipamento||a.numero_equipamento.indexOf(e.numero_equipamento)>-1)&&(!e.descricao_equipamento||a.descricao_equipamento.indexOf(e.descricao_equipamento)>-1)&&(!e.nome_local||a.nome_local.indexOf(e.nome_local)>-1)&&(!e.texto_interacao||a.texto_interacao.indexOf(e.texto_interacao)>-1)}):$.ajax({url:base_url+"listar_detalhado/"+$(location).attr("pathname").split("/")[2],dataType:"json"}).done(function(e){e.sort(function(e,a){return e.numero_equipamento-a.numero_equipamento}),$("#painel-inservivel").jsGrid("option","data",e),$("#realizar-entrega").prop("disabled",!1),$("#btn-impressao").prop("disabled",!1)})}},fields:[{type:"checkbox",title:"",filtering:!1,width:5,align:"center",itemTemplate:function(e,a){return`<input type="checkbox" id="checkbox_${a.numero_equipamento} value="${a.numero_equipamento}" name="checkbox_inservivel">`}},{name:"numero_equipamento",type:"text",filtering:!0,title:"Nº equipamento"},{name:"descricao_equipamento",type:"text",filtering:!0,title:"Descrição"},{name:"nome_local",type:"text",filtering:!0,title:"Local"},{name:"texto_interacao",type:"text",title:"Laudo",width:180},{name:"id_chamado",type:"text",title:"Nº chamado",filtering:!1,width:40,align:"center",itemTemplate:function(e){return`<a href=${base_url}chamado/${e} target="blank">#${e}</a>`}},{type:"control",deleteButton:!1,editButton:!1}]}),$("#fechar_lista").click(function(){$.ajax({url:`${base_url}inservivel/fecharRemessa`,type:"POST",async:!0,data:{id_remessa:$(location).attr("pathname").split("/")[2]},success:function(){window.location.href=`${base_url}/inservivel`},error:function(e){alert(e.responseJSON.mensagem)}})}),$("#btn-impressao").click(function(){let e=$("input[name='checkbox_inservivel']:checked");if(0==e.length)alert("Nenhum patrimônio selecionado!");else{let a=[];e.each(function(){let e=$(this).closest("tr"),t=$("#painel-inservivel").jsGrid("option","data")[e.index()];a.push(t)}),a.forEach(function(e){linha=`<tr>\n                <td>${e.numero_equipamento}</td>\n                <td>${e.descricao_equipamento}</td>\n                <td class="text-left">${e.nome_local}</td>\n                <td class="text-left">${e.texto_interacao}</td>\n            </tr>`,tableBody=$("table #tbody-impressao"),tableBody.append(linha)}),window.print(),$("table #tbody-impressao td").remove()}}),$(document).ready(function(){$("#realizar-entrega").click(function(){$(".custom-control-input").on("click",function(){$("#formEntregaInservivel").empty(),$("#button-submit-remessa").remove();let e=null;$("#rdSim").is(":checked")?($("#formEntregaInservivel").append('\n                    <div class="form-group">\n                        <div class="mb-3">\n                            <label for="termo">Termo de entrega assinado</label>\n                            <input type="file" class="form-control-file" id="termo-entrega" name="termo_remessa" accept="application/pdf" required>\n                        </div>\n                        <div class="mb-3" id="input-nome-recebedor">\n                            <label for="nome_recebedor">Nome do recebedor</label>\n                            <input type="text" class="form-control" id="nome-recebedor-remessa">\n                            <div class="invalid-feedback">\n                                Por favor, insira um nome válido. Certifique-se de utilizar apenas caracteres alfabéticos e verifique se a formatação está correta.\n                            </div>\n                        </div>\n                        <div class="mb-3" id="input-data-entrega">\n                            <label for="data_entrega">Data de recebimento no almoxarifado</label>\n                            <input type="date" class="form-control" id="data-recebimento" required>\n                            <div class="invalid-feedback">\n                                Data fora do prazo permitido. Por favor, entre em contato com o administrador para obter assistência.\n                            </div>\n                        </div>\n                    </div>\n                '),e='<div class="text-right"><button type="submit" class="btn btn-success" id="button-submit-remessa"><i class="fas fa-check"></i> Registrar entrega</button></div>'):($("#formEntregaInservivel").append('\n                    <div class="form-group">\n                        <div class="mb-3">\n                            <h6>Selecione os equipamentos que voltaram</h6>\n                            <input type="checkbox" class="mr-2" id="selecionar_todos">\n                            <label for="selecionar_todos">Selecionar todos equipamentos</label>\n                            <div id="equipamentos-remessa"></div>\n                        </div>\n                    </div>\n                '),$("#painel-inservivel tbody tr").each(function(){let e={};$(this).find("td").each(function(a,t){e["coluna"+a]=$(t).text()}),$("#equipamentos-remessa").append(`\n                        <input type=checkbox value="${e.coluna1}" class="checkbox-falha-entrega-remessa mr-2" id="checkbox-falha-entrega-remessa-${e.coluna1}">\n                        <label for="checkbox-falha-entrega-remessa-${e.coluna1}">${e.coluna1} - ${e.coluna2}</label><br>\n                    `)}),e='<div class="text-right"><button type="submit" class="btn btn-danger" id="button-submit-remessa"><i class="fas fa-times-circle"></i> Registrar falha de entrega</button></div>',$("#selecionar_todos").click(function(){$("#selecionar_todos").is(":checked")?$(".checkbox-falha-entrega-remessa").each(function(){$(this).prop("disabled",!0),$(this).prop("checked",!0)}):$(".checkbox-falha-entrega-remessa").each(function(){$(this).prop("checked",!1),$(this).prop("disabled",!1)})})),$("#formEntregaInservivel").append(e)})})}),$("#frm-remessa-entrega").on("submit",function(e){e.preventDefault();let a=new FormData($(this)[0]),t=!1;if($("#rdSim").is(":checked")){let e=/^[a-zA-ZÀ-ÖØ-öø-ÿ\s']+$/,t=$("#nome-recebedor-remessa").val(),o=$("#data-recebimento").val(),i=!1,r=($("#termo-entrega").val(),new Date(o)),n=new Date,s=new Date;s.setMonth(n.getMonth()-1),r>=n&&"Invalid Date"!=r?(i=!0,$("#data-recebimento").addClass("is-invalid")):4==g_auto_usuario||r>s?($("#data-recebimento").removeClass("is-invalid"),
$("#data-recebimento").addClass("is-valid")):(i=!0,$("#data-recebimento").addClass("is-invalid")),e.test(t)?($("#nome-recebedor-remessa").removeClass("is-invalid"),$("#nome-recebedor-remessa").addClass("is-valid")):(i=!0,$("#nome-recebedor-remessa").addClass("is-invalid")),a.append("nome_recebedor",t),a.append("data_recebimento",o)}else{let e=[];if(t=!0,$("#selecionar_todos").is(":checked"))a.append("equipamentos",null);else{if($(".checkbox-falha-entrega-remessa:checked").each(function(){e.push($(this).val())}),e.length>5)return alert("O limite máximo de equipamentos é de 5");if(!e.length||$(".checkbox-falha-entrega-remessa").length==e.length)return alert("Por favor, selecione pelo menos um equipamentos ou todos.");a.append("equipamentos",JSON.stringify(e))}}a.append("erro_remessa",t),a.append("id_remessa",$(location).attr("pathname").split("/")[2]),$.ajax({url:base_url+"/inservivel/registrarEntrega",dataType:"json",contentType:!1,processData:!1,method:"post",data:a,error:function(e,a,t){console.error("Erro na solicitação AJAX:",a,t)},success:function(){let e="";e=$("#rdNao").is(":checked")?$("#selecionar_todos").is(":checked")?"Falha registrada!\nA remessa permanecerá aberta com estado de erro!":"Os equipamentos selecionados foram alocados na remessa seguinte.":"Entrega registrada com sucesso!",alert(e),window.location.reload()}})});let dados=[];if(window.location.href.includes("inservivel")){$.ajax({url:`${base_url}inservivel/listarRemessas`,type:"GET"}).done(function(e){dados=e,exibirDados()});const e=10;let a=1;function exibirDados(){const t=$("#tabela-inservivel tbody");t.empty();const o=Math.ceil(dados.length/e);a=Math.max(1,Math.min(a,o));const i=(a-1)*e,r=Math.min(i+e,dados.length);a<1&&(a=1);const n=dados.slice(i,r);n.forEach(e=>{let a={};e.data_abertura=null==e.data_abertura?"":e.data_abertura,e.data_fechamento=null==e.data_fechamento?"":e.data_fechamento,e.data_entrega=null==e.data_entrega?"":e.data_entrega,"string"!=typeof e.pool_equipamentos&&null!=e.pool_equipamentos||(e.pool_equipamentos=""==e.pool_equipamentos||null==e.pool_equipamentos?0:e.pool_equipamentos.split("::").length),a=e.data_entrega?{mensagem:"Entregue",class:"active"}:1==e.falha_envio?{mensagem:"Erro",class:"warning"}:e.data_fechamento?{mensagem:"Fechada",class:"danger"}:{mensagem:"Aberta",class:"success"};const o=$(`\n                <tr class='table-${a.class}' onclick="location.href='${base_url}inservivel/${e.id_remessa_inservivel}'" style="cursor: pointer;">\n                    <td><strong>${e.id_remessa_inservivel}</strong></td>\n                    <td><strong>${e.divisao_remessa}</strong></td>\n                    <td>${e.pool_equipamentos}</td>\n                    <td>${e.data_abertura}</td>\n                    <td>${e.data_fechamento}</td>\n                    <td>${e.data_entrega}</td>\n                    <td>${e.nome_usuario}</td>\n                    <td><strong>${a.mensagem}</strong></td>\n                </tr>\n            `);t.append(o)}),$("#paginaAtual").text(a)}function proximaPagina(){const t=Math.ceil(dados.length/e);a<t&&(a++,exibirDados())}function paginaAnterior(){a>1&&(a--,exibirDados())}exibirDados()}