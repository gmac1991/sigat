function painel(a){table_painel=$("#tblPainel").DataTable({autoWidth:!0,pageLength:25,columnDefs:[{},{width:"10%",targets:4,render:$.fn.dataTable.render.moment("YYYY-MM-DD HH:mm:ss","DD/MM/YYYY H:mm:ss")}],language:{decimal:"",emptyTable:"Sem chamados :)",info:"Mostrando _START_ a _END_ de _TOTAL_ chamados",infoEmpty:"Mostrando 0 a 0 de 0 chamados",infoFiltered:"(filtrado de _MAX_ chamados)",infoPostFix:"",thousands:".",lengthMenu:"Mostrando _MENU_ chamados",loadingRecords:"Carregando...",processing:"Processando...",search:"Busca:",zeroRecords:"Sem resultados!",paginate:{first:"Primeiro",last:"Último",next:"Próximo",previous:"Anterior"}},ajax:base_url+"chamado/listar_chamados_painel/"+a,order:[4,"asc"],processing:!0,drawCallback:function(a){var e=null;$(".PopoverPainel").each(function(){e=$(this).attr("data-chamado"),$.ajax({type:"post",url:base_url+"json/texto_ultima_interacao",data:{id_chamado:e},dataType:"json",success:a=>{$(this).popover({content:a.nome_usuario+a.texto_interacao,trigger:"focus",placement:"left",html:!0})}})})}})}function mudaFila(a){$("#tblPainel").DataTable().ajax.url(base_url+"chamado/listar_chamados_painel/"+a).load()}function painelEncerrados(){table_encerrados=$("#tblEncerrados").DataTable({autoWidth:!0,language:{decimal:"",emptyTable:"Sem resultados.",info:"Mostrando _START_ a _END_ de _TOTAL_ chamados",infoEmpty:"Mostrando 0 a 0 de 0 chamados",infoFiltered:"(filtrado de _MAX_ chamados)",infoPostFix:"",thousands:".",lengthMenu:"Mostrando _MENU_ chamados",loadingRecords:"Carregando...",processing:"Processando...",search:"Busca:",zeroRecords:"Sem resultados!",paginate:{first:"Primeiro",last:"Último",next:"Próximo",previous:"Anterior"}},ajax:base_url+"chamado/listar_encerrados_painel/",order:[],processing:!0})}function triagem(){table_triagem=$("#tblTriagem").DataTable({autoWidth:!1,pageLength:50,columnDefs:[{width:"10%",targets:2,render:$.fn.dataTable.render.moment("YYYY-MM-DD HH:mm:ss","DD/MM/YYYY H:mm:ss")}],language:{decimal:"",emptyTable:"Sem chamados :)",info:"Mostrando _START_ a _END_ de _TOTAL_ chamados",infoEmpty:"Mostrando 0 a 0 de 0 chamados",infoFiltered:"(filtrado de _MAX_ chamados)",infoPostFix:"",thousands:".",lengthMenu:"Mostrando _MENU_ chamados",loadingRecords:"Carregando...",processing:"Processando...",search:"Busca:",zeroRecords:"Sem resultados!",paginate:{first:"Primeiro",last:"Último",next:"Próximo",previous:"Anterior"}},ajax:base_url+"triagem/listar_triagem/",order:[]})}async function buscaEquipamentos(a,e,t,o=!1,i=!1,r=!1){var n=[];$("#btnRegistrarInteracao").removeAttr("disabled"),await $.ajax({url:base_url+"json/equipamentos_pendentes",data:{id_chamado:a,espera:i},type:"POST",async:!0,dataType:"json",success:function(a){a.filas.forEach(function(o){$("select[name=id_fila]").append('<option value="'+o.id_fila+'" >'+o.nome_fila+"</option>"),1==t?$("option[value="+a.id_fila+"]").prop("selected","true"):$("#slctFila option[value="+e+"]").remove()}),null!=a.equipamentos&&a.equipamentos.forEach(function(a){n.push(a.num_equipamento_chamado)})}}),n.length>0?($("#divEquipamentos").empty(),1==t?($("#divEquipamentos").prepend("<p>Marque os equipamentos que foram finalizados:</p>"),o||$("#divEquipamentos p").append(" <small><strong>(opcional)</strong></small>")):0==i?$("#divEquipamentos").prepend("<p>Marque os equipamentos que serão deixados em espera:</p>"):$("#divEquipamentos").prepend("<p>Marque os equipamentos que sairão da espera:</p>"),$("#divEquipamentos").append('<input id="chkTudo" type="checkbox" value="#" onclick="$(\'input:checkbox\').not(this).prop(\'checked\', this.checked)"><label class="mr-2" for="chkTudo">&nbsp;Todos</label>'),n.forEach(function(a){$("#divEquipamentos").append('<input class="chkPatri" type="checkbox" id="'+a+'" value="'+a+'"><label class="mr-2" for="'+a+'">&nbsp;'+a+"</label>")})):1==i&&($("#divEquipamentos").prepend("<p>Não existem equipamentos em espera!</p>"),r||$("#btnRegistrarInteracao").prop("disabled","true"))}function verificaTipo(a,e){switch($("select[name=id_fila]").empty(),$("#slctTipo").val()){case"ATENDIMENTO":buscaEquipamentos(e,a,!0,!1,!1),$("#divEquipamentos").show(),$("#divFila").show(),$("#slctFila").attr("disabled",!0);break;case"ALT_FILA":buscaEquipamentos(e,a,!1,!1,!1,!0),$("#divFila").show(),$("#divEquipamentos").hide(),$("#slctFila").attr("disabled",!1);break;case"OBSERVACAO":$("#divEquipamentos").hide(),$("#divFila").hide(),$("#slctFila").attr("disabled",!0),$("#btnRegistrarInteracao").removeAttr("disabled");break;case"INSERVIVEL":3==a?(buscaEquipamentos(e,a,!0,!0),$("#divEquipamentos").show(),$("#divFila").show(),$("#slctFila").attr("disabled",!0)):($("#divEquipamentos").show(),$("#divEquipamentos").html("Opção disponível somente na fila <strong>Manutenção de Hardware</strong><br>"),$("#btnRegistrarInteracao").prop("disabled","true"),$("#divFila").hide());break;case"ESPERA":buscaEquipamentos(e,a,!1),$("#divEquipamentos").show(),$("#divFila").hide(),$("#slctFila").attr("disabled",!0);break;case"REM_ESPERA":buscaEquipamentos(e,a,!1,!1,!0),$("#divEquipamentos").show(),$("#divFila").hide(),$("#slctFila").attr("disabled",!0)}}function criaFormRegistro(a,e){var t='<div class="row"><div class="col"><label for="tipo">Tipo</label><select class="form-control" name="tipo" id="slctTipo" onchange="verificaTipo('+e+","+a+')"></select></div></div><div class="row" id="divFila"><div class="col"><label for="id_fila">Fila</label><select class="form-control" name="id_fila" id="slctFila"></select></div></div><div class="row mt-3"><div class="col"><div id="divEquipamentos"></div></div></div><div class="row mb-3"><div class="col"><textarea name="txtInteracao"></textarea></div></div><input type="hidden" name="id_chamado" value="'+a+'"/><input type="hidden" name="id_fila_ant" value="'+e+'"/>';return t}async function carregaHistorico(a){var e=null;return await $.ajax({url:base_url+"chamado/historico/"+a,type:"GET",success:function(a){e=a}}),e}async function carregaChamado(a,e){document.title="Chamado #"+a+" - SIGAT",p_id_responsavel=null,$("#spnStatusChamado").fadeIn();var t=await carregaHistorico(a);$("#historico").html(t),$("#tblEquipamentosChamado").jsGrid({height:"auto",width:"100%",inserting:!1,editing:!1,autoload:!0,invalidMessage:"Dados inválidos inseridos!",loadMessage:"Aguarde...",deleteConfirm:"Tem certeza?",noDataContent:"Vazio",onInit:function(a){tblEquipsChamado=a.grid},onItemUpdating:function(a){item_antigo=null,item_antigo=a.previousItem},fields:[{name:"num_equipamento",title:"ID",type:"text",readOnly:!0,validate:["required",{validator:"pattern",param:/^[a-zA-Z0-9]+$/,message:"Atenção!\nCaracteres permitidos:\nA-Z, a-z e 0-1"}]},{name:"descricao_equipamento",type:"text",readOnly:!0,title:"Descrição",validate:["required",{validator:"pattern",param:/^[a-zA-Z0-9\s]+$/,message:"Atenção!\nCaracteres permitidos:\nA-Z, a-z e 0-1"}]},{name:"tag_equipamento",type:"text",align:"center",inserting:!1,editing:!1,title:"Tag",validate:[{validator:"pattern",param:/^[a-zA-Z0-9]+$/,message:"Atenção!\nCaracteres permitidos:\nA-Z, a-z e 0-1"}]},{name:"status_equipamento_chamado",title:"Status",width:50,align:"center"},{type:"control",editButton:!1,deleteButton:!1}],controller:{loadData:function(){return $.ajax({url:base_url+"listar_equips_chamado/"+g_id_chamado,dataType:"json",method:"get"})},updateItem:async function(e){var t=$.Deferred(),o=null,i=e.num_equipamento.replace(/\s+/g,"");return await $.ajax({url:base_url+"json/status_equipamento",dataType:"json",method:"post",data:{e_status:i}}).done(function(a){o=a}),null!==o&&parseInt(o.id_chamado)!==g_id_chamado?(alert("O item "+i+" já está em atendimento!\nChamado: "+o.id_chamado+"\n"+o.ticket_chamado),t.reject(),t.promise()):$.ajax({url:base_url+"edit_equip_chamado",dataType:"json",method:"post",data:{item:e,g_id_chamado:g_id_chamado,item_antigo:item_antigo},success:async function(){var e=await carregaHistorico(a);$("#historico").html(e),carregaChamado(a)}})},insertItem:async function(e){var t=$.Deferred(),o=null,i=e.num_equipamento.replace(/\s+/g,"");return await $.ajax({url:base_url+"json/status_equipamento",dataType:"json",method:"post",data:{e_status:i}}).done(function(a){o=a}),null!==o?(alert("O item "+i+" já está em atendimento!\nChamado: "+o.id_chamado+"\n"+o.ticket_chamado),t.reject(),t.promise()):$.ajax({url:base_url+"add_equip_chamado",dataType:"json",method:"post",data:{item:e,g_id_chamado:g_id_chamado},success:async function(){var e=await carregaHistorico(a);$("#historico").html(e),carregaChamado(a)}})},deleteItem:async function(e){var t=$.Deferred(),o=null,i=e.num_equipamento.replace(/\s+/g,"");return await $.ajax({url:base_url+"json/status_equipamento",dataType:"json",method:"post",data:{e_status:i}}).done(function(a){o=a}),"ABERTO"===o.status_equipamento_chamado?$.ajax({url:base_url+"del_equip_chamado",dataType:"json",method:"post",data:{item:e,g_id_chamado:g_id_chamado},success:async function(){var e=await carregaHistorico(a);$("#historico").html(e),carregaChamado(a)}}):(alert("Operação não permitida!\nO item "+i+" já foi alterado neste chamado!"),t.reject(),t.promise())}}}),$("#botoesAtendimento").html(""),$("#btnBloquearChamado").removeAttr("disabled"),botoes="",$("#botoesChamado hr").hide();var o=[];await $.ajax({url:base_url+"json/chamado",dataType:"json",async:!0,data:{id_chamado:a},success:function(a){$("input[name=fila]").val(a.nome_fila_chamado),$("input[name=resumo]").val(a.resumo_chamado),$("input[name=complemento]").val(a.complemento_chamado),$("input[name=data_chamado]").val(a.data_chamado),$("input[name=status]").val(a.status_chamado),$("input[name=nome_solicitante]").val(a.nome_solicitante_chamado),$("input[name=telefone]").val(a.telefone_chamado),$("input[name=nome_local]").val(a.nome_local),$("input[name=id_fila_ant]").val(a.id_fila);var e=null;e=a.telefone_chamado.length>4?"0"+a.telefone_chamado:a.telefone_chamado,$("#sipLink").attr("href","sip:"+e),null==a.id_responsavel?$("select[name=id_responsavel]").empty():(p_id_responsavel=a.id_responsavel,$("select[name=id_responsavel]").html('<option value="'+a.id_responsavel+'">'+a.nome_responsavel+"</option>")),fila_atual=a.id_fila,entrega=a.entrega_chamado,status_chamado=a.status_chamado;for(var t=0;t<a.status_equipamentos.length;++t)o.push(a.status_equipamentos[t].status_equipamento_chamado);a.id_responsavel==g_id_usuario&&(tblEquipsChamado.option("editing",!0),tblEquipsChamado.option("inserting",!0),tblEquipsChamado.fieldOption(4,"editButton",!0),tblEquipsChamado.fieldOption(4,"deleteButton",!0),tblEquipsChamado.fieldOption(1,"readOnly",!1),tblEquipsChamado.fieldOption(0,"readOnly",!1),tblEquipsChamado.fieldOption(0,"editing",!1),tblEquipsChamado.fieldOption(0,"inserting",!0),3==a.id_fila&&tblEquipsChamado.fieldOption(2,"editing",!0),g_auto_usuario>3&&(tblEquipsChamado.fieldOption(1,"readOnly",!1),tblEquipsChamado.fieldOption(4,"deleteButton",!0))),"ABERTO"!=a.status_chamado?($("#btnEditarChamado").hide(),$("#btnDesbloquearChamado").hide(),$("#botoesChamado hr").hide(),tblEquipsChamado.option("editing",!1),tblEquipsChamado.option("inserting",!1),tblEquipsChamado.fieldOption(4,"editButton",!1),tblEquipsChamado.fieldOption(4,"deleteButton",!1),tblEquipsChamado.fieldOption(0,"readOnly",!0),tblEquipsChamado.fieldOption(1,"readOnly",!0),tblEquipsChamado.fieldOption(2,"editing",!1)):((g_auto_usuario>=3&&null!=a.id_responsavel||a.id_responsavel==g_id_usuario)&&($("#btnDesbloquearChamado").show(),$("#btnEditarChamado").show(),$("#botoesChamado hr").show()),null==a.id_responsavel&&g_auto_usuario>=3&&($("#btnEditarChamado").show(),$("#btnDesbloquearChamado").hide(),$("#botoesChamado hr").show()),null==a.id_responsavel&&g_auto_usuario<=2&&($("#btnBloquearChamado").show(),$("#btnEditarChamado").hide(),$("#btnDesbloquearChamado").hide(),$("#botoesChamado hr").show()),null==a.id_responsavel&&g_auto_usuario>=3&&($("#btnBloquearChamado").show(),$("#btnEditarChamado").show(),$("#btnDesbloquearChamado").hide(),$("#botoesChamado hr").show()),null!=a.id_responsavel&&g_auto_usuario>=3&&($("#btnBloquearChamado").hide(),$("#btnEditarChamado").show(),$("#btnDesbloquearChamado").show(),$("#botoesChamado hr").show()),g_id_usuario==a.id_responsavel&&g_auto_usuario<=2&&($("#btnBloquearChamado").hide(),$("#btnEditarChamado").show()))}}),g_auto_usuario>=3&&1==g_auto_usuario_enc&&"FECHADO"==status_chamado&&(botoes='<button id="btnEncerrarChamado" onclick="encerrarChamado()" class="btn btn-success"><i class="far fa-check-circle"></i> Encerrar chamado</button>');for(var i=0;i<o.length;++i)if(p_id_responsavel==g_id_usuario&&("ABERTO"==o[i]||"ESPERA"==o[i]||"FALHA"==o[i]||"ENTREGA"==o[i])){botoes='<button type="button" id="btnModalRegistro" class="btn btn-primary" data-toggle="modal" data-target="#modalRegistro" data-chamado="'+a+'"><i class="fas fa-asterisk"></i> Nova Ação</button> ';break}1==entrega&&p_id_responsavel==g_id_usuario&&"ABERTO"==status_chamado&&(botoes=botoes+'<button type="button" id="btnModalRegistroEntrega" class="btn btn-success" data-toggle="modal" data-chamado="'+a+'" data-target="#modalRegistroEntrega"><i class="fas fa-file-signature"></i> Registrar Entrega</button> <a href="'+base_url+"chamado/gerar_termo/"+a+'" id="baixarTermoEntrega" role="button" class="btn btn-info"><i class="fas fa-file-download"></i> Termo de Entrega</a> <a href="'+base_url+"chamado/gerar_termo_resp/"+ +a+'" id="baixarTermoResp" role="button" class="btn btn-info"><i class="fas fa-file-download"></i> Termo de Responsabilidade</a>'),$("#botoesAtendimento").html(botoes),$("#spnStatusChamado").fadeOut()}function removeInteracao(a,e){$("#botoesAtendimento").html(""),$.ajax({url:base_url+"interacao/remover_interacao",type:"POST",data:{id_interacao:a,id_chamado:g_id_chamado,id_usuario:g_id_usuario,auto_usuario:g_auto_usuario},beforeSend:function(){$("#btnDesfazer").prop("disabled","true")},success:function(){atualizaInteracoes(e),carregaChamado(e),tblEquipsChamado.loadData()},error:function(){$("#btnDesfazer").removeAttr("disabled"),alert("Operação não permitida!")}})}function atualizaInteracoes(a){$.post(base_url+"json/interacoes",{id:a}).done(function(a){$("#interacoes").html(a)})}function verificaEntrega(){1==$("input[name=confirmaEntrega]:checked").val()?($("#btnRegistrarEntrega").attr("class","btn btn-success"),$("#divEntrega").show(),$("#divFalhaEntrega").hide(),$("#divErroEntrega").hide(),$("#btnRegistrarEntrega").show(),$("#btnRegistrarEntrega span").html(" Registrar Entrega")):($("#divEntrega").hide(),$("#divFalhaEntrega").show(),$("#divErroEntrega").show(),$("#btnRegistrarEntrega").show(),$("#txtFalhaEntrega").summernote({toolbar:[["style",["bold","italic","underline","clear"]],["fontsize",["fontsize"]],["color",["color"]],["para",["ul","ol","paragraph"]],["insert",["link","picture","video"]]],height:200,lang:"pt-BR",dialogsInBody:!0,disableDragAndDrop:!0}),1==$("#slcErroEntrega").val()?($("#btnRegistrarEntrega span").html(" Registrar Falha de Entrega"),$("#btnRegistrarEntrega").attr("class","btn btn-danger")):($("#btnRegistrarEntrega span").html(" Registrar Tentativa de Entrega"),$("#btnRegistrarEntrega").attr("class","btn btn-success"),$("#txtFalhaEntrega").hide()))}function encerrarChamado(){var a=$("#btnEncerrarChamado");g_auto_usuario>=3&&confirm("Deseja realmente encerrar? Isso não poderá ser desfeito!")&&$.ajax({type:"post",url:base_url+"chamado/encerrar_chamado",data:{id_chamado:g_id_chamado,id_usuario:g_id_usuario},beforeSend:function(){a.prop("disabled","true")},success:function(){atualizaInteracoes(g_id_chamado),carregaChamado(g_id_chamado,!0)},error:function(){a.removeAttr("disabled"),alert("Operação não permitida!")}})}async function carregaTriagem(a){document.title="Triagem #"+a+" - SIGAT";var e=[];$("#linhaInfoTriagem").hide(),await $.ajax({url:base_url+"json/triagem",dataType:"json",async:!0,data:{id_triagem:a},success:function(t){1==t.agrupamento&&($("#header_triagem").after('<div class="alert alert-info" role="alert"><p class="mb-0"><i class="fas fa-info-circle"></i> Já existe um <a target="_blank" href="'+base_url+"chamado/"+t.chamado.id_chamado+'" class="alert-link">chamado aberto<sup><i class="fas fa-external-link-square-alt"></i></sup></a> para este ticket! Caso seja feita a importação, as novas informações serão agrupadas nele.</p></div>'),agrupamento=!0,$("#linhaInfoTriagem").html("")),$("#linhaInfoTriagem").show(),$("input[name=nome_solicitante]").val(t.triagem.nome_solicitante_triagem),$("input[name=id_triagem]").val(a),t.anexos_otrs.length>0&&t.anexos_otrs.forEach(function(a){e.push({id_anexo_otrs:a.id_anexo_otrs,nome_arquivo_otrs:a.nome_arquivo_otrs})})}}),verificaAutoEquip(),$("#tblAnexos").jsGrid("option","data",e)}function uniq_fast(a){for(var e={},t=[],o=a.length,i=0,r=0;r<o;r++){var n=a[r];1!==e[n]&&(e[n]=1,t[i++]=n)}return t}async function verificaStatusEquip(a){return out=null,await $.ajax({method:"post",url:base_url+"json/status_equipamento",data:{e_status:a}}).done(function(a){out=a}),out}async function verificaDescEquip(a){return out=null,await $.ajax({method:"post",url:base_url+"json/desc_equipamento/"+a}).done(function(a){""!==a&&(out=a)}),out}async function verificaAutoEquip(){var a=[],e=[],t=[];$("#btnValidaEquip").prop("disabled","true"),$("#pbEquips").css("width","0%");var o="";let r=await fetch(base_url+"triagem/descricao/"+g_id_triagem);if(r.ok?o=await r.text():console.log("HTTP-Error: "+r.status),agrupamento){var n=o.match(/<div class="diff">(.*?)<\/div>/g),s=null;n.forEach(function(a){s+=a.match(/<div class="diff">(.*?)<\/div>/g)}),a=s.match(patrimonio_regex),confirmado=!0}else a=o.match(patrimonio_regex);if(null!==a){if(a.length>0){for(a=uniq_fast(a),percentage=100/a.length,total_percentage=0,i=0;i<a.length;i++){var d=await verificaStatusEquip(a[i]);null!==d&&"ATENDIDO"!==d.status_equipamento_chamado&&t.push({"Número":a[i],Status:d.status_equipamento_chamado,ID:d.id_chamado,Ticket:d.ticket_chamado});var l=await verificaDescEquip(a[i]);e.push({"Número":a[i],"Descrição":l.descricao}),total_percentage+=percentage,$("#pbEquips").css("width",total_percentage+"%")}$("#tblEquips").jsGrid("option","data",e),g_equips=e,$("#btnValidaEquip").removeAttr("disabled"),$("#btnLoteEquip").removeAttr("disabled")}}else $("#btnValidaEquip").removeAttr("disabled"),$("#btnLoteEquip").removeAttr("disabled")}var timeout,listaVerificada=!1;const url="https://sistemas.sorocaba.sp.gov.br/acesso_equipamento/api/patrimonio/",patrimonio_regex=/\b[1-9]\d{5}\b/g;var toggle=0,fila_atual=null,p_equips=[,];(function(a){"use strict";"function"==typeof define&&define.amd?define(["jquery"],function(e){return a(e,window,document)}):"object"==typeof exports?module.exports=function(e,t){return e||(e=window),t||(t="undefined"!=typeof window?require("jquery"):require("jquery")(e)),a(t,e,e.document)}:a(jQuery,window,document)})(function(a,e,t){a.fn.dataTable.render.moment=function(a,t,o){return 1===arguments.length?(o="en",t=a,a="YYYY-MM-DD"):2===arguments.length&&(o="en"),function(i,r,n){if(!i)return"sort"===r||"type"===r?0:i;var s=e.moment(i,a,o,!0);return s.format("sort"===r||"type"===r?"x":t)}}}),$(function(){painel(g_fila_usuario),$("#slctFila").val(g_fila_usuario),triagem(),painelEncerrados();const a=window.location.search,e=new URLSearchParams(a),t=e.get("v");"triagem"==t&&$("#triagem-tab").tab("show"),"encerrados"==t&&$("#encerrados-tab").tab("show"),$("#tblEventos thead tr").clone(!0).appendTo("#tblEventos thead"),$("#tblEventos thead tr:eq(1) th").each(function(a){var e=$(this).text();$(this).html('<input type="text" placeholder="Procurar '+e+'" />'),$("input",this).on("keyup change",function(){$("#tblEventos").DataTable().column(a).search()!==this.value&&$("#tblEventos").DataTable().column(a).search(this.value).draw()})})});var table_painel=null;$("#tblPainel").on("click","tbody tr",function(){var a=table_painel.row($(this)).data();document.location.href=base_url+"chamado/"+a[0]}),setInterval(function(){$("#tblPainel").DataTable().ajax.reload(null,!1)},3e4);var table_encerrados=null;let xhr;$("#tblEncerrados").on("click","tbody tr",function(){var a=table_encerrados.row($(this)).data();window.open(base_url+"chamado/"+a[0])}),table_triagem=null,$("#tblTriagem").on("click","tbody td",function(){var a=table_triagem.row($(this)).data();document.location.href=base_url+"triagem/"+a[0]}),$("#modalRegistro").on("show.bs.modal",function(a){var e=$(a.relatedTarget),t=e.data("chamado"),o=$(this);o.find(".modal-body #conteudo_form").empty(),o.find(".modal-body #conteudo_form").prepend(criaFormRegistro(t,fila_atual))}),$("#modalRegistro").on("shown.bs.modal",function(a){$("#btnRegistrarInteracao").removeAttr("disabled"),$("textarea[name=txtInteracao]").summernote({toolbar:[["style",["bold","italic","underline","clear"]],["font",["strikethrough","superscript","subscript"]],["fontsize",["fontsize"]],["color",["color"]],["para",["ul","ol","paragraph"]],["height",["height"]],["insert",["link","picture"]]],height:200,lang:"pt-BR",dialogsInBody:!0,disableDragAndDrop:!1}),$("#slctTipo").append('<option value="ATENDIMENTO" selected>Atendimento</option><option value="OBSERVACAO">Observação</option><option value="ALT_FILA">Alteração de fila</option>'),$("#slctTipo").append('<option value="ESPERA">Deixar em espera</option>'),$("#slctTipo").append('<option value="REM_ESPERA">Remover da espera</option>'),$("#slctTipo").append('<option value="INSERVIVEL">Classificar como inservível</option>'),verificaTipo(fila_atual,g_id_chamado)}),$("#modalRegistro").on("hide.bs.modal",function(a){$("div[role=alert]").remove()}),$("#modalRegistroEntrega").on("hide.bs.modal",function(a){$(this).find("#btnRegistrarEntrega").hide()}),$("#modalRegistroEntrega").on("show.bs.modal",function(a){var e=$(a.relatedTarget),t=e.data("chamado");$(this).find(".modal-body form #conteudo_form_entrega").html('<label>A entrega foi realizada? </label><br><div class="custom-control custom-radio custom-control-inline"><input onchange="verificaEntrega()" type="radio" value="1" id="rdSim" name="confirmaEntrega" class="custom-control-input"><label class="custom-control-label" for="rdSim">Sim</label></div><div class="custom-control custom-radio custom-control-inline"><input onchange="verificaEntrega()" type="radio" value="0" id="rdNao" name="confirmaEntrega" class="custom-control-input"><label class="custom-control-label" for="rdNao">Não</label></div><div id="divErroEntrega" style="display: none"><div class="form-group"><label for="txtFalhaEntrega"><b>Selecione o motivo:</b></label><select class="form-control" id="slcErroEntrega" onchange="verificaEntrega()"><option value="1">Verificado defeito na instalação</option><option value="2">Responsável no local ausente</option></select></div></div><div id="divFalhaEntrega" style="display: none"><div class="form-group"><label for="txtFalhaEntrega"><b>Detalhes:</b></label><textarea class="form-control" id="txtFalhaEntrega" rows="3"></textarea></div></div><div id="divEntrega" style="display: none"><div class="form-group"><label for="termo"><strong>Termo de entrega assinado</strong></label><input type="file" class="form-control-file" name="termo_entrega" accept=".pdf"></div><div class="form-group"><label for="termo"><strong>Termo de responsabilidade assinado <small>(se houver)</small></strong></label><input type="file" class="form-control-file" name="termo_responsabilidade" accept=".pdf"></div><div class="form-group"><label for="nome_recebedor"><strong>Nome do recebedor</strong></label><input type="text" class="form-control" name="nome_recebedor"></div></div><input type="hidden" name="id_chamado" value="'+t+'" />')}),$("input[name=nome_solicitante]").autoComplete({source:function(a,e){try{xhr.abort()}catch(a){}xhr=$.getJSON(base_url+"json/solicitantes",{q:a},function(a){e(a)})},minChars:2,autoFocus:!0}),$("input[name=nome_local]").autoComplete({source:function(a,e){try{xhr.abort()}catch(a){}xhr=$.getJSON(base_url+"json/locais",{q:a},function(a){e(a)})},minChars:2});var tblEquipsChamado=null;$("#tblAnexosChamado").jsGrid({width:"100%",autoload:!0,editing:!1,inserting:!1,noDataContent:"Sem anexos.",deleteConfirm:"Tem certeza?",fields:[{name:"id_anexo_otrs",title:"ID",type:"text",visible:!1},{name:"nome_arquivo_otrs",title:"Nome do arquivo",type:"text"}],controller:{loadData:function(){return $.ajax({url:base_url+"json/anexos_chamado",dataType:"json",method:"post",data:{id_chamado:g_id_chamado}})}},rowClick:function(a){window.open(base_url+"anexo_otrs/"+a.item.id_anexo_otrs)}});var item_antigo=null,entrega=null,botoes="",p_id_responsavel=null,status_chamado=null;$("#frmInteracao").on("submit",function(a){a.preventDefault();var e=base_url+"chamado/registrar_interacao",t=$("textarea[name=txtInteracao]").summernote("code"),o=$("input[name=id_chamado]").val(),i=$("input[name=id_fila_ant]").val(),r=$("select[name=tipo]").val(),n=$("select[name=id_fila]").val(),s=[];return $("input[class=chkPatri]").each(function(){$(this).is(":checked")&&s.push($(this).val())}),$.ajax({url:e,type:"POST",data:{txtInteracao:t,id_chamado:o,tipo:r,id_fila:n,id_fila_ant:i,equipamentos_atendidos:s,id_usuario:g_id_usuario},beforeSend:function(){return 0==s.length&&3==i&&"INSERVIVEL"==r||0==s.length&&("REM_ESPERA"==r||"ESPERA"==r)?($("#modalRegistro .modal-body").prepend('<div class="alert alert-warning fade show" role="alert">Selecione os equipamentos!<button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button></div>'),!1):$("textarea[name=txtInteracao]").summernote("isEmpty")?($("#modalRegistro .modal-body").prepend('<div class="alert alert-warning fade show" role="alert">O texto não pode ficar em branco!<button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button></div>'),!1):void $("#btnRegistrarInteracao").prop("disabled","true")},success:function(a){$("#btnRegistrarInteracao").removeAttr("disabled"),atualizaInteracoes(o),$("textarea[name=txtInteracao]").summernote("reset"),$("#modalRegistro").modal("hide"),carregaChamado(o),tblEquipsChamado.loadData(),s=[,]},error:function(a,e,t){alert(a+t),$("#btnRegistrarInteracao").removeAttr("disabled")}}),!1}),$("#frmRegistroEntrega").on("submit",function(a){a.preventDefault();var e=new FormData($(this)[0]),t=$("input[name=confirmaEntrega]:checked").val(),o=$("#slcErroEntrega").val(),i=$("input[name=id_chamado]").val();e.append("opcao_entrega",t),e.append("id_chamado",i),e.append("erro_entrega",o),""!==$('input[name="termo_responsabilidade"]').val()?e.append("termo_resp",1):e.append("termo_resp",0),$.ajax({url:base_url+"interacao/registrar_entrega",type:"POST",data:e,processData:!1,contentType:!1,beforeSend:function(){if(1==t){if(""==$("input[name=termo]").val())return $("#divEntrega").prepend('<div class="alert alert-warning fade show" role="alert">Está faltando o termo!<button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button></div>'),$("input[name=termo]").focus(),!1;if(""==$("input[name=nome_recebedor]").val())return $("#divEntrega").prepend('<div class="alert alert-warning fade show" role="alert">Informe o nome do recebedor!<button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button></div>'),$("input[name=nome_recebedor]").focus(),!1}else if($("#txtFalhaEntrega").summernote("isEmpty"))return $("#divFalhaEntrega").prepend('<div class="alert alert-warning fade show" role="alert">Descreva os detalhes.<button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button></div>'),!1;$("#btnRegistrarEntrega").prop("disabled","true")},success:function(a){""===a?(atualizaInteracoes(i),$("#modalRegistroEntrega").modal("hide"),carregaChamado(i),$("#btnRegistrarEntrega").removeAttr("disabled")):($("#divEntrega").prepend('<div class="alert alert-warning fade show" role="alert"><button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>'+a+"</div>"),$("#btnRegistrarEntrega").removeAttr("disabled"))},error:function(a){alert(a),$("#btnRegistrarEntrega").removeAttr("disabled")}})});var bloqueado=!1;$("#btnBloquearChamado").on("click",function(a){a.preventDefault(),$.ajax({type:"POST",url:base_url+"json/atualiza_responsavel",data:{id_chamado:g_id_chamado,id_usuario:g_id_usuario,tipo:"b"},beforeSend:function(){$("#btnBloquearChamado").prop("disabled","true")},success:function(a){""===a?($("#btnDesbloquearChamado").removeAttr("disabled"),carregaChamado(g_id_chamado,!0)):(alert("Chamado bloqueado por "+a),carregaChamado(g_id_chamado,!0))}})}),$("#btnDesbloquearChamado").on("click",function(a){a.preventDefault(),$.ajax({type:"POST",url:base_url+"json/atualiza_responsavel",data:{id_chamado:g_id_chamado,id_usuario:g_id_usuario,tipo:"d",auto_usuario:g_auto_usuario},beforeSend:function(){$("#btnDesbloquearChamado").prop("disabled","true")},success:function(){$("#btnBloquearChamado").removeAttr("disabled"),carregaChamado(g_id_chamado,!0)},error:function(){$("#btnDesbloquearChamado").removeAttr("disabled"),alert("Operação não permitida!"),carregaChamado(g_id_chamado,!0)}})}),$("#btnEditarChamado").on("click",function(a){a.preventDefault(),$("#btnBloquearChamado").hide(),$("#btnDesbloquearChamado").hide(),$("#btnEditarChamado").hide(),$.ajax({url:base_url+"json/chamado",dataType:"json",data:{id_chamado:g_id_chamado},success:function(a){g_auto_usuario>=3&&($("#frmEditarChamado select[name=id_responsavel]").removeAttr("disabled"),$("#frmEditarChamado select[name=id_responsavel]").html(""),$.ajax({url:base_url+"json/usuarios",dataType:"json",type:"post",success:function(a){$("#frmEditarChamado select[name=id_responsavel]").append("<option></option>"),a.forEach(function(a){$("#frmEditarChamado select[name=id_responsavel]").append('<option value="'+a.id_usuario+'">'+a.nome_usuario+"</option>")})}})),a.id_responsavel==g_id_usuario||g_auto_usuario>=3?($("#frmEditarChamado input[name=nome_solicitante]").removeAttr("disabled"),$("#frmEditarChamado input[name=telefone]").removeAttr("disabled"),$("#frmEditarChamado input[name=nome_local]").removeAttr("disabled"),$("#frmEditarChamado button[type=submit]").removeAttr("hidden"),$("#frmEditarChamado button[type=submit]").removeAttr("disabled"),$("#frmEditarChamado #btnCancelarEdicao").removeAttr("hidden"),$("#btnDesbloquearChamado").removeAttr("disabled")):(alert("Chamado bloqueado!"),$("#btnEditarChamado").show())}})}),$("#btnCancelarEdicao").on("click",function(a){carregaChamado(g_id_chamado,!0),a.preventDefault(),$("#frmEditarChamado input[name=nome_solicitante]").prop("disabled","true"),$("#frmEditarChamado input[name=telefone]").prop("disabled","true"),$("#frmEditarChamado input[name=nome_local]").prop("disabled","true"),$("#frmEditarChamado button[type=submit]").prop("hidden","true"),$("#frmEditarChamado select[name=id_responsavel]").attr("disabled","true"),$("#frmEditarChamado #btnEditarChamado").show(),$(this).prop("hidden","true")}),$("#frmEditarChamado").on("submit",function(a){a.preventDefault()}).validate({rules:{nome_solicitante:"required",nome_local:"required",telefone:{required:!0,digits:!0,minlength:3}},messages:{nome_solicitante:"Campo obrigatório!",nome_local:"Campo obrigatório!",telefone:{required:"Campo obrigatório!",digits:"Somente dígitos (0-9)!",minlength:"Mínimo 3 dígitos!"}},submitHandler:function(a){var e=base_url+"chamado/alterar_chamado",t=new FormData(a);$.ajax({url:e,type:"POST",data:t,contentType:!1,cache:!1,processData:!1,beforeSend:function(){var a=!1;if($("#frmEditarChamado input[type=submit]").prop("disabled","true"),$.ajax({url:base_url+"json/chamado",dataType:"json",data:{id_chamado:g_id_chamado},success:function(e){(e.status_chamado="FECHADO")&&(a=!0)}}),a)return alert("Operação não permitida: chamado fechado!"),!1},success:function(a){carregaChamado(g_id_chamado,!0),atualizaInteracoes(g_id_chamado),$("#frmEditarChamado #alerta").prepend(a),setTimeout(function(){$("#msg_sucesso").alert("close")
},2500),$("#frmEditarChamado input[name=nome_solicitante]").prop("disabled","true"),$("#frmEditarChamado select[name=id_responsavel]").prop("disabled","true"),$("#frmEditarChamado input[name=telefone]").prop("disabled","true"),$("#frmEditarChamado input[name=nome_local]").prop("disabled","true"),$("#frmEditarChamado button[type=submit]").prop("hidden","true"),$("#frmEditarChamado #btnEditarChamado").show(),$("#frmEditarChamado #btnCancelarEdicao").prop("hidden","true")},error:function(a,e,t){alert(t)}})}});var autorizacoes=[{Name:"Técnico",Id:"2"},{Name:"Administrador",Id:"3"},{Name:"Master",Id:"4"}],estados=[{Name:"ATIVO",Id:"ATIVO"},{Name:"INATIVO",Id:"INATIVO"}],opcoes_fila=[{Name:"SIM",Id:"1"},{Name:"NÃO",Id:"0"}],filas=[{id_fila:"0",nome_fila:"Todos"}];$.ajax({url:base_url+"json/filas",dataType:"json",complete:a=>{Array.prototype.push.apply(filas,a.responseJSON),$("#usuarios-grid").jsGrid({fields:[{name:"nome_usuario",type:"text",validate:"required",title:"Nome"},{name:"login_usuario",type:"text",validate:"required",title:"Login"},{name:"data_usuario",type:"text",readOnly:!0,title:"Data de criação"},{name:"status_usuario",type:"select",items:estados,textField:"Name",valueField:"Id",title:"Situação"},{name:"autorizacao_usuario",type:"select",items:autorizacoes,textField:"Name",valueField:"Id",title:"Autorização"},{name:"fila_usuario",type:"select",items:filas,textField:"nome_fila",valueField:"id_fila",title:"Fila preferencial"},{name:"alteracao_usuario",type:"text",readOnly:!0,title:"Última alteração"},{type:"control",deleteButton:!1}]})}}),$("#usuarios-grid").jsGrid({width:"100%",height:"auto",autoload:!0,inserting:!0,editing:!0,sorting:!0,paging:!0,filtering:!1,loadMessage:"Carregando...",noDataContent:"(vazio)",controller:{loadData:function(){return $.ajax({url:base_url+"usuario/listar_usuarios",dataType:"json"})},updateItem:function(a){return $.ajax({type:"POST",url:base_url+"usuario/atualizar_usuario",data:a,dataType:"json"})},insertItem:function(a){return $.ajax({type:"POST",url:base_url+"usuario/inserir_usuario",data:a,dataType:"json"})}},fields:[{name:"nome_usuario",type:"text",validate:"required",title:"Nome"},{name:"login_usuario",type:"text",validate:"required",title:"Login"},{name:"data_usuario",type:"text",readOnly:!0,title:"Data de criação"},{name:"status_usuario",type:"select",items:estados,textField:"Name",valueField:"Id",title:"Situação"},{name:"autorizacao_usuario",type:"select",items:autorizacoes,textField:"Name",valueField:"Id",title:"Autorização"},{name:"alteracao_usuario",type:"text",readOnly:!0,title:"Última alteração"},{type:"control",deleteButton:!1}]}),$("#filas-grid").jsGrid({width:"100%",height:"auto",autoload:!0,inserting:!1,editing:!1,sorting:!0,paging:!0,filtering:!1,loadMessage:"Carregando...",noDataContent:"(vazio)",controller:{loadData:function(){return $.ajax({url:base_url+"admin/listar_filas/1",dataType:"json"})},updateItem:function(a){return $.ajax({type:"POST",url:base_url+"admin/atualizar_fila",data:a,dataType:"json"})},insertItem:function(a){return $.ajax({type:"POST",url:base_url+"admin/inserir_fila",data:a,dataType:"json"})}},fields:[{name:"nome_fila",type:"text",validate:"required",title:"Nome"},{name:"status_fila",type:"select",items:estados,textField:"Name",valueField:"Id",title:"Situação"}]}),$("#filas-avulsas-grid").jsGrid({width:"100%",height:"auto",autoload:!0,inserting:!0,editing:!0,sorting:!0,paging:!0,filtering:!1,loadMessage:"Carregando...",noDataContent:"(vazio)",controller:{loadData:function(){return $.ajax({url:base_url+"admin/listar_filas/0",dataType:"json"})},updateItem:function(a){return $.ajax({type:"POST",url:base_url+"admin/atualizar_fila",data:a,dataType:"json"})},insertItem:function(a){return $.ajax({type:"POST",url:base_url+"admin/inserir_fila",data:a,dataType:"json"})}},fields:[{name:"nome_fila",type:"text",validate:"required",title:"Nome"},{name:"status_fila",type:"select",items:estados,textField:"Name",valueField:"Id",title:"Situação"},{type:"control",deleteButton:!1}]}),$("#tblEventos").DataTable({autoWidth:!0,columnDefs:[{width:"10%",targets:3,render:$.fn.dataTable.render.moment("YYYY-MM-DD HH:mm:ss","DD/MM/YYYY H:mm:ss")},{width:"10%",targets:0},{width:"40%",targets:2}],orderCellsTop:!1,fixedHeader:!0,language:{decimal:"",emptyTable:"(vazio)",info:"Mostrando _START_ a _END_ de _TOTAL_ eventos",infoEmpty:"Mostrando 0 a 0 de 0 eventos",infoFiltered:"(filtrado de _MAX_ eventos)",infoPostFix:"",thousands:".",lengthMenu:"Mostrando _MENU_ eventos",loadingRecords:"Carregando...",processing:"Processando...",search:"Busca:",zeroRecords:"Sem resultados!",paginate:{first:"Primeiro",last:"Último",next:"Próximo",previous:"Anterior"}},ajax:base_url+"admin/listar_eventos/",order:[[0,"desc"]]}),setInterval(function(){$("#tblEventos").DataTable().ajax.reload(null,!1)},15e3),UTF8={encode:function(a){for(var e,t=-1,o=(a=a.split("")).length,i=String.fromCharCode;++t<o;a[t]=(e=a[t].charCodeAt(0))>=127?i(192|e>>>6)+i(128|63&e):a[t]);return a.join("")},decode:function(a){for(var e,t,o=-1,i=(a=a.split("")).length,r=String.fromCharCode,n="charCodeAt";++o<i;128&(e=a[o][n](0))&&(a[o]=192==(252&e)&&128==(192&(t=a[o+1][n](0)))?r(((3&e)<<6)+(63&t)):r(128),a[++o]=""));return a.join("")}},$("#tblAnexos").jsGrid({width:"100%",autoload:!1,editing:!1,inserting:!1,noDataContent:"Sem anexos.",deleteConfirm:"Tem certeza?",fields:[{name:"id_anexo_otrs",title:"ID",type:"text",visible:!1},{name:"nome_arquivo_otrs",title:"Nome do arquivo",type:"text"},{type:"control",deleteButton:!0,editButton:!1}],rowClick:function(a){window.open(base_url+"anexo_otrs/"+a.item.id_anexo_otrs,"_blank ")}});var agrupamento=!1,diffDesc=null,g_equips=[];$("#tblEquips").jsGrid({width:"100%",autoload:!1,editing:!0,inserting:!0,confirmDeleting:!1,noDataContent:"Sem equipamentos.",fields:[{name:"Número",type:"text",width:50,validate:"required"},{name:"Descrição",type:"text",width:50,validate:"required"},{type:"control",deleteButton:!0}]});var ocorrencias=[],confirmado=!1;$("#btnValidaEquip").on("click",async function(){confirmado=!!agrupamento,$(this).prop("disabled","true"),$("#pbEquips").css("width","0%");var a=$("#tblEquips").jsGrid("option","data");g_equips=[];var e=[];if(ocorrencias=[],percentage=100/a.length,total_percentage=0,a.length>0){for(i=0;i<a.length;i++){if(""==a[i].Número&&""==a[i].Descrição)e.push("Existem itens vazios na lista!\n");else{if(""==a[i].Número)e.push("O item "+a[i].Descrição+" está sem número!\n");else{var t=await verificaStatusEquip(a[i].Número);null!==t&&"ATENDIDO"!==t.status_equipamento_chamado&&ocorrencias.push({"Número":a[i].Número,Status:t.status_equipamento_chamado,ID:t.id_chamado,Ticket:t.ticket_chamado})}var o=await verificaDescEquip(a[i].Número);null!==o.descricao&&(a[i].Descrição=o.descricao),null===a[i].Descrição&&e.push("O item "+a[i].Número+" está sem descrição!\n")}total_percentage+=percentage,$("#pbEquips").css("width",total_percentage+"%")}0==e.length&&0==g_equips.length&&0==agrupamento?($("#tblEquips").jsGrid("option","data",a),ocorrencias.length>0?($("#modalOcorrencias").modal("show"),$(this).removeAttr("disabled")):(confirmado=!0,g_equips=a,$(this).html('<i class="fa fa-check"></i> Confirmado!'),$("#tblEquips").jsGrid("fieldOption",2,"visible",!1),$("#tblEquips").jsGrid("option","editing",!1),$("#tblEquips").jsGrid("option","inserting",!1),$(this).prop("disabled","true"),$("#btnAlteraEquip").removeAttr("disabled"),$("#btnLoteEquip").prop("disabled","true"))):(alert(e),$(this).removeAttr("disabled"))}else 0==agrupamento?(alert("A lista está vazia!"),$(this).removeAttr("disabled")):($(this).html('<i class="fa fa-check"></i> Confirmado!'),$("#btnAlteraEquip").removeAttr("disabled"),$("#btnLoteEquip").prop("disabled","true"))}),$("#modalOcorrencias").on("hidden.bs.modal",function(a){$("#tblOcorrencias").jsGrid("option","data",[])}),$("#modalOcorrencias").on("shown.bs.modal",function(a){$("#tblOcorrencias").jsGrid({width:"100%",autoload:!1,editing:!1,inserting:!1,data:ocorrencias,fields:[{name:"Número",type:"text",width:50,validate:"required"},{name:"Status",type:"text",width:20,validate:"required"},{name:"ID",type:"text",width:30,validate:"required"},{name:"Ticket",type:"text",width:50,validate:"required"}],rowClick:function(a){window.open(base_url+"/chamado/"+a.item.ID,"_blank ")}})}),$("#btnAlteraEquip").on("click",function(){confirmado=!1,g_equips=[],$("#btnValidaEquip").html('<i class="fa fa-check"></i> Confirmar!'),$("#tblEquips").jsGrid("fieldOption",2,"visible",!0),$("#tblEquips").jsGrid("option","editing",!0),$(this).prop("disabled","true"),$("#btnValidaEquip").removeAttr("disabled"),$("#btnLoteEquip").removeAttr("disabled")}),$("#btnLoteEquip").on("click",function(){confirmado=!1,$("#modalLote").modal("show")}),$("#radLoteFaixa").on("click",function(){$("#divListaLote").hide(),$("#divFaixaLote").show()}),$("#radLoteLista").on("click",function(){$("#divFaixaLote").hide(),$("#divListaLote").show()}),$("#btnInsereLote").on("click",async function(){if($("#radLoteFaixa").is(":checked")){var a=Number($("#txtInicioFaixaLote").val()),e=Number($("#txtFimFaixaLote").val());if(e-a<1||isNaN(e-a))alert("Faixa inválida");else{$(this).prop("disabled","true"),percentage=100/(e-a),total_percentage=0;for(var t=$("#tblEquips").jsGrid("option","data"),o=[],i=a;i<=e;){var r=null,n=await verificaDescEquip(i);null!==n.descricao&&(r=n.descricao),o.push({"Número":i,"Descrição":r}),i++,total_percentage+=percentage,$("#pbLote").css("width",total_percentage+"%")}novo_grid=t.concat(o),$("#tblEquips").jsGrid("option","data",novo_grid),$("#modalLote").removeClass("fade").modal("hide"),$("#modalLote").modal("dispose"),$(this).removeAttr("disabled")}}if($("#radLoteLista").is(":checked")){t=$("#tblEquips").jsGrid("option","data");if(""==$("#txtListaLote").val())return;$(this).prop("disabled","true");var s=$("#txtListaLote").val().split("\n");percentage=100/s.length,total_percentage=0;var d=[];for(i=0;i<s.length;i++){r=null,n=await verificaDescEquip(s[i]);null!==n.descricao&&(r=n.descricao),d.push({"Número":s[i],"Descrição":r}),total_percentage+=percentage,$("#pbLote").css("width",total_percentage+"%")}novo_grid=t.concat(d),$("#tblEquips").jsGrid("option","data",novo_grid),$("#modalLote").removeClass("fade").modal("hide"),$("#modalLote").modal("dispose"),$(this).removeAttr("disabled")}}),$("#modalLote").on("hidden.bs.modal",function(){$("#txtInicioFaixaLote").val(null),$("#txtFimFaixaLote").val(null),$("#btnInsereLote").removeAttr("disabled"),$("#pbLote").css("width","0%")}),$("#frmDevolveChamado").on("submit",function(a){a.preventDefault();var e=$(this).find("#txtDescDevo").val();""!==e&&confirm("Deseja realmente devolver esse ticket? Isso não poderá ser desfeito!")&&$.ajax({url:base_url+"chamado/devolver_chamado",async:!0,method:"post",data:{id_triagem:g_id_triagem,desc_devo:e},beforeSend:function(){$(this).find("submit").prop("disabled","true")},success:function(a){document.location.href=base_url+"painel?v=triagem"}})}),$('input[name="telefone"]').on("keyup keyup keypress blur change",function(){var a=$(this).val();$(this).val(a.replace(/[\.-\s]/g,""))}),$('input[name="resumo_solicitacao"]').on("keyup keyup keypress blur change",function(){var a=$(this).val();$(this).val(a.replace(/[\"\']/g,""))}),$("#tblEquips input").on("keyup keyup keypress blur change",function(){var a=$(this).val();$(this).val(a.replace(/\s/g,""))}),$("#frmImportarChamado").on("submit",function(a){a.preventDefault()}).validate(1==agrupamento?{ignore:"*"}:{rules:{nome_solicitante:"required",nome_local:"required",telefone:{required:!0,digits:!0,minlength:3},descricao:{required:!0,minlength:10,normalizer:function(a){return $.trim(a)}},id_fila:{required:!0},resumo_solicitacao:{required:!0}},messages:{nome_solicitante:"Campo obrigatório!",nome_local:"Campo obrigatório!",telefone:{required:"Campo obrigatório!",digits:"Somente dígitos (0-9)!",minlength:"Mínimo 3 dígitos!"},descricao:{required:"Campo obrigatório!",minlength:"Descrição insuficiente!",maxlength:"Tamanha máximo excedido!"},resumo_solicitacao:{required:"Campo obrigatório!"}},submitHandler:async function(a){var e=base_url+"chamado/importar_chamado",t=new FormData(a);t.append("listaEquipamentos",JSON.stringify(g_equips)),t.append("ticket_triagem",g_ticket_triagem),t.append("email_triagem",g_email_triagem);let o=await fetch(base_url+"triagem/descricao/"+g_id_triagem),i="";return o.ok?i=await o.text():console.log("HTTP-Error: "+o.status),t.append("textoTriagem",i),t.append("g_anexos",JSON.stringify($("#tblAnexos").jsGrid("option","data"))),t.append("id_triagem",g_id_triagem),$.ajax({url:e,type:"POST",data:t,contentType:!1,cache:!1,processData:!1,beforeSend:function(){if(0==confirmado)return alert("Verifique a lista de equipamentos!"),!1;$("#btnImportarChamado").prop("disabled","true")},success:function(a){confirmado=!1,0==a.includes("Local")?($("#divTriagem").html(""),$("#msg div[id=alerta]").remove(),$("#msg").html(a)):($("input[name=nome_local").focus(),$("#listaLocais").popover({content:"Local inválido!",trigger:"focus"}),$("#listaLocais").popover("toggle"),confirmado=!0,$("#btnImportarChamado").removeAttr("disabled")),$("#btnImportarChamado").removeAttr("disabled"),a=null},error:function(a,e,t){$("#msg").prepend('<div id="alerta" class="alert alert-danger alert-dismissible">'),$("#alerta").append('<a href="#" class="close" data-dismiss="alert" aria-label="close">&times;</a>'+t),targetOffset=$("#msg").offset().top,$("html, body").animate({scrollTop:targetOffset-100},200),$("#btnImportarChamado").removeAttr("disabled")}}),!1}});var result_br=[];$("#frmBuscaRapida button").on("click",async function(a){a.preventDefault();var e=$("#txtBuscaRapida").val();e.length>=3&&(await $.ajax({url:base_url+"busca",type:"GET",data:{t:e},success:function(a){result_br=a},error:function(a,e,t){alert(t)}}),$("#modalBuscaRapida").modal("show"))}),$("#modalBuscaRapida").on("show.bs.modal",function(){$(this).find(".modal-body").html(result_br),$(this).find(".modal-title").html('<i class="fas fa-search"></i> Buscando por <em>'+$("#txtBuscaRapida").val()+"</em>")}),$("#modalBuscaRapida").on("shown.bs.modal",function(){$("#tblChamadosBr tbody tr").on("click",function(){window.open(base_url+"chamado/"+$(this).find("td").first().text())}),$("#tblTriagemBr tbody tr").on("click",function(){window.open(base_url+"triagem/"+$(this).find("td").first().text())})}),$("#frmBuscaRapida").on("submit",function(a){a.preventDefault()});